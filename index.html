<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Management System – Land Rig & Contracting</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --sap-blue: #0070F2;
  --sap-blue-dark: #0040B0;
  --sap-blue-light: #EBF4FF;
  --sap-shell: #354A5E;
  --sap-shell-text: #FFFFFF;
  --sap-bg: #F5F6F7;
  --sap-white: #FFFFFF;
  --sap-border: #D9D9D9;
  --sap-text: #32363A;
  --sap-text-muted: #6A6D70;
  --sap-success: #107E3E;
  --sap-warning: #E9730C;
  --sap-error: #B00;
  --sap-info: #0070F2;
  --sap-row-hover: #E8F3FF;
  --sap-selected: #D1E8FF;
  --radius: 4px;
  --shadow: 0 2px 8px rgba(0,0,0,0.12);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.18);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'IBM Plex Sans', sans-serif;
  font-size: 14px;
  color: var(--sap-text);
  background: var(--sap-bg);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ── SHELL BAR ── */
.shell-bar {
  background: var(--sap-shell);
  color: var(--sap-shell-text);
  height: 44px;
  display: flex;
  align-items: center;
  padding: 0 16px;
  gap: 12px;
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}
.shell-logo {
  font-weight: 700;
  font-size: 16px;
  letter-spacing: -0.5px;
  color: #fff;
  margin-right: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.shell-logo span.sap { color: #7CC0FF; }
.shell-divider { width: 1px; height: 22px; background: rgba(255,255,255,0.25); }
.shell-app-title { font-size: 14px; font-weight: 500; opacity: 0.9; }
.shell-spacer { flex: 1; }
.shell-actions { display: flex; align-items: center; gap: 4px; }
.shell-btn {
  background: none;
  border: none;
  color: #fff;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  transition: background 0.15s;
  position: relative;
}
.shell-btn:hover { background: rgba(255,255,255,0.15); }
.badge {
  position: absolute;
  top: 4px; right: 4px;
  width: 16px; height: 16px;
  background: #E9730C;
  border-radius: 50%;
  font-size: 10px;
  font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  border: 2px solid var(--sap-shell);
}
.user-avatar {
  width: 32px; height: 32px;
  border-radius: 50%;
  background: var(--sap-blue);
  display: flex; align-items: center; justify-content: center;
  font-weight: 600; font-size: 13px; cursor: pointer;
  margin-left: 4px;
}

/* ── SECONDARY BAR ── */
.secondary-bar {
  background: #fff;
  border-bottom: 1px solid var(--sap-border);
  padding: 0 16px;
  display: flex;
  align-items: center;
  height: 42px;
  gap: 0;
}
.nav-tab {
  height: 42px;
  padding: 0 16px;
  border: none;
  background: none;
  font-family: inherit;
  font-size: 13.5px;
  color: var(--sap-text-muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
  display: flex; align-items: center; gap: 6px;
  white-space: nowrap;
}
.nav-tab.active { color: var(--sap-blue); border-bottom-color: var(--sap-blue); font-weight: 600; }
.nav-tab:hover:not(.active) { color: var(--sap-text); background: var(--sap-bg); }

/* ── PAGE ── */
.page { display: flex; flex-direction: column; flex: 1; }

/* ── SECTION ── */
.section { display: none; flex: 1; }
.section.active { display: flex; flex-direction: column; }

/* ── CONTENT AREA ── */
.content {
  flex: 1;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  overflow: auto;
}

/* ── CARD ── */
.card {
  background: #fff;
  border: 1px solid var(--sap-border);
  border-radius: var(--radius);
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}
.card-header {
  padding: 10px 16px;
  border-bottom: 1px solid var(--sap-border);
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
.card-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--sap-text);
  flex: 1;
}
.record-count { font-size: 12px; color: var(--sap-text-muted); font-weight: 400; }

/* ── TOOLBAR ── */
.toolbar {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  padding: 10px 16px;
  border-bottom: 1px solid var(--sap-border);
  background: #FAFBFC;
}
.toolbar-group { display: flex; align-items: center; gap: 6px; }
.toolbar-spacer { flex: 1; }

/* ── BUTTONS ── */
.btn {
  height: 32px;
  padding: 0 14px;
  border-radius: var(--radius);
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border: 1px solid transparent;
  transition: all 0.15s;
  white-space: nowrap;
}
.btn-primary { background: var(--sap-blue); color: #fff; border-color: var(--sap-blue); }
.btn-primary:hover { background: var(--sap-blue-dark); border-color: var(--sap-blue-dark); }
.btn-secondary { background: #fff; color: var(--sap-text); border-color: var(--sap-border); }
.btn-secondary:hover { background: var(--sap-bg); border-color: #aaa; }
.btn-ghost { background: none; color: var(--sap-blue); border-color: transparent; }
.btn-ghost:hover { background: var(--sap-blue-light); }
.btn-danger { background: #fff; color: var(--sap-error); border-color: var(--sap-error); }
.btn-danger:hover { background: #FFF0F0; }
.btn-icon { width: 32px; height: 32px; padding: 0; justify-content: center; }
.btn-success { background: var(--sap-success); color: #fff; border-color: var(--sap-success); }
.btn-warning { background: var(--sap-warning); color: #fff; border-color: var(--sap-warning); }

/* ── SEARCH / FILTER BAR ── */
.filter-bar {
  padding: 10px 16px;
  background: #FAFBFC;
  border-bottom: 1px solid var(--sap-border);
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: flex-end;
}
.filter-group { display: flex; flex-direction: column; gap: 3px; }
.filter-label { font-size: 11px; color: var(--sap-text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.4px; }
.filter-input, .filter-select {
  height: 32px;
  padding: 0 10px;
  border: 1px solid var(--sap-border);
  border-radius: var(--radius);
  font-family: inherit;
  font-size: 13px;
  color: var(--sap-text);
  background: #fff;
  outline: none;
  transition: border 0.15s;
  min-width: 140px;
}
.filter-input:focus, .filter-select:focus { border-color: var(--sap-blue); box-shadow: 0 0 0 2px rgba(0,112,242,0.15); }
.search-wrap { position: relative; }
.search-wrap .filter-input { padding-left: 32px; min-width: 220px; }
.search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--sap-text-muted); font-size: 13px; }

/* ── TABLE ── */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
thead { position: sticky; top: 0; z-index: 5; }
th {
  background: #F0F2F4;
  border-bottom: 2px solid var(--sap-border);
  padding: 8px 12px;
  text-align: left;
  font-size: 12px;
  font-weight: 600;
  color: var(--sap-text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  user-select: none;
  cursor: pointer;
}
th:hover { background: #E4E7EA; }
th .sort-icon { margin-left: 4px; opacity: 0.4; }
th.sorted .sort-icon { opacity: 1; color: var(--sap-blue); }
td {
  padding: 9px 12px;
  border-bottom: 1px solid #ECEEF0;
  font-size: 13px;
  vertical-align: middle;
}
tr:hover td { background: var(--sap-row-hover); }
tr.selected td { background: var(--sap-selected); }
.checkbox-cell { width: 40px; text-align: center; }
input[type="checkbox"] { width: 15px; height: 15px; cursor: pointer; accent-color: var(--sap-blue); }

/* ── STATUS BADGES ── */
.status-badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 11.5px;
  font-weight: 600;
}
.s-active { background: #E8F5EC; color: #107E3E; }
.s-inactive { background: #F5F5F5; color: #6A6D70; }
.s-maintenance { background: #FFF3E0; color: #E9730C; }
.s-retired { background: #FDECEA; color: #B00; }
.s-contracted { background: #EBF4FF; color: #0070F2; }




/* ── RIG SELECTOR PANEL ── */
.rig-selector {
  display: flex;
  gap: 8px;
  padding: 12px 16px;
  background: #fff;
  border-bottom: 1px solid var(--sap-border);
  flex-wrap: nowrap;
  overflow-x: auto;
  scrollbar-width: thin;
  scrollbar-color: #ccc transparent;
  flex-shrink: 0;
}
.rig-selector::-webkit-scrollbar { height: 4px; }
.rig-selector::-webkit-scrollbar-thumb { background:#ccc;border-radius:4px; }

.rig-pill {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-width: 80px;
  padding: 8px 12px;
  border-radius: 6px;
  border: 2px solid var(--sap-border);
  background: #F8F9FA;
  cursor: pointer;
  transition: all .15s;
  flex-shrink: 0;
  gap: 2px;
  position: relative;
}
.rig-pill:hover { border-color: var(--sap-blue); background: var(--sap-blue-light); }
.rig-pill.active { border-color: var(--sap-blue); background: var(--sap-blue); color: #fff; }
.rig-pill.active .rig-pill-name { color: #fff; }
.rig-pill.active .rig-pill-count { color: rgba(255,255,255,.8); }
.rig-pill.has-alert { border-color: #B00; }
.rig-pill.has-alert .rig-pill-name { color: #B00; }
.rig-pill.active.has-alert { background: #B00; border-color: #B00; }
.rig-pill-name { font-size: 12px; font-weight: 700; color: var(--sap-text); white-space: nowrap; }
.rig-pill-count { font-size: 10px; color: var(--sap-text-muted); white-space: nowrap; }
.rig-pill-all { min-width: 60px; }
.rig-alert-dot {
  position: absolute;
  top: -4px; right: -4px;
  width: 14px; height: 14px;
  background: #B00;
  color: #fff;
  border-radius: 50%;
  font-size: 9px;
  font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  border: 2px solid #fff;
}
.rig-status-dot {
  width: 6px; height: 6px; border-radius: 50%; display: inline-block;
  margin-right: 4px;
}

/* ── MAINTENANCE MODULE ── */
.m-overdue   { background:#FDECEA;color:#B00;border-radius:12px;padding:2px 10px;font-size:11px;font-weight:700;display:inline-flex;align-items:center;gap:5px }
.m-soon      { background:#FFF3E0;color:#C65A00;border-radius:12px;padding:2px 10px;font-size:11px;font-weight:700;display:inline-flex;align-items:center;gap:5px }
.m-scheduled { background:#EBF4FF;color:#0040B0;border-radius:12px;padding:2px 10px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:5px }
.m-completed { background:#E4F5EC;color:#065F46;border-radius:12px;padding:2px 10px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:5px }
.m-inprog    { background:#FFF9E0;color:#7A5C00;border-radius:12px;padding:2px 10px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:5px }
.m-cancelled { background:#F5F5F5;color:#6A6D70;border-radius:12px;padding:2px 10px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:5px }
.days-overdue{ color:#B00;font-weight:700;font-size:12px }
.days-soon   { color:#C65A00;font-weight:700;font-size:12px }
.days-ok     { color:var(--sap-text-muted);font-size:12px }
.days-done   { color:var(--sap-success);font-size:12px }
.maint-alert-row { display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:6px;font-size:13px;margin-bottom:4px }
.maint-alert-overdue { background:#FFF0F0;border:1px solid #FFBDBD;border-left:4px solid #B00 }
.maint-alert-soon    { background:#FFF8F0;border:1px solid #FFCC99;border-left:4px solid #E9730C }
.maint-log-card { padding:14px 16px;border-bottom:1px solid var(--sap-border);display:flex;gap:12px }
.maint-log-dot { width:32px;height:32px;background:var(--sap-blue-light);color:var(--sap-blue);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0 }

/* ── TRANSFER STYLES ── */
.tr-status-pending   { background:#FFF3E0;color:#E65100;border-radius:12px;padding:2px 10px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:4px }
.tr-status-ops       { background:#F0E8FF;color:#6D28D9;border-radius:12px;padding:2px 10px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:4px }
.tr-status-done      { background:#E4F5EC;color:#065F46;border-radius:12px;padding:2px 10px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:4px }
.tr-status-rejected  { background:#FDECEA;color:#B00;border-radius:12px;padding:2px 10px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:4px }
.tr-status-hold      { background:#F5F5F5;color:#6A6D70;border-radius:12px;padding:2px 10px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:4px }
.priority-critical { color:#B00;font-weight:700 }
.priority-high     { color:#E65100;font-weight:600 }
.priority-normal   { color:var(--sap-text-muted) }
.priority-low      { color:#aaa }
.timeline-step { display:flex;gap:12px;padding-bottom:16px;position:relative }
.timeline-step:not(:last-child)::after { content:'';position:absolute;left:15px;top:30px;width:2px;bottom:0;background:var(--sap-border) }
.tl-dot { width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;z-index:1 }
.tl-dot.done   { background:#E4F5EC;color:#065F46 }
.tl-dot.active { background:#EBF4FF;color:var(--sap-blue);border:2px solid var(--sap-blue) }
.tl-dot.pending{ background:#F5F5F5;color:#ccc;border:2px dashed #ccc }
.tl-dot.reject { background:#FDECEA;color:#B00 }
.tl-label { font-size:13px;font-weight:600;margin-top:4px }
.tl-sub   { font-size:11.5px;color:var(--sap-text-muted);margin-top:2px }
.tl-comment { font-size:12px;font-style:italic;color:var(--sap-text-muted);margin-top:4px;background:#F8F9FA;padding:6px 10px;border-radius:4px;border-left:3px solid var(--sap-border) }

/* ── NOTIFICATION PANEL ── */
.notif-panel {
  position: fixed;
  top: 44px; right: 0;
  width: 360px;
  background: #fff;
  border-left: 1px solid var(--sap-border);
  border-bottom: 1px solid var(--sap-border);
  box-shadow: var(--shadow-lg);
  z-index: 900;
  display: none;
  flex-direction: column;
  max-height: calc(100vh - 44px);
}
.notif-panel.open { display: flex; }
.notif-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--sap-border);
  display: flex; align-items: center; gap: 8px;
}
.notif-header h3 { font-size: 15px; font-weight: 600; flex: 1; }
.notif-list { overflow-y: auto; flex: 1; }
.notif-item {
  padding: 12px 16px;
  border-bottom: 1px solid #F0F2F4;
  display: flex;
  gap: 10px;
  cursor: pointer;
  transition: background 0.12s;
}
.notif-item:hover { background: var(--sap-bg); }
.notif-item.unread { border-left: 3px solid var(--sap-blue); }
.notif-icon-wrap {
  width: 36px; height: 36px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; flex-shrink: 0;
}
.ni-blue { background: var(--sap-blue-light); color: var(--sap-blue); }
.ni-orange { background: #FFF3E0; color: var(--sap-warning); }
.ni-green { background: #E8F5EC; color: var(--sap-success); }
.ni-red { background: #FDECEA; color: var(--sap-error); }
.notif-body { flex: 1; }
.notif-title { font-size: 13px; font-weight: 600; }
.notif-desc { font-size: 12px; color: var(--sap-text-muted); margin-top: 2px; }
.notif-time { font-size: 11px; color: #aaa; margin-top: 4px; }

/* ── EMAIL MODAL ── */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 2000;
  display: flex; align-items: center; justify-content: center;
  display: none;
}
.modal-overlay.open { display: flex; }
.modal {
  background: #fff;
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  width: 580px;
  max-width: 95vw;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  animation: slideDown 0.2s ease;
}
@keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.modal-header {
  padding: 14px 18px;
  border-bottom: 1px solid var(--sap-border);
  display: flex; align-items: center; gap: 10px;
}
.modal-header h2 { font-size: 16px; font-weight: 600; flex: 1; }
.modal-body { padding: 18px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 14px; }
.modal-footer {
  padding: 12px 18px;
  border-top: 1px solid var(--sap-border);
  display: flex; justify-content: flex-end; gap: 8px;
}
.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-label { font-size: 12px; font-weight: 600; color: var(--sap-text-muted); text-transform: uppercase; letter-spacing: 0.4px; }
.form-input, .form-select, .form-textarea {
  border: 1px solid var(--sap-border);
  border-radius: var(--radius);
  padding: 7px 10px;
  font-family: inherit;
  font-size: 13.5px;
  color: var(--sap-text);
  background: #fff;
  outline: none;
  transition: border 0.15s;
}
.form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--sap-blue); box-shadow: 0 0 0 2px rgba(0,112,242,0.15); }
.form-textarea { resize: vertical; min-height: 80px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

/* ── ASSET DETAIL POPUP ── */
.asset-popup {
  background: #fff;
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  width: 780px;
  max-width: 95vw;
  max-height: 92vh;
  display: flex;
  flex-direction: column;
  animation: slideDown 0.2s ease;
}
.popup-header {
  background: var(--sap-shell);
  color: #fff;
  padding: 14px 18px;
  border-radius: var(--radius) var(--radius) 0 0;
  display: flex; align-items: flex-start; gap: 12px;
}
.popup-header-icon {
  width: 44px; height: 44px;
  background: rgba(255,255,255,0.15);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; flex-shrink: 0;
}
.popup-header-info { flex: 1; }
.popup-header-title { font-size: 18px; font-weight: 700; }
.popup-header-sub { font-size: 12.5px; opacity: 0.75; margin-top: 2px; }
.popup-tabs {
  display: flex;
  border-bottom: 1px solid var(--sap-border);
  background: #FAFBFC;
}
.popup-tab {
  padding: 10px 18px;
  font-size: 13px;
  font-weight: 500;
  color: var(--sap-text-muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
  white-space: nowrap;
}
.popup-tab.active { color: var(--sap-blue); border-bottom-color: var(--sap-blue); }
.popup-tab:hover:not(.active) { color: var(--sap-text); background: var(--sap-bg); }
.popup-body { padding: 18px; flex: 1; overflow-y: auto; }
.popup-section { display: none; }
.popup-section.active { display: block; }
.detail-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
.detail-field { display: flex; flex-direction: column; gap: 3px; }
.detail-label { font-size: 11px; color: var(--sap-text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.4px; }
.detail-value { font-size: 13.5px; color: var(--sap-text); font-weight: 500; }
.detail-value.mono { font-family: 'IBM Plex Mono', monospace; font-size: 12.5px; }
.section-title { font-size: 13px; font-weight: 700; color: var(--sap-text); text-transform: uppercase; letter-spacing: 0.5px; margin: 18px 0 10px; padding-bottom: 6px; border-bottom: 1px solid var(--sap-border); }
.section-title:first-child { margin-top: 0; }

/* Contract table inside popup */
.mini-table { width: 100%; border-collapse: collapse; font-size: 12.5px; }
.mini-table th { background: #F0F2F4; padding: 7px 10px; text-align: left; font-size: 11px; font-weight: 600; color: var(--sap-text-muted); text-transform: uppercase; letter-spacing: 0.4px; border-bottom: 2px solid var(--sap-border); }
.mini-table td { padding: 7px 10px; border-bottom: 1px solid #ECEEF0; }
.mini-table tr:hover td { background: var(--sap-row-hover); }

/* ── KPI CARDS ── */
.kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
.kpi-card {
  background: #fff;
  border: 1px solid var(--sap-border);
  border-radius: var(--radius);
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  transition: box-shadow 0.15s;
}
.kpi-card:hover { box-shadow: var(--shadow); }
.kpi-label { font-size: 11.5px; color: var(--sap-text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px; }
.kpi-value { font-size: 28px; font-weight: 700; color: var(--sap-text); font-family: 'IBM Plex Mono', monospace; line-height: 1; }
.kpi-sub { font-size: 11.5px; color: var(--sap-text-muted); }
.kpi-icon { font-size: 22px; margin-bottom: 4px; }
.kpi-card.blue .kpi-icon { color: var(--sap-blue); }
.kpi-card.green .kpi-icon { color: var(--sap-success); }
.kpi-card.orange .kpi-icon { color: var(--sap-warning); }
.kpi-card.red .kpi-icon { color: var(--sap-error); }

/* ── TOAST ── */
.toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 8px; }
.toast {
  background: #fff;
  border: 1px solid var(--sap-border);
  border-left: 4px solid var(--sap-blue);
  border-radius: var(--radius);
  padding: 12px 16px;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 280px;
  animation: toastIn 0.25s ease;
  font-size: 13px;
}
.toast.success { border-left-color: var(--sap-success); }
.toast.warning { border-left-color: var(--sap-warning); }
.toast.error { border-left-color: var(--sap-error); }
@keyframes toastIn { from { transform: translateX(40px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* ── USER DROPDOWN ── */
.user-menu {
  position: fixed;
  top: 44px; right: 0;
  width: 220px;
  background: #fff;
  border: 1px solid var(--sap-border);
  border-top: none;
  box-shadow: var(--shadow-lg);
  z-index: 901;
  display: none;
}
.user-menu.open { display: block; }
.user-info { padding: 14px 16px; border-bottom: 1px solid var(--sap-border); }
.user-name { font-weight: 600; font-size: 14px; }
.user-role { font-size: 12px; color: var(--sap-text-muted); }
.user-menu-item { padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px; transition: background 0.12s; }
.user-menu-item:hover { background: var(--sap-bg); }
.user-menu-item i { width: 16px; color: var(--sap-text-muted); }

/* ── PAGINATION ── */
.pagination {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 10px 16px;
  border-top: 1px solid var(--sap-border);
  background: #FAFBFC;
  font-size: 12.5px;
}
.pag-info { flex: 1; color: var(--sap-text-muted); }
.pag-btn { height: 28px; min-width: 28px; padding: 0 6px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--sap-border); border-radius: var(--radius); background: #fff; cursor: pointer; font-size: 12px; transition: all 0.12s; }
.pag-btn:hover { background: var(--sap-row-hover); }
.pag-btn.active { background: var(--sap-blue); color: #fff; border-color: var(--sap-blue); font-weight: 600; }
.pag-btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* ── TAG ── */
.tag { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 3px; font-size: 11.5px; font-weight: 500; background: #F0F2F4; color: var(--sap-text-muted); }
.tag.blue { background: var(--sap-blue-light); color: var(--sap-blue); }
.tag.green { background: #E8F5EC; color: var(--sap-success); }
.tag.orange { background: #FFF3E0; color: var(--sap-warning); }
.tag.red { background: #FDECEA; color: var(--sap-error); }

/* ── BOM ── */
.bom-tree { display: flex; flex-direction: column; gap: 0; }
.bom-row {
  display: flex;
  align-items: center;
  gap: 0;
  border-bottom: 1px solid #ECEEF0;
  transition: background 0.12s;
  min-height: 38px;
}
.bom-row:hover { background: var(--sap-row-hover); }
.bom-row.level-0 { background: #F8FAFB; font-weight: 600; }
.bom-row.level-0:hover { background: #EDF2F9; }
.bom-row.level-1 .bom-indent { padding-left: 28px; }
.bom-row.level-2 .bom-indent { padding-left: 52px; }
.bom-row.level-3 .bom-indent { padding-left: 76px; }
.bom-indent {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 7px 10px;
  flex: 2;
  min-width: 200px;
  font-size: 13px;
}
.bom-toggle {
  width: 16px; height: 16px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--sap-text-muted); font-size: 10px;
  flex-shrink: 0;
  transition: transform 0.15s;
}
.bom-toggle.open { transform: rotate(90deg); }
.bom-cell { padding: 7px 10px; font-size: 12.5px; }
.bom-cell.w100 { width: 100px; }
.bom-cell.w120 { width: 120px; }
.bom-cell.w80  { width: 80px; }
.bom-cell.w90  { width: 90px; }
.bom-cell.mono { font-family: 'IBM Plex Mono', monospace; font-size: 12px; }
.bom-header {
  display: flex;
  background: #F0F2F4;
  border-bottom: 2px solid var(--sap-border);
  font-size: 11px;
  font-weight: 600;
  color: var(--sap-text-muted);
  text-transform: uppercase;
  letter-spacing: 0.4px;
}
.bom-header .bom-cell, .bom-header .bom-indent { padding: 8px 10px; }
.bom-bulk-badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 2px 8px; border-radius: 3px;
  font-size: 11px; font-weight: 600;
  background: #F0F2F4; color: var(--sap-text-muted);
}
.bom-bulk-badge.bulk { background: #FFF3E0; color: #A05000; }
.bom-bulk-badge.serialized { background: var(--sap-blue-light); color: var(--sap-blue); }
.bom-summary-bar {
  display: flex; gap: 20px; padding: 10px 14px;
  background: #F8FAFB; border-bottom: 1px solid var(--sap-border);
  font-size: 12.5px; flex-wrap: wrap;
}
.bom-summary-item { display: flex; flex-direction: column; gap: 2px; }
.bom-summary-label { font-size: 11px; color: var(--sap-text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.4px; }
.bom-summary-value { font-weight: 700; color: var(--sap-text); font-family: 'IBM Plex Mono', monospace; }

/* ── USERS section ── */
.user-card {
  background: #fff;
  border: 1px solid var(--sap-border);
  border-radius: var(--radius);
  padding: 16px;
  display: flex;
  gap: 14px;
  align-items: flex-start;
}
.user-avatar-lg {
  width: 48px; height: 48px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 18px; flex-shrink: 0;
}
.user-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }

/* Responsive */
@media (max-width: 700px) {
  .kpi-row { grid-template-columns: 1fr 1fr; }
  .detail-grid { grid-template-columns: 1fr 1fr; }
  .user-grid { grid-template-columns: 1fr; }
  .form-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- SHELL BAR -->
<header class="shell-bar">
  <div class="shell-logo">
    <i class="fas fa-cube"></i>
    <span><span class="sap">SAP</span> S/4HANA</span>
  </div>
  <div class="shell-divider"></div>
  <span class="shell-app-title">Asset Management — Land Rig & Contracting</span>
  <div class="shell-spacer"></div>
  <div class="shell-actions">
    <button class="shell-btn" onclick="toggleNotif()" title="Notifications">
      <i class="fas fa-bell"></i>
      <span class="badge" id="notifBadge">4</span>
    </button>
    <button class="shell-btn" onclick="openEmailModal()" title="Send Email Alert">
      <i class="fas fa-envelope"></i>
    </button>
    <button class="shell-btn" title="Settings">
      <i class="fas fa-cog"></i>
    </button>
    <div class="user-avatar" onclick="toggleUserMenu()">AM</div>
  </div>
</header>

<!-- USER MENU -->
<div class="user-menu" id="userMenu">
  <div class="user-info">
    <div class="user-name">Ahmad Mohammed</div>
    <div class="user-role">Asset Manager — Admin</div>
  </div>
  <div class="user-menu-item"><i class="fas fa-user"></i> My Profile</div>
  <div class="user-menu-item"><i class="fas fa-users-cog"></i> Manage Users</div>
  <div class="user-menu-item"><i class="fas fa-cog"></i> Settings</div>
  <div class="user-menu-item" style="color:var(--sap-error)"><i class="fas fa-sign-out-alt"></i> Sign Out</div>
</div>

<!-- SECONDARY NAVIGATION -->
<div class="secondary-bar">
  <button class="nav-tab active" onclick="switchTab('assets', this)"><i class="fas fa-warehouse"></i> Assets</button>
  <button class="nav-tab" onclick="switchTab('contracts', this)"><i class="fas fa-file-contract"></i> Contracts</button>
  <button class="nav-tab" onclick="switchTab('rigs', this)"><i class="fas fa-oil-well"></i> Land Rigs</button>
  <button class="nav-tab" onclick="switchTab('companies', this)"><i class="fas fa-building"></i> Companies</button>
  <button class="nav-tab" onclick="switchTab('users', this)"><i class="fas fa-users"></i> Users</button>
  <button class="nav-tab" onclick="switchTab('bom', this)"><i class="fas fa-sitemap"></i> Bill of Materials</button>
  <button class="nav-tab" onclick="switchTab('maintenance', this)" id="tab-maintenance"><i class="fas fa-tools"></i> Maintenance <span id="maintAlertBadge" style="display:none;background:#B00;color:#fff;border-radius:10px;font-size:10px;font-weight:700;padding:1px 6px;margin-left:4px">0</span></button>
  <button class="nav-tab" onclick="switchTab('reports', this)"><i class="fas fa-chart-bar"></i> Reports</button>
</div>

<!-- NOTIFICATION PANEL -->
<div class="notif-panel" id="notifPanel">
  <div class="notif-header">
    <h3>Notifications</h3>
    <button class="btn btn-ghost" style="font-size:12px" onclick="markAllRead()">Mark all read</button>
    <button class="shell-btn" style="color:var(--sap-text-muted);width:28px;height:28px" onclick="toggleNotif()"><i class="fas fa-times"></i></button>
  </div>
  <div class="notif-list" id="notifList"></div>
</div>

<!-- MAIN PAGE -->
<div class="page">

  <!-- ======= ASSETS SECTION ======= -->
  <div class="section active" id="section-assets">
    <div class="content">
      <!-- KPIs -->
      <div class="kpi-row">
        <div class="kpi-card blue">
          <div class="kpi-icon"><i class="fas fa-warehouse"></i></div>
          <div class="kpi-label">Total Assets</div>
          <div class="kpi-value" id="kpiTotal">0</div>
          <div class="kpi-sub">All registered assets</div>
        </div>
        <div class="kpi-card green">
          <div class="kpi-icon"><i class="fas fa-check-circle"></i></div>
          <div class="kpi-label">Active</div>
          <div class="kpi-value" id="kpiActive">0</div>
          <div class="kpi-sub">Operational</div>
        </div>
        <div class="kpi-card orange">
          <div class="kpi-icon"><i class="fas fa-tools"></i></div>
          <div class="kpi-label">Maintenance</div>
          <div class="kpi-value" id="kpiMaint">0</div>
          <div class="kpi-sub">Under maintenance</div>
        </div>
        <div class="kpi-card red">
          <div class="kpi-icon"><i class="fas fa-file-contract"></i></div>
          <div class="kpi-label">Contracted</div>
          <div class="kpi-value" id="kpiContract">0</div>
          <div class="kpi-sub">Active contracts</div>
        </div>
      </div>

      <!-- Asset Table Card -->
      <div class="card" style="flex:1;display:flex;flex-direction:column">
        <!-- RIG SELECTOR -->
        <div class="rig-selector" id="assetRigSelector"></div>
        <div class="card-header">
          <span class="card-title">Asset List <span class="record-count" id="assetCount"></span></span>
          <button class="btn btn-primary" onclick="openAddAssetModal()"><i class="fas fa-plus"></i> New Asset</button>
          <button class="btn btn-secondary" onclick="exportAssets()"><i class="fas fa-file-excel"></i> Export</button>
          <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> Import</button>
          <input type="file" id="importFile" accept=".xlsx,.xls,.csv" style="display:none" onchange="importAssets(event)">
        </div>
        <div class="filter-bar">
          <div class="filter-group search-wrap">
            <label class="filter-label">Search</label>
            <i class="search-icon fas fa-search"></i>
            <input class="filter-input" id="searchInput" placeholder="Asset ID, name, location..." oninput="applyFilters()">
          </div>
          <div class="filter-group">
            <label class="filter-label">Status</label>
            <select class="filter-select" id="filterStatus" onchange="applyFilters()">
              <option value="">All</option>
              <option>Active</option>
              <option>Maintenance</option>
              <option>Inactive</option>
              <option>Contracted</option>
              <option>Retired</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Category</label>
            <select class="filter-select" id="filterCategory" onchange="applyFilters()">
              <option value="">All</option>
              <option>Drilling Equipment</option>
              <option>Transportation</option>
              <option>Power Generation</option>
              <option>Safety Equipment</option>
              <option>Communication</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Company</label>
            <select class="filter-select" id="filterCompany" onchange="applyFilters()">
              <option value="">All</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Rig</label>
            <select class="filter-select" id="filterRig" onchange="applyFilters()">
              <option value="">All Rigs</option>
            </select>
          </div>
          <div class="filter-group" style="margin-left:auto">
            <label class="filter-label">&nbsp;</label>
            <button class="btn btn-ghost" onclick="clearFilters()"><i class="fas fa-times"></i> Clear</button>
          </div>
        </div>
        <div class="table-wrap" style="flex:1">
          <table id="assetTable">
            <thead>
              <tr>
                <th class="checkbox-cell"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
                <th onclick="sortTable('assetId')">Asset ID <i class="fas fa-sort sort-icon"></i></th>
                <th onclick="sortTable('name')">Asset Name <i class="fas fa-sort sort-icon"></i></th>
                <th onclick="sortTable('category')">Category <i class="fas fa-sort sort-icon"></i></th>
                <th onclick="sortTable('company')">Company <i class="fas fa-sort sort-icon"></i></th>
                <th onclick="sortTable('rigName')">Rig <i class="fas fa-sort sort-icon"></i></th>
                <th onclick="sortTable('location')">Location <i class="fas fa-sort sort-icon"></i></th>
                <th onclick="sortTable('status')">Status <i class="fas fa-sort sort-icon"></i></th>
                <th onclick="sortTable('value')">Value (USD) <i class="fas fa-sort sort-icon"></i></th>
                <th onclick="sortTable('acquisitionDate')">Acquisition Date <i class="fas fa-sort sort-icon"></i></th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="assetTbody"></tbody>
          </table>
        </div>
        <div class="pagination">
          <div class="pag-info" id="pagInfo"></div>
          <button class="pag-btn" id="btnPrev" onclick="changePage(-1)"><i class="fas fa-chevron-left"></i></button>
          <div id="pagPages"></div>
          <button class="pag-btn" id="btnNext" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></button>
          <select class="filter-select" style="height:28px;width:70px;margin-left:8px;font-size:12px" id="pageSize" onchange="changePageSize()">
            <option>10</option><option>25</option><option selected>50</option><option>100</option>
          </select>
          <span style="color:var(--sap-text-muted);font-size:12px">per page</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ======= CONTRACTS ======= -->
  <div class="section" id="section-contracts">
    <div class="content">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Contracts</span>
          <button class="btn btn-primary"><i class="fas fa-plus"></i> New Contract</button>
          <button class="btn btn-secondary" onclick="exportContracts()"><i class="fas fa-file-excel"></i> Export</button>
        </div>
        <div class="filter-bar">
          <div class="filter-group search-wrap">
            <label class="filter-label">Search</label>
            <i class="search-icon fas fa-search"></i>
            <input class="filter-input" id="contractSearch" placeholder="Contract ID, company..." oninput="applyContractFilters()">
          </div>
          <div class="filter-group">
            <label class="filter-label">Status</label>
            <select class="filter-select" id="contractStatus" onchange="applyContractFilters()">
              <option value="">All</option>
              <option>Active</option>
              <option>Expired</option>
              <option>Pending</option>
            </select>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Contract ID</th>
                <th>Company</th>
                <th>Rig</th>
                <th>Asset Count</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Value (USD)</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="contractTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ======= LAND RIGS ======= -->
  <div class="section" id="section-rigs">
    <div class="content">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Land Rigs</span>
          <button class="btn btn-primary"><i class="fas fa-plus"></i> New Rig</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Rig ID</th>
                <th>Rig Name</th>
                <th>Type</th>
                <th>Company</th>
                <th>Location</th>
                <th>Depth Capacity</th>
                <th>Status</th>
                <th>Assets Assigned</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="rigTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ======= COMPANIES ======= -->
  <div class="section" id="section-companies">
    <div class="content">
      <div class="card">
        <div class="card-header"><span class="card-title">Contracting Companies</span><button class="btn btn-primary"><i class="fas fa-plus"></i> Add Company</button></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Company ID</th><th>Name</th><th>Type</th><th>Country</th><th>Contact</th><th>Email</th><th>Active Contracts</th><th>Status</th></tr></thead>
            <tbody id="companyTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ======= USERS ======= -->
  <div class="section" id="section-users">
    <div class="content">
      <div class="card">
        <div class="card-header"><span class="card-title">System Users</span><button class="btn btn-primary"><i class="fas fa-plus"></i> Add User</button></div>
        <div class="user-grid" style="padding:16px" id="userGrid"></div>
      </div>
    </div>
  </div>

  <!-- ======= BILL OF MATERIALS ======= -->
  <div class="section" id="section-bom">
    <div class="content">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Bill of Materials <span class="record-count" id="bomCount"></span></span>
          <button class="btn btn-primary" onclick="openBomModal()"><i class="fas fa-plus"></i> Add BOM</button>
          <button class="btn btn-secondary" onclick="exportBOM()"><i class="fas fa-file-excel"></i> Export BOM</button>
          <div class="filter-group search-wrap" style="margin-left:8px">
            <i class="search-icon fas fa-search"></i>
            <input class="filter-input" id="bomSearch" placeholder="Search BOM…" oninput="renderBOMSection()" style="padding-left:32px;height:32px">
          </div>
          <select class="filter-select" id="bomFilterAsset" onchange="renderBOMSection()" style="height:32px">
            <option value="">All Assets</option>
          </select>
          <select class="filter-select" id="bomFilterType" onchange="renderBOMSection()" style="height:32px">
            <option value="">All Types</option>
            <option value="Serialized">Serialized</option>
            <option value="Bulk">Bulk</option>
          </select>
        </div>

        <!-- BOM Tree Table -->
        <div class="table-wrap" id="bomSectionWrap">
          <div class="bom-header">
            <div class="bom-indent" style="flex:2">Component / Item</div>
            <div class="bom-cell w120">Part Number</div>
            <div class="bom-cell w80">Type</div>
            <div class="bom-cell w80">Qty</div>
            <div class="bom-cell w90">Unit</div>
            <div class="bom-cell w120">Unit Cost (USD)</div>
            <div class="bom-cell w120">Total Cost (USD)</div>
            <div class="bom-cell w90">Status</div>
            <div class="bom-cell" style="width:100px">Actions</div>
          </div>
          <div id="bomSectionTree"></div>
        </div>
      </div>
    </div>
  </div>


  <!-- ======= TRANSFERS SECTION ======= -->
  <div class="section" id="section-transfers">
    <div class="content">

      <!-- KPI Row -->
      <div class="kpi-row">
        <div class="kpi-card blue">
          <div class="kpi-icon"><i class="fas fa-paper-plane"></i></div>
          <div class="kpi-label">Total Requests</div>
          <div class="kpi-value" id="trKpiTotal">0</div>
          <div class="kpi-sub">All transfers</div>
        </div>
        <div class="kpi-card orange">
          <div class="kpi-icon"><i class="fas fa-clock"></i></div>
          <div class="kpi-label">Pending</div>
          <div class="kpi-value" id="trKpiPending">0</div>
          <div class="kpi-sub">Awaiting approval</div>
        </div>
        <div class="kpi-card blue" style="--kpi-accent:#8B5CF6">
          <div class="kpi-icon" style="background:#F0E8FF;color:#8B5CF6"><i class="fas fa-user-check"></i></div>
          <div class="kpi-label">Ops Approved</div>
          <div class="kpi-value" id="trKpiOps">0</div>
          <div class="kpi-sub">Awaiting Asset Mgr</div>
        </div>
        <div class="kpi-card green">
          <div class="kpi-icon"><i class="fas fa-check-double"></i></div>
          <div class="kpi-label">Completed</div>
          <div class="kpi-value" id="trKpiDone">0</div>
          <div class="kpi-sub">Fully approved</div>
        </div>
        <div class="kpi-card red">
          <div class="kpi-icon"><i class="fas fa-times-circle"></i></div>
          <div class="kpi-label">Rejected</div>
          <div class="kpi-value" id="trKpiRej">0</div>
          <div class="kpi-sub">Denied transfers</div>
        </div>
      </div>

      <!-- Transfer List Card -->
      <div class="card" style="flex:1;display:flex;flex-direction:column">
        <div class="card-header">
          <span class="card-title"><i class="fas fa-exchange-alt" style="color:var(--sap-blue)"></i> Asset Transfer Requests <span class="record-count" id="trCount"></span></span>
          <button class="btn btn-primary" onclick="openTransferModal(null)"><i class="fas fa-plus"></i> New Transfer Request</button>
          <button class="btn btn-secondary" onclick="exportTransfers()"><i class="fas fa-file-excel"></i> Export</button>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
          <div class="filter-group search-wrap">
            <label class="filter-label">Search</label>
            <i class="search-icon fas fa-search"></i>
            <input class="filter-input" id="trSearch" placeholder="Asset ID, name, location..." oninput="renderTransfers()" style="padding-left:30px">
          </div>
          <div class="filter-group">
            <label class="filter-label">Status</label>
            <select class="filter-select" id="trFilterStatus" onchange="renderTransfers()">
              <option value="">All Status</option>
              <option value="Pending">Pending</option>
              <option value="Ops Approved">Ops Approved</option>
              <option value="Completed">Completed</option>
              <option value="Rejected">Rejected</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Priority</label>
            <select class="filter-select" id="trFilterPriority" onchange="renderTransfers()">
              <option value="">All Priorities</option>
              <option value="Critical">Critical</option>
              <option value="High">High</option>
              <option value="Normal">Normal</option>
              <option value="Low">Low</option>
            </select>
          </div>
          <div class="filter-group" style="margin-left:auto">
            <label class="filter-label">&nbsp;</label>
            <button class="btn btn-ghost" onclick="clearTransferFilters()"><i class="fas fa-times"></i> Clear</button>
          </div>
        </div>

        <!-- Transfer Table -->
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Request ID</th>
                <th>Asset</th>
                <th>Current Location</th>
                <th>Destination</th>
                <th>Reason</th>
                <th>Priority</th>
                <th>Requested By</th>
                <th>Request Date</th>
                <th>Status</th>
                <th>Ops Manager</th>
                <th>Asset Manager</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="transferTbody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>


  <!-- ======= MAINTENANCE SECTION ======= -->
  <div class="section" id="section-maintenance">
    <div class="content">

      <!-- ALERT BANNER -->
      <div id="maintAlertBanner" style="display:none;background:linear-gradient(90deg,#8B0000,#C00);color:#fff;border-radius:6px;padding:12px 18px;display:flex;align-items:center;gap:12px;flex-shrink:0">
        <i class="fas fa-exclamation-triangle" style="font-size:20px;flex-shrink:0"></i>
        <div style="flex:1">
          <div style="font-weight:700;font-size:14px" id="maintAlertBannerTitle">Maintenance Alert</div>
          <div style="font-size:12.5px;opacity:.9;margin-top:2px" id="maintAlertBannerDesc"></div>
        </div>
        <button onclick="switchTab('maintenance',document.getElementById('tab-maintenance'))" style="background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.4);color:#fff;padding:6px 14px;border-radius:4px;font-size:12px;cursor:pointer;font-weight:600">View All →</button>
        <button onclick="document.getElementById('maintAlertBanner').style.display='none'" style="background:none;border:none;color:rgba(255,255,255,.7);cursor:pointer;font-size:16px;padding:0 4px">✕</button>
      </div>

      <!-- KPI ROW -->
      <div class="kpi-row">
        <div class="kpi-card blue">
          <div class="kpi-icon"><i class="fas fa-clipboard-list"></i></div>
          <div><div class="kpi-label">Total Schedules</div><div class="kpi-value" id="mKpiTotal">0</div><div class="kpi-sub">All PM tasks</div></div>
        </div>
        <div class="kpi-card red">
          <div class="kpi-icon" style="background:#FDECEA;color:#B00"><i class="fas fa-exclamation-circle"></i></div>
          <div><div class="kpi-label">Overdue</div><div class="kpi-value" id="mKpiOverdue" style="color:#B00">0</div><div class="kpi-sub">Past due date</div></div>
        </div>
        <div class="kpi-card orange">
          <div class="kpi-icon"><i class="fas fa-clock"></i></div>
          <div><div class="kpi-label">Due Soon</div><div class="kpi-value" id="mKpiSoon" style="color:var(--sap-warning)">0</div><div class="kpi-sub">Within 14 days</div></div>
        </div>
        <div class="kpi-card green">
          <div class="kpi-icon"><i class="fas fa-check-circle"></i></div>
          <div><div class="kpi-label">Completed</div><div class="kpi-value" id="mKpiDone">0</div><div class="kpi-sub">This period</div></div>
        </div>
        <div class="kpi-card blue" style="">
          <div class="kpi-icon" style="background:#F0E8FF;color:#7C3AED"><i class="fas fa-calendar-check"></i></div>
          <div><div class="kpi-label">Scheduled</div><div class="kpi-value" id="mKpiSched">0</div><div class="kpi-sub">Upcoming</div></div>
        </div>
      </div>

      <!-- OVERDUE & DUE-SOON QUICK ALERTS STRIP -->
      <div id="maintQuickAlerts" style="display:flex;flex-direction:column;gap:6px"></div>

      <!-- MAIN CARD -->
      <div class="card" style="flex:1;display:flex;flex-direction:column">
        <!-- RIG SELECTOR -->
        <div class="rig-selector" id="maintRigSelector"></div>
        <div class="card-header">
          <span class="card-title"><i class="fas fa-tools" style="color:var(--sap-blue)"></i> Preventive Maintenance Schedule <span class="record-count" id="mCount"></span></span>
          <button class="btn btn-primary" onclick="openMaintModal()"><i class="fas fa-plus"></i> New Schedule</button>
          <button class="btn btn-secondary" onclick="exportMaintenance()"><i class="fas fa-file-excel"></i> Export</button>
          <button class="btn btn-secondary" onclick="openMaintLogModal(null,'bulk')"><i class="fas fa-history"></i> Log Completion</button>
        </div>

        <!-- FILTER BAR -->
        <div class="filter-bar">
          <div class="filter-group search-wrap">
            <label class="filter-label">Search</label>
            <i class="search-icon fas fa-search"></i>
            <input class="filter-input" id="mSearch" placeholder="Asset, task, technician..." oninput="renderMaintenance()" style="padding-left:30px">
          </div>
          <div class="filter-group">
            <label class="filter-label">Status</label>
            <select class="filter-select" id="mFilterStatus" onchange="renderMaintenance()">
              <option value="">All</option>
              <option value="Overdue">🔴 Overdue</option>
              <option value="Due Soon">🟠 Due Soon</option>
              <option value="Scheduled">🔵 Scheduled</option>
              <option value="Completed">🟢 Completed</option>
              <option value="In Progress">🟡 In Progress</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Type</label>
            <select class="filter-select" id="mFilterType" onchange="renderMaintenance()">
              <option value="">All Types</option>
              <option>Oil Change</option>
              <option>Inspection</option>
              <option>Calibration</option>
              <option>Overhaul</option>
              <option>Filter Replacement</option>
              <option>Lubrication</option>
              <option>Pressure Test</option>
              <option>Electrical Check</option>
              <option>Safety Check</option>
              <option>General Service</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Asset</label>
            <select class="filter-select" id="mFilterAsset" onchange="renderMaintenance()">
              <option value="">All Assets</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Priority</label>
            <select class="filter-select" id="mFilterPriority" onchange="renderMaintenance()">
              <option value="">All</option>
              <option>Critical</option><option>High</option><option>Normal</option><option>Low</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Rig</label>
            <select class="filter-select" id="mFilterRig" onchange="renderMaintenance()">
              <option value="">All Rigs</option>
            </select>
          </div>
          <div class="filter-group" style="margin-left:auto">
            <label class="filter-label">&nbsp;</label>
            <button class="btn btn-ghost" onclick="clearMaintFilters()"><i class="fas fa-times"></i> Clear</button>
          </div>
        </div>

        <!-- TABLE -->
        <div class="table-wrap" style="flex:1">
          <table id="maintTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Asset</th>
                <th>Task / Description</th>
                <th>Type</th>
                <th>Frequency</th>
                <th>Last Done</th>
                <th>Next Due</th>
                <th>Days Left</th>
                <th>Priority</th>
                <th>Technician</th>
                <th>Est. Hours</th>
                <th>Cost (USD)</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="maintTbody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- ======= REPORTS ======= -->
  <div class="section" id="section-reports">
    <div class="content">
      <div class="kpi-row">
        <div class="kpi-card blue"><div class="kpi-icon"><i class="fas fa-dollar-sign"></i></div><div class="kpi-label">Total Asset Value</div><div class="kpi-value" id="rptValue">—</div><div class="kpi-sub">USD</div></div>
        <div class="kpi-card green"><div class="kpi-icon"><i class="fas fa-file-contract"></i></div><div class="kpi-label">Active Contracts</div><div class="kpi-value" id="rptContracts">—</div><div class="kpi-sub">Current</div></div>
        <div class="kpi-card orange"><div class="kpi-icon"><i class="fas fa-oil-well"></i></div><div class="kpi-label">Rigs Active</div><div class="kpi-value" id="rptRigs">—</div><div class="kpi-sub">Operational</div></div>
        <div class="kpi-card red"><div class="kpi-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="kpi-label">Expiring Soon</div><div class="kpi-value" id="rptExpiring">2</div><div class="kpi-sub">Within 30 days</div></div>
      </div>
      <div class="card" style="padding:20px">
        <div class="card-title">Export Reports</div>
        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-secondary" onclick="exportAssets()"><i class="fas fa-file-excel" style="color:var(--sap-success)"></i> Assets Report</button>
          <button class="btn btn-secondary" onclick="exportContracts()"><i class="fas fa-file-excel" style="color:var(--sap-success)"></i> Contracts Report</button>
          <button class="btn btn-secondary"><i class="fas fa-file-pdf" style="color:var(--sap-error)"></i> Asset Summary PDF</button>
          <button class="btn btn-secondary" onclick="openEmailModal()"><i class="fas fa-envelope" style="color:var(--sap-blue)"></i> Email Report</button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ══════════════════════════════════════════
     MODALS
═══════════════════════════════════════════ -->

<!-- EMAIL ALERT MODAL -->
<div class="modal-overlay" id="emailModal">
  <div class="modal">
    <div class="modal-header">
      <i class="fas fa-envelope" style="color:var(--sap-blue);font-size:18px"></i>
      <h2>Send Email Alert</h2>
      <button class="shell-btn" style="color:var(--sap-text-muted)" onclick="closeEmailModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">To (recipients)</label>
        <input class="form-input" id="emailTo" value="operations@rigco.com; assets@company.com" placeholder="email@domain.com">
      </div>
      <div class="form-group">
        <label class="form-label">Subject</label>
        <input class="form-input" id="emailSubject" value="Asset Management Alert – SAP S/4HANA">
      </div>
      <div class="form-group">
        <label class="form-label">Alert Type</label>
        <select class="form-select" id="emailType" onchange="updateEmailBody()">
          <option>Asset Status Change</option>
          <option>Contract Expiry Warning</option>
          <option>Maintenance Required</option>
          <option>New Asset Assigned</option>
          <option>Custom Message</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Message</label>
        <textarea class="form-textarea" id="emailBody" rows="6">Dear Team,

This is an automated alert from the SAP Asset Management System.

Please review the attached asset report and take necessary action.

Regards,
Asset Management System</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Attach</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="attachReport" checked style="accent-color:var(--sap-blue)"> Asset List (Excel)</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input type="checkbox" id="attachSummary"> Summary Report</label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeEmailModal()">Cancel</button>
      <button class="btn btn-primary" onclick="sendEmail()"><i class="fas fa-paper-plane"></i> Send Alert</button>
    </div>
  </div>
</div>

<!-- ADD ASSET MODAL -->
<div class="modal-overlay" id="addAssetModal">
  <div class="modal" style="width:680px">
    <div class="modal-header">
      <i class="fas fa-plus-circle" style="color:var(--sap-blue);font-size:18px"></i>
      <h2 id="addAssetTitle">New Asset</h2>
      <button class="shell-btn" style="color:var(--sap-text-muted)" onclick="closeModal('addAssetModal')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Asset ID</label><input class="form-input" id="f_assetId" placeholder="AST-0001"></div>
        <div class="form-group"><label class="form-label">Asset Name</label><input class="form-input" id="f_name" placeholder="Asset name"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Category</label>
          <select class="form-select" id="f_category">
            <option>Drilling Equipment</option><option>Transportation</option><option>Power Generation</option><option>Safety Equipment</option><option>Communication</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Status</label>
          <select class="form-select" id="f_status"><option>Active</option><option>Maintenance</option><option>Inactive</option><option>Contracted</option><option>Retired</option></select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Company</label>
          <select class="form-select" id="f_company"></select>
        </div>
        <div class="form-group"><label class="form-label">Rig</label>
          <select class="form-select" id="f_rig"></select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Location</label><input class="form-input" id="f_location" placeholder="Site / Field"></div>
        <div class="form-group"><label class="form-label">Value (USD)</label><input class="form-input" id="f_value" type="number" placeholder="0"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Acquisition Date</label><input class="form-input" id="f_date" type="date"></div>
        <div class="form-group"><label class="form-label">Serial Number</label><input class="form-input" id="f_serial" placeholder="SN-XXXX"></div>
      </div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="f_notes" rows="2" placeholder="Additional notes..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('addAssetModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveAsset()"><i class="fas fa-save"></i> Save Asset</button>
    </div>
  </div>
</div>

<!-- ASSET DETAIL POPUP -->
<div class="modal-overlay" id="assetDetailModal">
  <div class="asset-popup">
    <div class="popup-header">
      <div class="popup-header-icon"><i class="fas fa-warehouse"></i></div>
      <div class="popup-header-info">
        <div class="popup-header-title" id="popupTitle">—</div>
        <div class="popup-header-sub" id="popupSub">—</div>
      </div>
      <div id="popupStatus"></div>
      <button class="shell-btn" style="margin-left:8px" onclick="closeModal('assetDetailModal')"><i class="fas fa-times"></i></button>
    </div>
    <div class="popup-tabs">
      <div class="popup-tab active" onclick="switchPopupTab('general', this)">General Info</div>
      <div class="popup-tab" onclick="switchPopupTab('bom', this)"><i class="fas fa-sitemap" style="font-size:11px"></i> Bill of Materials</div>
      <div class="popup-tab" onclick="switchPopupTab('contract', this)">Contract Details</div>
      <div class="popup-tab" onclick="switchPopupTab('rig', this)">Rig Info</div>
      <div class="popup-tab" onclick="switchPopupTab('history', this)">History</div>
    </div>
    <div class="popup-body">
      <div class="popup-section active" id="ps-general">
        <div class="section-title">Asset Information</div>
        <div class="detail-grid" id="popupGeneralGrid"></div>
        <div class="section-title" style="margin-top:18px">Technical Details</div>
        <div class="detail-grid" id="popupTechGrid"></div>
      </div>

      <!-- BOM TAB in popup -->
      <div class="popup-section" id="ps-bom">
        <div class="bom-summary-bar" id="popupBomSummary"></div>
        <div class="bom-header">
          <div class="bom-indent" style="flex:2">Component / Item</div>
          <div class="bom-cell w120">Part Number</div>
          <div class="bom-cell w80">Type</div>
          <div class="bom-cell w80">Qty</div>
          <div class="bom-cell w90">Unit</div>
          <div class="bom-cell w120">Unit Cost (USD)</div>
          <div class="bom-cell w120">Total Cost (USD)</div>
          <div class="bom-cell w90">Status</div>
          <div class="bom-cell" style="width:80px">Actions</div>
        </div>
        <div id="popupBomTree"></div>
        <div style="padding:10px 14px;border-top:1px solid var(--sap-border)">
          <button class="btn btn-ghost" onclick="openBomModal(currentAsset?.assetId)"><i class="fas fa-plus"></i> Add Component</button>
        </div>
      </div>
      <div class="popup-section" id="ps-contract">
        <div class="section-title">Contract Information</div>
        <div id="popupContractInfo"></div>
      </div>
      <div class="popup-section" id="ps-rig">
        <div class="section-title">Land Rig Details</div>
        <div id="popupRigInfo"></div>
      </div>
      <div class="popup-section" id="ps-history">
        <div class="section-title">Asset History</div>
        <table class="mini-table">
          <thead><tr><th>Date</th><th>Action</th><th>User</th><th>Notes</th></tr></thead>
          <tbody id="popupHistoryTbody"></tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('assetDetailModal')">Close</button>
      <button class="btn btn-ghost" onclick="openEmailModal()"><i class="fas fa-envelope"></i> Send Alert</button>
      <button class="btn btn-warning" onclick="openTransferModal(currentAsset?.assetId)" style="background:#E9730C;color:#fff;border-color:#E9730C"><i class="fas fa-exchange-alt"></i> Transfer Asset</button>
      <button class="btn btn-primary" onclick="editCurrentAsset()"><i class="fas fa-edit"></i> Edit</button>
    </div>
  </div>
</div>


<!-- ══════════════════════════════════════════
     TRANSFER REQUEST MODAL
═══════════════════════════════════════════ -->
<div class="modal-overlay" id="transferRequestModal">
  <div class="modal" style="width:680px;max-width:95vw">
    <div class="modal-header">
      <i class="fas fa-exchange-alt" style="color:var(--sap-blue);font-size:18px"></i>
      <h2 id="transferModalTitle">Asset Transfer Request</h2>
      <button class="shell-btn" style="color:var(--sap-text-muted)" onclick="closeModal('transferRequestModal')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">

      <!-- Asset Info Banner -->
      <div id="trAssetBanner" style="background:linear-gradient(135deg,#354A5E,#4A6580);color:#fff;border-radius:6px;padding:14px 16px;display:flex;align-items:center;gap:14px;margin-bottom:4px">
        <div style="width:44px;height:44px;background:rgba(255,255,255,.15);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">
          <i class="fas fa-warehouse"></i>
        </div>
        <div>
          <div style="font-weight:700;font-size:15px" id="trBannerName">Select an Asset</div>
          <div style="font-size:12px;opacity:.75;margin-top:3px" id="trBannerSub">—</div>
        </div>
        <div style="margin-left:auto" id="trBannerStatus"></div>
      </div>

      <!-- Asset Selector (shown when opened without specific asset) -->
      <div class="form-group" id="trAssetSelectorGroup">
        <label class="form-label">Asset <span style="color:var(--sap-error)">*</span></label>
        <select class="form-select" id="tr_asset" onchange="onTransferAssetChange()">
          <option value="">— Select Asset —</option>
        </select>
      </div>

      <!-- Current Location (Read-only) -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label"><i class="fas fa-map-marker-alt" style="color:var(--sap-text-muted)"></i> Current Location</label>
          <div style="position:relative">
            <input class="form-input" id="tr_currentLoc" readonly style="background:#F5F6F7;color:var(--sap-text-muted);cursor:not-allowed;padding-left:36px">
            <i class="fas fa-lock" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#ccc;font-size:12px"></i>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label"><i class="fas fa-map-pin" style="color:var(--sap-blue)"></i> Destination Location <span style="color:var(--sap-error)">*</span></label>
          <input class="form-input" id="tr_destination" placeholder="e.g. Warehouse B, Rig #12, Field Site A...">
        </div>
      </div>

      <!-- Rig / Company destination info -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Destination Rig (if applicable)</label>
          <select class="form-select" id="tr_destRig">
            <option value="">— None / Not Applicable —</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Destination Company</label>
          <select class="form-select" id="tr_destCompany">
            <option value="">— Same / Not Applicable —</option>
          </select>
        </div>
      </div>

      <!-- Priority & Transfer Type -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Priority <span style="color:var(--sap-error)">*</span></label>
          <select class="form-select" id="tr_priority">
            <option value="Normal" selected>Normal</option>
            <option value="High">High</option>
            <option value="Critical">⚠ Critical</option>
            <option value="Low">Low</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Transfer Type</label>
          <select class="form-select" id="tr_type">
            <option>Field to Field</option>
            <option>Field to Warehouse</option>
            <option>Warehouse to Field</option>
            <option>Rig to Rig</option>
            <option>For Maintenance</option>
            <option>For Inspection</option>
            <option>Return to Owner</option>
          </select>
        </div>
      </div>

      <!-- Requested By & Date -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Requested By</label>
          <input class="form-input" id="tr_requestedBy" value="Ahmad Mohammed" readonly style="background:#F5F6F7">
        </div>
        <div class="form-group">
          <label class="form-label">Required By Date</label>
          <input class="form-input" type="date" id="tr_requiredDate">
        </div>
      </div>

      <!-- Reason for Transfer -->
      <div class="form-group">
        <label class="form-label">Reason for Transfer <span style="color:var(--sap-error)">*</span></label>
        <textarea class="form-textarea" id="tr_reason" rows="3" placeholder="Explain the reason for this transfer request in detail. Include operational need, urgency, and any relevant context..."></textarea>
      </div>

      <!-- Special Instructions -->
      <div class="form-group">
        <label class="form-label">Special Instructions / Handling Notes</label>
        <textarea class="form-textarea" id="tr_instructions" rows="2" placeholder="Any special transport requirements, safety notes, or handling instructions..."></textarea>
      </div>

      <!-- Approval Route Info Box -->
      <div style="background:#EBF4FF;border:1px solid #C2DCFF;border-radius:6px;padding:14px 16px;display:flex;gap:12px;align-items:flex-start">
        <i class="fas fa-info-circle" style="color:var(--sap-blue);font-size:16px;margin-top:1px;flex-shrink:0"></i>
        <div style="font-size:12.5px;line-height:1.6">
          <strong style="color:var(--sap-blue)">Approval Workflow:</strong><br>
          Your request will go through a <strong>2-stage approval</strong>:
          <div style="margin-top:6px;display:flex;gap:6px;align-items:center;flex-wrap:wrap">
            <div style="background:#fff;border:1px solid #C2DCFF;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;color:#0040B0">
              <i class="fas fa-paper-plane"></i> Submitted
            </div>
            <i class="fas fa-arrow-right" style="color:var(--sap-blue);font-size:11px"></i>
            <div style="background:#FFF3E0;border:1px solid #FFCC80;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;color:#E65100">
              <i class="fas fa-hard-hat"></i> Ops Manager Review
            </div>
            <i class="fas fa-arrow-right" style="color:var(--sap-blue);font-size:11px"></i>
            <div style="background:#F0E8FF;border:1px solid #C4A8FF;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;color:#6D28D9">
              <i class="fas fa-user-tie"></i> Asset Manager Final
            </div>
            <i class="fas fa-arrow-right" style="color:var(--sap-blue);font-size:11px"></i>
            <div style="background:#E4F5EC;border:1px solid #A8D8B8;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:600;color:#065F46">
              <i class="fas fa-check-double"></i> Transfer Executed
            </div>
          </div>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('transferRequestModal')">Cancel</button>
      <button class="btn btn-primary" onclick="submitTransferRequest()">
        <i class="fas fa-paper-plane"></i> Submit Transfer Request
      </button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════
     TRANSFER APPROVAL MODAL
═══════════════════════════════════════════ -->
<div class="modal-overlay" id="transferApprovalModal">
  <div class="modal" style="width:700px;max-width:95vw">
    <div class="modal-header" id="approvalModalHeader">
      <i class="fas fa-clipboard-check" style="color:var(--sap-blue);font-size:18px"></i>
      <h2 id="approvalModalTitle">Review Transfer Request</h2>
      <button class="shell-btn" style="color:var(--sap-text-muted)" onclick="closeModal('transferApprovalModal')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">

      <!-- Transfer Summary Card -->
      <div style="background:#F8F9FA;border:1px solid var(--sap-border);border-radius:6px;overflow:hidden;margin-bottom:4px">
        <div style="background:linear-gradient(135deg,#354A5E,#4A6580);color:#fff;padding:12px 16px;font-weight:600;font-size:14px;display:flex;align-items:center;gap:8px">
          <i class="fas fa-exchange-alt"></i> Transfer Summary
          <span id="approvalReqId" style="font-family:'IBM Plex Mono',monospace;font-size:12px;opacity:.8;margin-left:4px"></span>
        </div>
        <div class="detail-grid" id="approvalSummaryGrid" style="font-size:13px"></div>
      </div>

      <!-- Current Approval Status Timeline -->
      <div style="margin:4px 0;padding:14px 16px;background:#fff;border:1px solid var(--sap-border);border-radius:6px">
        <div style="font-size:12px;font-weight:700;color:var(--sap-text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">Approval Timeline</div>
        <div id="approvalTimeline" style="display:flex;flex-direction:column;gap:0"></div>
      </div>

      <!-- Approval Action Panel -->
      <div id="approvalActionPanel" style="background:linear-gradient(135deg,#EBF4FF,#F5F9FF);border:1px solid #C2DCFF;border-radius:6px;padding:16px">
        <div style="font-size:13px;font-weight:600;color:var(--sap-blue);margin-bottom:10px" id="approvalActionTitle">
          <i class="fas fa-gavel"></i> Your Review
        </div>
        <div class="form-group">
          <label class="form-label">Decision Comments <span style="color:var(--sap-error)">*</span></label>
          <textarea class="form-textarea" id="approvalComment" rows="3" placeholder="Add your approval comments, conditions, or rejection reason..."></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-top:4px;flex-wrap:wrap">
          <button class="btn btn-success" onclick="processApproval('approve')" id="btnApprove">
            <i class="fas fa-check"></i> Approve
          </button>
          <button class="btn btn-danger" onclick="processApproval('reject')" id="btnReject">
            <i class="fas fa-times"></i> Reject
          </button>
          <button class="btn btn-ghost" onclick="processApproval('hold')" id="btnHold">
            <i class="fas fa-pause"></i> Put on Hold
          </button>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('transferApprovalModal')">Close</button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════
     TRANSFER DETAIL VIEW MODAL (read-only)
═══════════════════════════════════════════ -->
<div class="modal-overlay" id="transferDetailModal">
  <div class="modal" style="width:640px;max-width:95vw">
    <div class="modal-header">
      <i class="fas fa-file-alt" style="color:var(--sap-blue);font-size:18px"></i>
      <h2>Transfer Request Details</h2>
      <button class="shell-btn" style="color:var(--sap-text-muted)" onclick="closeModal('transferDetailModal')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body" id="transferDetailBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('transferDetailModal')">Close</button>
    </div>
  </div>
</div>


<!-- ══════════════════════════════════════════
     ADD / EDIT MAINTENANCE MODAL
════════════════════════════════════════════ -->
<div class="modal-overlay" id="maintModal">
  <div class="modal" style="width:720px;max-width:96vw">
    <div class="modal-header">
      <i class="fas fa-tools" style="color:var(--sap-blue);font-size:18px"></i>
      <h2 id="maintModalTitle">New Maintenance Schedule</h2>
      <button class="shell-btn" style="color:var(--sap-text-muted)" onclick="closeModal('maintModal')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Asset <span style="color:var(--sap-error)">*</span></label>
          <select class="form-select" id="m_asset" onchange="onMaintAssetChange()">
            <option value="">— Select Asset —</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Task Name <span style="color:var(--sap-error)">*</span></label>
          <input class="form-input" id="m_task" placeholder="e.g. Engine Oil Change, BOP Pressure Test…">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Maintenance Type <span style="color:var(--sap-error)">*</span></label>
          <select class="form-select" id="m_type">
            <option>Oil Change</option><option>Inspection</option><option>Calibration</option>
            <option>Overhaul</option><option>Filter Replacement</option><option>Lubrication</option>
            <option>Pressure Test</option><option>Electrical Check</option><option>Safety Check</option><option>General Service</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Priority</label>
          <select class="form-select" id="m_priority">
            <option>Normal</option><option>High</option><option>Critical</option><option>Low</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Frequency</label>
          <select class="form-select" id="m_freq" onchange="calcNextDue()">
            <option value="7">Weekly (7 days)</option>
            <option value="14">Bi-Weekly (14 days)</option>
            <option value="30" selected>Monthly (30 days)</option>
            <option value="60">Bi-Monthly (60 days)</option>
            <option value="90">Quarterly (90 days)</option>
            <option value="180">Semi-Annual (180 days)</option>
            <option value="365">Annual (365 days)</option>
            <option value="custom">Custom interval…</option>
          </select>
        </div>
        <div class="form-group" id="m_customFreqGroup" style="display:none">
          <label class="form-label">Custom Interval (days)</label>
          <input class="form-input" type="number" id="m_customFreq" placeholder="e.g. 45" oninput="calcNextDue()">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Last Performed Date</label>
          <input class="form-input" type="date" id="m_lastDone" oninput="calcNextDue()">
        </div>
        <div class="form-group">
          <label class="form-label">Next Due Date <span style="color:var(--sap-error)">*</span></label>
          <div style="position:relative">
            <input class="form-input" type="date" id="m_nextDue">
            <span id="m_dueDaysLabel" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:11px;font-weight:600;pointer-events:none"></span>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Assigned Technician</label>
          <input class="form-input" id="m_tech" placeholder="Name or team">
        </div>
        <div class="form-group">
          <label class="form-label">Estimated Duration (hours)</label>
          <input class="form-input" type="number" id="m_hours" placeholder="e.g. 4" step="0.5">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Estimated Cost (USD)</label>
          <input class="form-input" type="number" id="m_cost" placeholder="e.g. 1500">
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-select" id="m_status">
            <option>Scheduled</option><option>In Progress</option><option>Completed</option><option>Cancelled</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Alert Before Due (days)</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px">
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;background:#F5F6F7;padding:5px 10px;border-radius:4px;border:1px solid var(--sap-border)">
            <input type="radio" name="m_alertDays" value="7" style="accent-color:var(--sap-blue)"> 7 days
          </label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;background:#F5F6F7;padding:5px 10px;border-radius:4px;border:1px solid var(--sap-border)">
            <input type="radio" name="m_alertDays" value="14" checked style="accent-color:var(--sap-blue)"> 14 days
          </label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;background:#F5F6F7;padding:5px 10px;border-radius:4px;border:1px solid var(--sap-border)">
            <input type="radio" name="m_alertDays" value="30" style="accent-color:var(--sap-blue)"> 30 days
          </label>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes / Procedure</label>
        <textarea class="form-textarea" id="m_notes" rows="3" placeholder="Maintenance procedure steps, special requirements, safety notes..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('maintModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveMaint()"><i class="fas fa-save"></i> Save Schedule</button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════
     MAINTENANCE LOG COMPLETION MODAL
════════════════════════════════════════════ -->
<div class="modal-overlay" id="maintLogModal">
  <div class="modal" style="width:580px;max-width:96vw">
    <div class="modal-header">
      <i class="fas fa-clipboard-check" style="color:var(--sap-success);font-size:18px"></i>
      <h2 id="maintLogTitle">Log Maintenance Completion</h2>
      <button class="shell-btn" style="color:var(--sap-text-muted)" onclick="closeModal('maintLogModal')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <!-- Task summary banner -->
      <div id="maintLogBanner" style="background:linear-gradient(135deg,#354A5E,#4A6580);color:#fff;border-radius:6px;padding:12px 16px;margin-bottom:4px;display:flex;align-items:center;gap:12px">
        <div style="width:40px;height:40px;background:rgba(255,255,255,.15);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0"><i class="fas fa-tools"></i></div>
        <div>
          <div style="font-weight:700;font-size:14px" id="mlBannerTask">—</div>
          <div style="font-size:12px;opacity:.75" id="mlBannerAsset">—</div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Completion Date <span style="color:var(--sap-error)">*</span></label>
          <input class="form-input" type="date" id="ml_date">
        </div>
        <div class="form-group">
          <label class="form-label">Completed By <span style="color:var(--sap-error)">*</span></label>
          <input class="form-input" id="ml_by" placeholder="Technician name">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Actual Duration (hours)</label>
          <input class="form-input" type="number" id="ml_hours" step="0.5" placeholder="e.g. 3.5">
        </div>
        <div class="form-group">
          <label class="form-label">Actual Cost (USD)</label>
          <input class="form-input" type="number" id="ml_cost" placeholder="e.g. 1200">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Parts / Materials Used</label>
        <input class="form-input" id="ml_parts" placeholder="e.g. Oil filter #OFP-500, 5L engine oil ISO 46…">
      </div>
      <div class="form-group">
        <label class="form-label">Work Performed / Findings</label>
        <textarea class="form-textarea" id="ml_notes" rows="4" placeholder="Describe work performed, findings, any issues discovered..."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Next Due Date (auto-calculated)</label>
        <div style="display:flex;align-items:center;gap:10px">
          <input class="form-input" type="date" id="ml_nextDue" style="flex:1">
          <span style="font-size:12px;color:var(--sap-text-muted)">← override if needed</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('maintLogModal')">Cancel</button>
      <button class="btn btn-success" onclick="saveMaintLog()"><i class="fas fa-check"></i> Mark as Completed & Schedule Next</button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════
     MAINTENANCE HISTORY MODAL
════════════════════════════════════════════ -->
<div class="modal-overlay" id="maintHistoryModal">
  <div class="modal" style="width:680px;max-width:96vw">
    <div class="modal-header">
      <i class="fas fa-history" style="color:var(--sap-blue);font-size:18px"></i>
      <h2 id="maintHistTitle">Maintenance History</h2>
      <button class="shell-btn" style="color:var(--sap-text-muted)" onclick="closeModal('maintHistoryModal')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body" id="maintHistBody" style="padding:0"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('maintHistoryModal')">Close</button>
    </div>
  </div>
</div>

<!-- BOM MODAL -->
<div class="modal-overlay" id="bomModal">
  <div class="modal" style="width:720px">
    <div class="modal-header">
      <i class="fas fa-sitemap" style="color:var(--sap-blue);font-size:18px"></i>
      <h2 id="bomModalTitle">Add BOM Component</h2>
      <button class="shell-btn" style="color:var(--sap-text-muted)" onclick="closeModal('bomModal')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Parent Asset <span style="color:var(--sap-error)">*</span></label>
          <select class="form-select" id="bom_assetId"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Parent Component (optional)</label>
          <select class="form-select" id="bom_parentId">
            <option value="">— Top Level (root) —</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Component Name <span style="color:var(--sap-error)">*</span></label>
          <input class="form-input" id="bom_name" placeholder="e.g. Main Shaft, Bearing Set…">
        </div>
        <div class="form-group">
          <label class="form-label">Part Number</label>
          <input class="form-input" id="bom_partNo" placeholder="PN-XXXXX">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Item Type <span style="color:var(--sap-error)">*</span></label>
          <select class="form-select" id="bom_type" onchange="toggleBulkFields()">
            <option value="Serialized">Serialized (tracked individually)</option>
            <option value="Bulk">Bulk (no serial tracking)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-select" id="bom_status">
            <option>Active</option>
            <option>Inactive</option>
            <option>Obsolete</option>
            <option>On Order</option>
          </select>
        </div>
      </div>
      <!-- Serialized fields -->
      <div id="bom_serialFields">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Serial Number</label>
            <input class="form-input" id="bom_serial" placeholder="SN-XXXXX">
          </div>
          <div class="form-group">
            <label class="form-label">Manufacturer</label>
            <input class="form-input" id="bom_manufacturer" placeholder="e.g. Caterpillar, NOV…">
          </div>
        </div>
      </div>
      <!-- Bulk fields -->
      <div id="bom_bulkFields" style="display:none">
        <div style="background:#FFF3E0;border:1px solid #F5C57A;border-radius:4px;padding:10px 14px;font-size:12.5px;color:#A05000;margin-bottom:10px">
          <i class="fas fa-info-circle"></i> <strong>Bulk Item:</strong> Serial number tracking is not applicable. Quantity management only.
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Quantity <span style="color:var(--sap-error)">*</span></label>
          <input class="form-input" id="bom_qty" type="number" min="0" placeholder="1">
        </div>
        <div class="form-group">
          <label class="form-label">Unit of Measure</label>
          <select class="form-select" id="bom_uom">
            <option>EA</option><option>SET</option><option>KG</option><option>L</option>
            <option>M</option><option>FT</option><option>BOX</option><option>PCS</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Unit Cost (USD)</label>
          <input class="form-input" id="bom_unitCost" type="number" min="0" placeholder="0.00">
        </div>
        <div class="form-group">
          <label class="form-label">Lead Time (days)</label>
          <input class="form-input" id="bom_leadTime" type="number" min="0" placeholder="0">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes / Description</label>
        <textarea class="form-textarea" id="bom_notes" rows="2" placeholder="Technical notes, specification details…"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('bomModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveBomItem()"><i class="fas fa-save"></i> Save Component</button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ══════════════════════════════════
//  DATA
// ══════════════════════════════════
const COMPANIES = [
  { id: 'CMP001', name: 'Arabian Drilling Company', type: 'Drilling Contractor', country: 'Saudi Arabia', contact: 'Khalid Al-Rashid', email: 'k.rashid@adc.com.sa', contracts: 3, status: 'Active' },
  { id: 'CMP002', name: 'NABORS Industries', type: 'Drilling Contractor', country: 'USA', contact: 'James Wilson', email: 'j.wilson@nabors.com', contracts: 2, status: 'Active' },
  { id: 'CMP003', name: 'Patterson-UTI Energy', type: 'Drilling Contractor', country: 'USA', contact: 'Sarah Johnson', email: 's.johnson@patenergy.com', contracts: 1, status: 'Active' },
  { id: 'CMP004', name: 'Al-Khafji Joint Operations', type: 'Operator', country: 'Kuwait', contact: 'Mohammed Al-Khafji', email: 'm.khafji@kjo.com', contracts: 2, status: 'Active' },
  { id: 'CMP005', name: 'Parker Drilling', type: 'Drilling Contractor', country: 'USA', contact: 'Mike Parker', email: 'm.parker@parkerdrilling.com', contracts: 0, status: 'Inactive' },
];

const RIGS = [
  { id:'RIG01', name:'Rig 1',  type:'AC Drive',   company:'Arabian Drilling Company',   location:'Ghawar Field – Block A',      depth:'25,000 ft', hp:2000, status:'Active',      assets:0 },
  { id:'RIG02', name:'Rig 2',  type:'Mechanical', company:'Arabian Drilling Company',   location:'Ghawar Field – Block B',      depth:'20,000 ft', hp:1500, status:'Active',      assets:0 },
  { id:'RIG03', name:'Rig 3',  type:'Electric',   company:'NABORS Industries',          location:'Permian Basin, TX',           depth:'30,000 ft', hp:3000, status:'Active',      assets:0 },
  { id:'RIG04', name:'Rig 4',  type:'SCR',        company:'NABORS Industries',          location:'Permian Basin – South',       depth:'28,000 ft', hp:2500, status:'Maintenance', assets:0 },
  { id:'RIG05', name:'Rig 5',  type:'AC Drive',   company:'Patterson-UTI Energy',       location:'DJ Basin, CO',                depth:'22,000 ft', hp:2000, status:'Active',      assets:0 },
  { id:'RIG06', name:'Rig 6',  type:'SCR',        company:'Patterson-UTI Energy',       location:'Eagle Ford, TX',              depth:'18,000 ft', hp:1500, status:'Active',      assets:0 },
  { id:'RIG07', name:'Rig 7',  type:'Mechanical', company:'Al-Khafji Joint Operations', location:'Khafji Field – North',        depth:'18,000 ft', hp:1200, status:'Active',      assets:0 },
  { id:'RIG08', name:'Rig 8',  type:'AC Drive',   company:'Al-Khafji Joint Operations', location:'Khafji Field – South',        depth:'20,000 ft', hp:1800, status:'Standby',     assets:0 },
  { id:'RIG09', name:'Rig 9',  type:'Electric',   company:'Arabian Drilling Company',   location:'Safaniyah Offshore Tie-in',   depth:'24,000 ft', hp:2200, status:'Active',      assets:0 },
  { id:'RIG10', name:'Rig 10', type:'SCR',        company:'Parker Drilling',            location:'Empty Quarter – Block C',     depth:'26,000 ft', hp:2000, status:'Active',      assets:0 },
  { id:'RIG11', name:'Rig 11', type:'AC Drive',   company:'Parker Drilling',            location:'Empty Quarter – Block D',     depth:'24,000 ft', hp:2000, status:'Maintenance', assets:0 },
  { id:'RIG12', name:'Rig 12', type:'Mechanical', company:'Arabian Drilling Company',   location:'Abqaiq Field',                depth:'21,000 ft', hp:1600, status:'Active',      assets:0 },
  { id:'RIG13', name:'Rig 13', type:'Electric',   company:'NABORS Industries',          location:'Haradh Gas Field',            depth:'32,000 ft', hp:3000, status:'Active',      assets:0 },
  { id:'RIG14', name:'Rig 14', type:'AC Drive',   company:'Patterson-UTI Energy',       location:'Hawiyah Gas Field',           depth:'28,000 ft', hp:2500, status:'Standby',     assets:0 },
];

const CONTRACTS = [
  { id: 'CON-2024-001', company: 'Arabian Drilling Company', rig: 'ADC Rig #7', assetCount: 4, start: '2024-01-15', end: '2025-01-14', value: 4800000, status: 'Active' },
  { id: 'CON-2024-002', company: 'NABORS Industries', rig: 'NABORS 1250-E', assetCount: 3, start: '2024-03-01', end: '2025-03-01', value: 3200000, status: 'Active' },
  { id: 'CON-2024-003', company: 'Al-Khafji Joint Operations', rig: 'KJO Land Rig #3', assetCount: 5, start: '2023-07-01', end: '2024-07-01', value: 6100000, status: 'Expired' },
  { id: 'CON-2025-001', company: 'Patterson-UTI Energy', rig: 'Patterson Rig #55', assetCount: 2, start: '2025-01-10', end: '2026-01-10', value: 1950000, status: 'Pending' },
];

const NOTIFICATIONS = [
  { icon: 'fas fa-exclamation-triangle', type: 'ni-orange', title: 'Contract Expiry Warning', desc: 'ADC Rig #7 contract expires in 15 days (Jan 14, 2025)', time: '2 hours ago', read: false },
  { icon: 'fas fa-tools', type: 'ni-orange', title: 'Maintenance Alert', desc: 'Asset AST-003 (BOP Unit) requires scheduled maintenance', time: '4 hours ago', read: false },
  { icon: 'fas fa-file-import', type: 'ni-blue', title: 'Import Completed', desc: '12 assets imported successfully from Excel file', time: 'Yesterday', read: false },
  { icon: 'fas fa-check-circle', type: 'ni-green', title: 'Asset Activated', desc: 'AST-009 (Top Drive System) has been activated', time: '2 days ago', read: false },
  { icon: 'fas fa-envelope', type: 'ni-blue', title: 'Email Alert Sent', desc: 'Maintenance report sent to 3 recipients', time: '3 days ago', read: true },
];

const USERS = [
  { name: 'Ahmad Mohammed', role: 'Admin', dept: 'Asset Management', email: 'a.mohammed@company.com', color: '#0070F2', initials: 'AM' },
  { name: 'Sara Al-Rashid', role: 'Asset Manager', dept: 'Operations', email: 's.alrashid@company.com', color: '#8B5CF6', initials: 'SR' },
  { name: 'James Miller', role: 'Viewer', dept: 'Finance', email: 'j.miller@company.com', color: '#107E3E', initials: 'JM' },
  { name: 'Layla Hassan', role: 'Editor', dept: 'Contracts', email: 'l.hassan@company.com', color: '#E9730C', initials: 'LH' },
  { name: 'David Chen', role: 'Viewer', dept: 'Engineering', email: 'd.chen@company.com', color: '#B00', initials: 'DC' },
  { name: 'Fatima Al-Zahra', role: 'Editor', dept: 'Maintenance', email: 'f.alzahra@company.com', color: '#0070F2', initials: 'FZ' },
];

let ASSETS = [
  // ─── Rig 1 ───────────────────────────────────────────────────────────────
  { assetId:'AST-001', name:'Top Drive System',          category:'Drilling Equipment', company:'Arabian Drilling Company',   rigName:'Rig 1',  location:'Ghawar Field – Block A',    status:'Contracted', value:1200000, acquisitionDate:'2021-03-15', serial:'TD-7821',  notes:'High-capacity 1000T top drive' },
  { assetId:'AST-002', name:'BOP Stack 18-3/4"',         category:'Drilling Equipment', company:'Arabian Drilling Company',   rigName:'Rig 1',  location:'Ghawar Field – Block A',    status:'Contracted', value:850000,  acquisitionDate:'2020-07-20', serial:'BOP-4422', notes:'Cameron BOP Stack' },
  // ─── Rig 2 ───────────────────────────────────────────────────────────────
  { assetId:'AST-003', name:"Derrick Structure 142'",    category:'Drilling Equipment', company:'Arabian Drilling Company',   rigName:'Rig 2',  location:'Ghawar Field – Block B',    status:'Active',     value:2100000, acquisitionDate:'2018-05-01', serial:'DRK-0078', notes:'IRI 142ft mast structure' },
  { assetId:'AST-004', name:'Mud Pumps (3x)',             category:'Drilling Equipment', company:'Arabian Drilling Company',   rigName:'Rig 2',  location:'Ghawar Field – Block B',    status:'Maintenance',value:620000,  acquisitionDate:'2019-11-05', serial:'MP-1103',  notes:'National 14-P-220 pumps' },
  // ─── Rig 3 ───────────────────────────────────────────────────────────────
  { assetId:'AST-005', name:'Drawworks 1500HP',          category:'Drilling Equipment', company:'NABORS Industries',          rigName:'Rig 3',  location:'Permian Basin, TX',         status:'Active',     value:1800000, acquisitionDate:'2020-08-12', serial:'DW-3312',  notes:'National 1500HP drawworks' },
  { assetId:'AST-006', name:'CAT 3516 Generator Set',    category:'Power Generation',   company:'NABORS Industries',          rigName:'Rig 3',  location:'Permian Basin, TX',         status:'Active',     value:480000,  acquisitionDate:'2022-01-10', serial:'GEN-7712', notes:'2000kW prime power generator' },
  // ─── Rig 4 ───────────────────────────────────────────────────────────────
  { assetId:'AST-007', name:'Casing Running Tool',       category:'Drilling Equipment', company:'NABORS Industries',          rigName:'Rig 4',  location:'Permian Basin – South',     status:'Inactive',   value:130000,  acquisitionDate:'2020-03-15', serial:'CRT-9910', notes:'Hydraulic CRT for 13-3/8" casing' },
  { assetId:'AST-008', name:'H2S Detection System',      category:'Safety Equipment',   company:'NABORS Industries',          rigName:'Rig 4',  location:'Permian Basin – South',     status:'Active',     value:75000,   acquisitionDate:'2022-06-15', serial:'SFT-2291', notes:'Multi-point H2S gas detection' },
  // ─── Rig 5 ───────────────────────────────────────────────────────────────
  { assetId:'AST-009', name:'Rotary Table 37.5"',        category:'Drilling Equipment', company:'Patterson-UTI Energy',       rigName:'Rig 5',  location:'DJ Basin, CO',              status:'Active',     value:320000,  acquisitionDate:'2021-06-20', serial:'RT-5501',  notes:'37.5" rotary table 500T capacity' },
  { assetId:'AST-010', name:'Emergency Fire Suppression',category:'Safety Equipment',   company:'Patterson-UTI Energy',       rigName:'Rig 5',  location:'DJ Basin, CO',              status:'Active',     value:88000,   acquisitionDate:'2023-05-20', serial:'SFT-4451', notes:'Dry chemical fire suppression' },
  // ─── Rig 6 ───────────────────────────────────────────────────────────────
  { assetId:'AST-011', name:'Satellite VSAT System',     category:'Communication',      company:'Patterson-UTI Energy',       rigName:'Rig 6',  location:'Eagle Ford, TX',            status:'Active',     value:145000,  acquisitionDate:'2021-09-01', serial:'COM-8811', notes:'Hughes VSAT 1.8m dish' },
  { assetId:'AST-012', name:'Rig Mover & Substructure',  category:'Drilling Equipment', company:'Patterson-UTI Energy',       rigName:'Rig 6',  location:'Eagle Ford, TX',            status:'Active',     value:950000,  acquisitionDate:'2019-03-10', serial:'RMV-0601', notes:'Self-propelled walking system' },
  // ─── Rig 7 ───────────────────────────────────────────────────────────────
  { assetId:'AST-013', name:'Heavy-Duty Crew Bus',       category:'Transportation',     company:'Al-Khafji Joint Operations', rigName:'Rig 7',  location:'Khafji Field – North',      status:'Active',     value:95000,   acquisitionDate:'2023-02-28', serial:'TRN-0341', notes:'40-seat crew transportation' },
  { assetId:'AST-014', name:'Light Plant System',        category:'Power Generation',   company:'Al-Khafji Joint Operations', rigName:'Rig 7',  location:'Khafji Field – North',      status:'Maintenance',value:42000,   acquisitionDate:'2021-11-15', serial:'LGT-1102', notes:'LED light plants x6' },
  // ─── Rig 8 ───────────────────────────────────────────────────────────────
  { assetId:'AST-015', name:'Drilling Jars – Hydraulic', category:'Drilling Equipment', company:'Al-Khafji Joint Operations', rigName:'Rig 8',  location:'Khafji Field – South',      status:'Active',     value:210000,  acquisitionDate:'2022-12-01', serial:'JAR-3301', notes:'Hydraulic drilling jars set' },
  // ─── Rig 9 ───────────────────────────────────────────────────────────────
  { assetId:'AST-016', name:'Top Drive NOV 500T',        category:'Drilling Equipment', company:'Arabian Drilling Company',   rigName:'Rig 9',  location:'Safaniyah Tie-in',          status:'Active',     value:1050000, acquisitionDate:'2022-04-18', serial:'TD-9901',  notes:'NOV 500T top drive system' },
  { assetId:'AST-017', name:'Accumulator Unit 120 Gal',  category:'Drilling Equipment', company:'Arabian Drilling Company',   rigName:'Rig 9',  location:'Safaniyah Tie-in',          status:'Active',     value:185000,  acquisitionDate:'2021-07-22', serial:'ACC-0091', notes:'120 gal hydraulic accumulator' },
  // ─── Rig 10 ──────────────────────────────────────────────────────────────
  { assetId:'AST-018', name:'Centrifugal Pump Set',      category:'Drilling Equipment', company:'Parker Drilling',            rigName:'Rig 10', location:'Empty Quarter – Block C',   status:'Active',     value:160000,  acquisitionDate:'2023-01-15', serial:'CP-1001',  notes:'3x centrifugal charge pumps' },
  // ─── Rig 11 ──────────────────────────────────────────────────────────────
  { assetId:'AST-019', name:'SCR Control House',         category:'Power Generation',   company:'Parker Drilling',            rigName:'Rig 11', location:'Empty Quarter – Block D',   status:'Maintenance',value:420000,  acquisitionDate:'2020-09-30', serial:'SCR-1101', notes:'Silicon controlled rectifier house' },
  // ─── Rig 12 ──────────────────────────────────────────────────────────────
  { assetId:'AST-020', name:'BOP Annular 13-5/8"',       category:'Drilling Equipment', company:'Arabian Drilling Company',   rigName:'Rig 12', location:'Abqaiq Field',              status:'Active',     value:740000,  acquisitionDate:'2021-02-14', serial:'BOP-1201', notes:'13-5/8" 10K annular BOP' },
  { assetId:'AST-021', name:'Degasser Vessel',           category:'Drilling Equipment', company:'Arabian Drilling Company',   rigName:'Rig 12', location:'Abqaiq Field',              status:'Active',     value:95000,   acquisitionDate:'2022-08-05', serial:'DEG-1201', notes:'Atmospheric degasser 500 GPM' },
  // ─── Rig 13 ──────────────────────────────────────────────────────────────
  { assetId:'AST-022', name:'Iron Roughneck',            category:'Drilling Equipment', company:'NABORS Industries',          rigName:'Rig 13', location:'Haradh Gas Field',          status:'Active',     value:580000,  acquisitionDate:'2022-11-20', serial:'IRN-1301', notes:'Automated iron roughneck 60k ft-lb' },
  // ─── Rig 14 ──────────────────────────────────────────────────────────────
  { assetId:'AST-023', name:'Shale Shaker 4-Panel',      category:'Drilling Equipment', company:'Patterson-UTI Energy',       rigName:'Rig 14', location:'Hawiyah Gas Field',         status:'Standby',    value:220000,  acquisitionDate:'2023-06-01', serial:'SS-1401',  notes:'4-panel linear motion shaker' },
  { assetId:'AST-024', name:'Standby Generator 500kW',   category:'Power Generation',   company:'Patterson-UTI Energy',       rigName:'Rig 14', location:'Hawiyah Gas Field',         status:'Active',     value:195000,  acquisitionDate:'2022-03-10', serial:'GEN-1401', notes:'Emergency standby generator' },
];
// STATE
let filteredAssets = [...ASSETS];
let currentPage = 1;
let pageSize = 50;
let sortKey = '';
let sortDir = 1;
let editingAssetId = null;

// ══════════════════════════════════
//  BOM DATA
//  Each item: { id, assetId, parentId, name, partNo, type:'Serialized'|'Bulk',
//               serial, manufacturer, qty, uom, unitCost, leadTime, status, notes }
// ══════════════════════════════════
let BOM_ITEMS = [
  // ─ AST-001 Top Drive System ──────────────────────────────────
  { id:'BOM-001', assetId:'AST-001', parentId:null,    name:'Top Drive System',         partNo:'TD-7821',    type:'Serialized', serial:'TD-7821-A',  manufacturer:'NOV',         qty:1,   uom:'EA',  unitCost:1200000, leadTime:180, status:'Active',  notes:'Complete top drive assembly 1000T' },
  { id:'BOM-002', assetId:'AST-001', parentId:'BOM-001', name:'Main Electric Motor',    partNo:'MOT-2201',   type:'Serialized', serial:'MOT-2201-X', manufacturer:'Siemens',     qty:2,   uom:'EA',  unitCost:85000,   leadTime:90,  status:'Active',  notes:'AC induction motor 750kW each' },
  { id:'BOM-003', assetId:'AST-001', parentId:'BOM-001', name:'Gearbox Assembly',       partNo:'GBX-5501',   type:'Serialized', serial:'GBX-5501-B', manufacturer:'NOV',         qty:1,   uom:'EA',  unitCost:120000,  leadTime:120, status:'Active',  notes:'2-speed planetary gearbox' },
  { id:'BOM-004', assetId:'AST-001', parentId:'BOM-003', name:'Planetary Gear Set',     partNo:'PGS-3301',   type:'Serialized', serial:'PGS-3301-C', manufacturer:'NOV',         qty:1,   uom:'SET', unitCost:35000,   leadTime:60,  status:'Active',  notes:'Planetary gear set for 2nd stage' },
  { id:'BOM-005', assetId:'AST-001', parentId:'BOM-003', name:'Gear Lubricant ISO 320', partNo:'LUB-ISO320', type:'Bulk',       serial:null,         manufacturer:'Shell',       qty:50,  uom:'L',   unitCost:8,       leadTime:7,   status:'Active',  notes:'Synthetic gear oil ISO VG 320' },
  { id:'BOM-006', assetId:'AST-001', parentId:'BOM-001', name:'Hydraulic Swivel',       partNo:'SWV-0871',   type:'Serialized', serial:'SWV-0871-D', manufacturer:'Smith International', qty:1, uom:'EA', unitCost:95000, leadTime:60, status:'Active', notes:'600 GPM hydraulic swivel' },
  { id:'BOM-007', assetId:'AST-001', parentId:'BOM-001', name:'Hydraulic Seal Kit',     partNo:'SEAL-K201',  type:'Bulk',       serial:null,         manufacturer:'Parker',      qty:5,   uom:'KIT', unitCost:420,     leadTime:14,  status:'Active',  notes:'Annual seal replacement kit' },
  { id:'BOM-008', assetId:'AST-001', parentId:'BOM-001', name:'Pipe Handler Arm',       partNo:'PHA-4410',   type:'Serialized', serial:'PHA-4410-A', manufacturer:'NOV',         qty:1,   uom:'EA',  unitCost:48000,   leadTime:90,  status:'Active',  notes:'Hydraulic pipe handler arm' },
  { id:'BOM-009', assetId:'AST-001', parentId:'BOM-008', name:'Mounting Bolts M42',     partNo:'BOLT-M42',   type:'Bulk',       serial:null,         manufacturer:'Würth',       qty:32,  uom:'PCS', unitCost:12,      leadTime:3,   status:'Active',  notes:'Grade 10.9 hex bolts M42×150' },

  // ─ AST-002 BOP Stack ─────────────────────────────────────────
  { id:'BOM-010', assetId:'AST-002', parentId:null,    name:'BOP Stack 18-3/4"',         partNo:'BOP-4422',   type:'Serialized', serial:'BOP-4422-M', manufacturer:'Cameron',     qty:1,   uom:'EA',  unitCost:850000,  leadTime:365, status:'Active',  notes:'18-3/4" 15K psi BOP Stack' },
  { id:'BOM-011', assetId:'AST-002', parentId:'BOM-010', name:'Annular BOP',             partNo:'ANN-1801',   type:'Serialized', serial:'ANN-1801-A', manufacturer:'Cameron',     qty:1,   uom:'EA',  unitCost:180000,  leadTime:120, status:'Active',  notes:'18-3/4" spherical annular BOP' },
  { id:'BOM-012', assetId:'AST-002', parentId:'BOM-010', name:'Double Ram BOP',          partNo:'RAM-D802',   type:'Serialized', serial:'RAM-D802-B', manufacturer:'Cameron',     qty:1,   uom:'EA',  unitCost:220000,  leadTime:180, status:'Active',  notes:'Double ram BOP 18-3/4" 15K' },
  { id:'BOM-013', assetId:'AST-002', parentId:'BOM-012', name:'Ram Packer Rubber',       partNo:'PKR-5501',   type:'Bulk',       serial:null,         manufacturer:'Cameron',     qty:4,   uom:'EA',  unitCost:3500,    leadTime:30,  status:'Active',  notes:'5" & 5-1/2" combination packer' },
  { id:'BOM-014', assetId:'AST-002', parentId:'BOM-010', name:'BOP Control Unit',        partNo:'BCU-7701',   type:'Serialized', serial:'BCU-7701-C', manufacturer:'Koomey',      qty:1,   uom:'EA',  unitCost:95000,   leadTime:60,  status:'Active',  notes:'Hydraulic BOP control unit' },
  { id:'BOM-015', assetId:'AST-002', parentId:'BOM-014', name:'Hydraulic Fluid MIL-H',   partNo:'HYD-MILH',   type:'Bulk',       serial:null,         manufacturer:'Total',       qty:200, uom:'L',   unitCost:6,       leadTime:5,   status:'Active',  notes:'MIL-H-5606 hydraulic fluid' },

  // ─ AST-003 Mud Pumps ─────────────────────────────────────────
  { id:'BOM-016', assetId:'AST-003', parentId:null,    name:'Mud Pump Assembly (3x)',    partNo:'MP-1103',    type:'Serialized', serial:'MP-1103-SET',manufacturer:'National',     qty:3,   uom:'EA',  unitCost:620000,  leadTime:180, status:'Active',  notes:'National 14-P-220 triplex mud pumps' },
  { id:'BOM-017', assetId:'AST-003', parentId:'BOM-016', name:'Liner Assembly 7"',       partNo:'LNR-7IN',    type:'Serialized', serial:null,         manufacturer:'National',     qty:6,   uom:'EA',  unitCost:4200,    leadTime:21,  status:'Active',  notes:'7" ceramic liner, wear-resistant' },
  { id:'BOM-018', assetId:'AST-003', parentId:'BOM-016', name:'Piston / Rod Assembly',   partNo:'PST-R201',   type:'Serialized', serial:null,         manufacturer:'National',     qty:9,   uom:'EA',  unitCost:1800,    leadTime:14,  status:'Maintenance', notes:'3 per pump, chrome-plated rods' },
  { id:'BOM-019', assetId:'AST-003', parentId:'BOM-016', name:'Valve & Seat Kit',        partNo:'VLV-SK31',   type:'Bulk',       serial:null,         manufacturer:'National',     qty:12,  uom:'SET', unitCost:650,     leadTime:7,   status:'Active',  notes:'Suction & discharge valve kits' },
  { id:'BOM-020', assetId:'AST-003', parentId:'BOM-016', name:'Packing Seal Kit',        partNo:'PCK-S220',   type:'Bulk',       serial:null,         manufacturer:'Garlock',     qty:18,  uom:'KIT', unitCost:280,     leadTime:5,   status:'Active',  notes:'Piston packing sets per pump' },

  // ─ AST-005 Generator ─────────────────────────────────────────
  { id:'BOM-021', assetId:'AST-005', parentId:null,    name:'CAT 3516 Generator Set',    partNo:'GEN-7712',   type:'Serialized', serial:'GEN-7712-A', manufacturer:'Caterpillar', qty:1,   uom:'EA',  unitCost:480000,  leadTime:240, status:'Active',  notes:'2000kW prime power genset' },
  { id:'BOM-022', assetId:'AST-005', parentId:'BOM-021', name:'CAT 3516 Engine Block',   partNo:'ENG-3516B',  type:'Serialized', serial:'3516B-9921', manufacturer:'Caterpillar', qty:1,   uom:'EA',  unitCost:210000,  leadTime:120, status:'Active',  notes:'V16 diesel engine block assembly' },
  { id:'BOM-023', assetId:'AST-005', parentId:'BOM-021', name:'Alternator SR4B',         partNo:'ALT-SR4B',   type:'Serialized', serial:'SR4B-5521',  manufacturer:'Caterpillar', qty:1,   uom:'EA',  unitCost:95000,   leadTime:90,  status:'Active',  notes:'2250 kVA SR4B brushless alternator' },
  { id:'BOM-024', assetId:'AST-005', parentId:'BOM-021', name:'Engine Oil 15W-40',       partNo:'OIL-1540',   type:'Bulk',       serial:null,         manufacturer:'Shell Rimula',qty:300, uom:'L',   unitCost:4.5,     leadTime:2,   status:'Active',  notes:'CAT DEOTF spec diesel engine oil' },
  { id:'BOM-025', assetId:'AST-005', parentId:'BOM-021', name:'Fuel Filter Set',         partNo:'FLT-F401',   type:'Bulk',       serial:null,         manufacturer:'Caterpillar', qty:6,   uom:'EA',  unitCost:85,      leadTime:3,   status:'Active',  notes:'Primary & secondary fuel filters' },
  { id:'BOM-026', assetId:'AST-005', parentId:'BOM-021', name:'Air Filter Assembly',     partNo:'FLT-A201',   type:'Bulk',       serial:null,         manufacturer:'Donaldson',   qty:4,   uom:'EA',  unitCost:120,     leadTime:5,   status:'Active',  notes:'Heavy-duty radial seal air filters' },
];

let editingBomId = null;

// ══════════════════════════════════
//  INIT
// ══════════════════════════════════
window.onload = function() {
  renderNotifications();
  populateCompanyFilters();
  populateFormSelects();
  renderAssets();
  renderContracts();
  renderRigs();
  renderCompanies();
  renderUsers();
  updateKPIs();
  updateReportKPIs();
  populateBomSelects();
  renderBOMSection();
};

// ══════════════════════════════════
//  NAV
// ══════════════════════════════════
function switchTab(id, el) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('section-' + id).classList.add('active');
  el.classList.add('active');
  closeAllPanels();
}

// ══════════════════════════════════
//  FILTERS & SEARCH
// ══════════════════════════════════
function applyFilters() {
  const q    = document.getElementById('searchInput').value.toLowerCase();
  const status = document.getElementById('filterStatus').value;
  const cat  = document.getElementById('filterCategory').value;
  const comp = document.getElementById('filterCompany').value;
  const rig  = document.getElementById('filterRig')?.value || activeAssetRig;
  filteredAssets = ASSETS.filter(a => {
    const matchQ  = !q || a.assetId.toLowerCase().includes(q) || a.name.toLowerCase().includes(q) || a.location.toLowerCase().includes(q) || (a.serial||'').toLowerCase().includes(q);
    const matchS  = !status || a.status === status;
    const matchC  = !cat || a.category === cat;
    const matchCo = !comp || a.company === comp;
    const matchR  = !rig  || a.rigName === rig;
    return matchQ && matchS && matchC && matchCo && matchR;
  });
  currentPage = 1;
  renderAssets();
}

function clearFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('filterStatus').value = '';
  document.getElementById('filterCategory').value = '';
  document.getElementById('filterCompany').value = '';
  const fr = document.getElementById('filterRig'); if (fr) fr.value = '';
  activeAssetRig = '';
  renderAssetRigSelector();
  applyFilters();
}

function applyContractFilters() {
  const q = document.getElementById('contractSearch').value.toLowerCase();
  const status = document.getElementById('contractStatus').value;
  const filtered = CONTRACTS.filter(c => {
    const mq = !q || c.id.toLowerCase().includes(q) || c.company.toLowerCase().includes(q);
    const ms = !status || c.status === status;
    return mq && ms;
  });
  renderContractRows(filtered);
}

// ══════════════════════════════════
//  SORT
// ══════════════════════════════════
function sortTable(key) {
  if (sortKey === key) sortDir *= -1;
  else { sortKey = key; sortDir = 1; }
  filteredAssets.sort((a, b) => {
    let va = a[key], vb = b[key];
    if (key === 'value') { va = Number(va); vb = Number(vb); }
    return va > vb ? sortDir : va < vb ? -sortDir : 0;
  });
  renderAssets();
}

// ══════════════════════════════════
//  RENDER ASSETS TABLE
// ══════════════════════════════════
function renderAssets() {
  const total = filteredAssets.length;
  const start = (currentPage - 1) * pageSize;
  const end = Math.min(start + pageSize, total);
  const page = filteredAssets.slice(start, end);

  const tbody = document.getElementById('assetTbody');
  if (!page.length) {
    tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;padding:40px;color:var(--sap-text-muted)"><i class="fas fa-search" style="font-size:24px;margin-bottom:8px;display:block"></i>No assets found</td></tr>`;
  } else {
    tbody.innerHTML = page.map(a => `
      <tr id="row-${a.assetId}" onclick="handleRowClick(event,'${a.assetId}')">
        <td class="checkbox-cell"><input type="checkbox" onclick="e => e.stopPropagation()"></td>
        <td><span class="tag blue">${a.assetId}</span></td>
        <td style="font-weight:500">${a.name}</td>
        <td>${a.category}</td>
        <td>${a.company}</td>
        <td>${a.rigName}</td>
        <td>${a.location}</td>
        <td>${statusBadge(a.status)}</td>
        <td style="font-family:'IBM Plex Mono',monospace;font-size:12.5px">$${Number(a.value).toLocaleString()}</td>
        <td>${a.acquisitionDate}</td>
        <td onclick="event.stopPropagation()">
          <button class="btn btn-ghost btn-icon" title="View" onclick="openAssetDetail('${a.assetId}')"><i class="fas fa-eye"></i></button>
          <button class="btn btn-ghost btn-icon" title="Edit" onclick="openAddAssetModal('${a.assetId}')"><i class="fas fa-edit"></i></button>
          <button class="btn btn-ghost btn-icon" title="Transfer" style="color:#E9730C" onclick="event.stopPropagation();openTransferModal('${a.assetId}')"><i class="fas fa-exchange-alt"></i></button>
        <button class="btn btn-ghost btn-icon" title="Delete" style="color:var(--sap-error)" onclick="deleteAsset('${a.assetId}')"><i class="fas fa-trash"></i></button>
        </td>
      </tr>`).join('');
  }

  document.getElementById('assetCount').textContent = `(${total} records)`;
  renderPagination(total, start, end);
  updateKPIs();
}

function handleRowClick(e, id) {
  if (e.target.type === 'checkbox' || e.target.closest('button')) return;
  openAssetDetail(id);
}

function statusBadge(s) {
  const map = { Active:'s-active', Inactive:'s-inactive', Maintenance:'s-maintenance', Retired:'s-retired', Contracted:'s-contracted' };
  const icons = { Active:'circle-check', Inactive:'circle', Maintenance:'tools', Retired:'archive', Contracted:'file-contract' };
  return `<span class="status-badge ${map[s]||''}"><i class="fas fa-${icons[s]||'circle'}" style="font-size:10px"></i> ${s}</span>`;
}

// ══════════════════════════════════
//  PAGINATION
// ══════════════════════════════════
function renderPagination(total, start, end) {
  const pages = Math.ceil(total / pageSize);
  document.getElementById('pagInfo').textContent = `Showing ${start+1}–${end} of ${total}`;
  const pgDiv = document.getElementById('pagPages');
  pgDiv.innerHTML = '';
  for (let i = 1; i <= Math.min(pages, 7); i++) {
    const btn = document.createElement('button');
    btn.className = 'pag-btn' + (i === currentPage ? ' active' : '');
    btn.textContent = i;
    btn.onclick = () => { currentPage = i; renderAssets(); };
    pgDiv.appendChild(btn);
  }
  document.getElementById('btnPrev').disabled = currentPage <= 1;
  document.getElementById('btnNext').disabled = currentPage >= pages;
}
function changePage(d) { currentPage += d; renderAssets(); }
function changePageSize() { pageSize = parseInt(document.getElementById('pageSize').value); currentPage = 1; renderAssets(); }

// ══════════════════════════════════
//  SELECT ALL
// ══════════════════════════════════
function toggleSelectAll(cb) {
  document.querySelectorAll('#assetTbody input[type=checkbox]').forEach(c => c.checked = cb.checked);
}

// ══════════════════════════════════
//  KPIs
// ══════════════════════════════════
function updateKPIs() {
  document.getElementById('kpiTotal').textContent = ASSETS.length;
  document.getElementById('kpiActive').textContent = ASSETS.filter(a=>a.status==='Active').length;
  document.getElementById('kpiMaint').textContent = ASSETS.filter(a=>a.status==='Maintenance').length;
  document.getElementById('kpiContract').textContent = ASSETS.filter(a=>a.status==='Contracted').length;
}
function updateReportKPIs() {
  const total = ASSETS.reduce((s,a) => s+Number(a.value),0);
  document.getElementById('rptValue').textContent = '$' + (total/1000000).toFixed(1) + 'M';
  document.getElementById('rptContracts').textContent = CONTRACTS.filter(c=>c.status==='Active').length;
  document.getElementById('rptRigs').textContent = RIGS.filter(r=>r.status==='Active').length;
}

// ══════════════════════════════════
//  ASSET DETAIL POPUP
// ══════════════════════════════════
let currentAsset = null;
function openAssetDetail(id) {
  const a = ASSETS.find(x=>x.assetId===id);
  if (!a) return;
  currentAsset = a;
  document.getElementById('popupTitle').textContent = a.name;
  document.getElementById('popupSub').textContent = `${a.assetId} · ${a.category} · ${a.company}`;
  document.getElementById('popupStatus').innerHTML = statusBadge(a.status);

  const contract = CONTRACTS.find(c => c.company === a.company && c.rig === a.rigName);
  const rig = RIGS.find(r => r.name === a.rigName);

  document.getElementById('popupGeneralGrid').innerHTML = fields([
    ['Asset ID', a.assetId, true], ['Asset Name', a.name], ['Category', a.category],
    ['Status', statusBadge(a.status)], ['Company', a.company], ['Location', a.location],
    ['Value (USD)', '$'+Number(a.value).toLocaleString(), true], ['Acquisition Date', a.acquisitionDate], ['Notes', a.notes||'—'],
  ]);
  document.getElementById('popupTechGrid').innerHTML = fields([
    ['Serial Number', a.serial, true], ['Rig Assignment', a.rigName], ['Last Updated', '2024-12-01'],
  ]);

  // Contract tab
  if (contract) {
    document.getElementById('popupContractInfo').innerHTML = `
      <div class="detail-grid">
        ${fields([
          ['Contract ID', contract.id, true], ['Company', contract.company], ['Rig', contract.rig],
          ['Start Date', contract.start], ['End Date', contract.end], ['Contract Value', '$'+Number(contract.value).toLocaleString(), true],
          ['Status', statusBadge(contract.status)], ['Asset Count', contract.assetCount],
        ])}
      </div>`;
  } else {
    document.getElementById('popupContractInfo').innerHTML = '<p style="color:var(--sap-text-muted);font-size:13px">No active contract associated with this asset.</p>';
  }

  // Rig tab
  if (rig) {
    document.getElementById('popupRigInfo').innerHTML = `
      <div class="detail-grid">
        ${fields([
          ['Rig ID', rig.id, true], ['Rig Name', rig.name], ['Type', rig.type],
          ['Company', rig.company], ['Location', rig.location], ['Depth Capacity', rig.depth],
          ['Status', statusBadge(rig.status)],
        ])}
      </div>`;
  } else {
    document.getElementById('popupRigInfo').innerHTML = '<p style="color:var(--sap-text-muted);font-size:13px">No rig information available.</p>';
  }

  // History
  document.getElementById('popupHistoryTbody').innerHTML = [
    ['2024-12-01','Status changed to '+a.status,'Ahmad Mohammed','—'],
    ['2024-11-15','Assigned to '+a.rigName,'Sara Al-Rashid','Per contract CON-2024-001'],
    ['2024-06-01','Value updated','James Miller','Annual revaluation'],
    ['2023-01-01','Asset created','Ahmad Mohammed','Initial registration'],
  ].map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('');

  // Render BOM tab
  renderPopupBOM(a.assetId);

  switchPopupTab('general', document.querySelector('.popup-tab'));
  openModal('assetDetailModal');
}

function fields(arr) {
  return arr.map(([label, val, mono]) => `
    <div class="detail-field">
      <div class="detail-label">${label}</div>
      <div class="detail-value ${mono?'mono':''}">${val||'—'}</div>
    </div>`).join('');
}

function switchPopupTab(id, el) {
  document.querySelectorAll('.popup-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.popup-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('ps-'+id).classList.add('active');
  if (el) el.classList.add('active');
  else document.querySelector(`.popup-tab[onclick*="${id}"]`)?.classList.add('active');
}

function editCurrentAsset() {
  closeModal('assetDetailModal');
  if (currentAsset) openAddAssetModal(currentAsset.assetId);
}

// ══════════════════════════════════
//  ADD / EDIT ASSET
// ══════════════════════════════════
function openAddAssetModal(id) {
  editingAssetId = id || null;
  const modal = document.getElementById('addAssetModal');
  if (id) {
    const a = ASSETS.find(x=>x.assetId===id);
    if (!a) return;
    document.getElementById('addAssetTitle').textContent = 'Edit Asset';
    document.getElementById('f_assetId').value = a.assetId;
    document.getElementById('f_name').value = a.name;
    document.getElementById('f_category').value = a.category;
    document.getElementById('f_status').value = a.status;
    document.getElementById('f_company').value = a.company;
    document.getElementById('f_rig').value = a.rigName;
    document.getElementById('f_location').value = a.location;
    document.getElementById('f_value').value = a.value;
    document.getElementById('f_date').value = a.acquisitionDate;
    document.getElementById('f_serial').value = a.serial;
    document.getElementById('f_notes').value = a.notes;
  } else {
    document.getElementById('addAssetTitle').textContent = 'New Asset';
    document.getElementById('f_assetId').value = 'AST-' + String(ASSETS.length+1).padStart(3,'0');
    ['f_name','f_location','f_value','f_date','f_serial','f_notes'].forEach(f=>document.getElementById(f).value='');
  }
  openModal('addAssetModal');
}

function saveAsset() {
  const assetId = document.getElementById('f_assetId').value.trim();
  const name = document.getElementById('f_name').value.trim();
  if (!assetId || !name) { showToast('Please fill required fields.', 'error'); return; }
  const data = {
    assetId, name,
    category: document.getElementById('f_category').value,
    status: document.getElementById('f_status').value,
    company: document.getElementById('f_company').value,
    rigName: document.getElementById('f_rig').value,
    location: document.getElementById('f_location').value,
    value: Number(document.getElementById('f_value').value)||0,
    acquisitionDate: document.getElementById('f_date').value,
    serial: document.getElementById('f_serial').value,
    notes: document.getElementById('f_notes').value,
  };
  if (editingAssetId) {
    const idx = ASSETS.findIndex(a=>a.assetId===editingAssetId);
    if (idx>=0) ASSETS[idx] = data;
    showToast('Asset updated successfully.', 'success');
  } else {
    ASSETS.push(data);
    showToast('Asset created successfully.', 'success');
  }
  closeModal('addAssetModal');
  applyFilters();
}

function deleteAsset(id) {
  if (!confirm('Delete asset ' + id + '?')) return;
  ASSETS = ASSETS.filter(a=>a.assetId!==id);
  filteredAssets = filteredAssets.filter(a=>a.assetId!==id);
  renderAssets();
  showToast('Asset ' + id + ' deleted.', 'warning');
}

// ══════════════════════════════════
//  POPULATE SELECTS
// ══════════════════════════════════
function populateCompanyFilters() {
  const sel = document.getElementById('filterCompany');
  COMPANIES.forEach(c => { const o = new Option(c.name, c.name); sel.appendChild(o); });
  // Populate rig filter dropdown (Assets tab)
  const rSel = document.getElementById('filterRig');
  if (rSel) RIGS.forEach(r => rSel.appendChild(new Option(r.name, r.name)));
  // Populate rig filter dropdown (Maintenance tab)
  const mrSel = document.getElementById('mFilterRig');
  if (mrSel) RIGS.forEach(r => mrSel.appendChild(new Option(r.name, r.name)));
}
function populateFormSelects() {
  const compSel = document.getElementById('f_company');
  COMPANIES.forEach(c => compSel.appendChild(new Option(c.name, c.name)));
  const rigSel = document.getElementById('f_rig');
  RIGS.forEach(r => rigSel.appendChild(new Option(r.name, r.name)));
}

// ══════════════════════════════════
//  RENDER CONTRACTS
// ══════════════════════════════════
function renderContracts() { renderContractRows(CONTRACTS); }
function renderContractRows(list) {
  document.getElementById('contractTbody').innerHTML = list.map(c=>`
    <tr>
      <td><span class="tag blue">${c.id}</span></td>
      <td>${c.company}</td>
      <td>${c.rig}</td>
      <td>${c.assetCount}</td>
      <td>${c.start}</td>
      <td>${c.end}</td>
      <td style="font-family:'IBM Plex Mono',monospace;font-size:12.5px">$${Number(c.value).toLocaleString()}</td>
      <td>${statusBadge(c.status)}</td>
      <td><button class="btn btn-ghost btn-icon"><i class="fas fa-eye"></i></button><button class="btn btn-ghost btn-icon"><i class="fas fa-edit"></i></button></td>
    </tr>`).join('');
}

// ══════════════════════════════════
//  RENDER RIGS
// ══════════════════════════════════
function renderRigs() {
  document.getElementById('rigTbody').innerHTML = RIGS.map(r=>`
    <tr>
      <td><span class="tag">${r.id}</span></td>
      <td style="font-weight:500">${r.name}</td>
      <td>${r.type}</td>
      <td>${r.company}</td>
      <td>${r.location}</td>
      <td>${r.depth}</td>
      <td>${statusBadge(r.status)}</td>
      <td>${ASSETS.filter(a=>a.rigName===r.name).length}</td>
      <td><button class="btn btn-ghost btn-icon"><i class="fas fa-eye"></i></button><button class="btn btn-ghost btn-icon"><i class="fas fa-edit"></i></button></td>
    </tr>`).join('');
}

// ══════════════════════════════════
//  RENDER COMPANIES
// ══════════════════════════════════
function renderCompanies() {
  document.getElementById('companyTbody').innerHTML = COMPANIES.map(c=>`
    <tr>
      <td><span class="tag">${c.id}</span></td>
      <td style="font-weight:500">${c.name}</td>
      <td>${c.type}</td>
      <td>${c.country}</td>
      <td>${c.contact}</td>
      <td>${c.email}</td>
      <td>${c.contracts}</td>
      <td>${statusBadge(c.status)}</td>
    </tr>`).join('');
}

// ══════════════════════════════════
//  RENDER USERS
// ══════════════════════════════════
function renderUsers() {
  document.getElementById('userGrid').innerHTML = USERS.map(u=>`
    <div class="user-card">
      <div class="user-avatar-lg" style="background:${u.color};color:#fff">${u.initials}</div>
      <div>
        <div style="font-weight:600;font-size:14px">${u.name}</div>
        <div style="font-size:12px;color:var(--sap-text-muted)">${u.role} · ${u.dept}</div>
        <div style="font-size:12px;margin-top:4px">${u.email}</div>
        <div style="margin-top:8px;display:flex;gap:6px">
          <button class="btn btn-secondary" style="height:26px;font-size:11.5px"><i class="fas fa-edit"></i> Edit</button>
          <button class="btn btn-ghost" style="height:26px;font-size:11.5px"><i class="fas fa-envelope"></i></button>
        </div>
      </div>
    </div>`).join('');
}

// ══════════════════════════════════
//  NOTIFICATIONS
// ══════════════════════════════════
function renderNotifications() {
  document.getElementById('notifList').innerHTML = NOTIFICATIONS.map((n,i)=>`
    <div class="notif-item ${n.read?'':'unread'}" onclick="markRead(${i})">
      <div class="notif-icon-wrap ${n.type}"><i class="${n.icon}"></i></div>
      <div class="notif-body">
        <div class="notif-title">${n.title}</div>
        <div class="notif-desc">${n.desc}</div>
        <div class="notif-time">${n.time}</div>
      </div>
    </div>`).join('');
  const unread = NOTIFICATIONS.filter(n=>!n.read).length;
  const badge = document.getElementById('notifBadge');
  badge.textContent = unread;
  badge.style.display = unread ? '' : 'none';
}
function markRead(i) { NOTIFICATIONS[i].read = true; renderNotifications(); }
function markAllRead() { NOTIFICATIONS.forEach(n=>n.read=true); renderNotifications(); }
function toggleNotif() {
  const p = document.getElementById('notifPanel');
  p.classList.toggle('open');
  document.getElementById('userMenu').classList.remove('open');
}

// ══════════════════════════════════
//  EMAIL MODAL
// ══════════════════════════════════
function openEmailModal() { openModal('emailModal'); }
function closeEmailModal() { closeModal('emailModal'); }
function sendEmail() {
  const to = document.getElementById('emailTo').value;
  const subject = document.getElementById('emailSubject').value;
  if (!to || !subject) { showToast('Please fill in recipient and subject.', 'error'); return; }
  closeEmailModal();
  showToast('Email alert sent to ' + to.split(';').length + ' recipient(s).', 'success');
  NOTIFICATIONS.unshift({ icon:'fas fa-envelope', type:'ni-blue', title:'Email Alert Sent', desc:'Alert "'+subject+'" was sent.', time:'Just now', read:false });
  renderNotifications();
}
function updateEmailBody() {
  const type = document.getElementById('emailType').value;
  const templates = {
    'Asset Status Change': 'Dear Team,\n\nAn asset status has been changed in the SAP Asset Management System.\nPlease review the attached report for details.\n\nRegards,\nAsset Management System',
    'Contract Expiry Warning': 'Dear Team,\n\nA contract is approaching its expiry date. Please review and renew if necessary.\n\nAffected Contract: [Contract ID]\nExpiry Date: [Date]\n\nRegards,\nAsset Management System',
    'Maintenance Required': 'Dear Maintenance Team,\n\nThe following asset requires immediate maintenance attention.\n\nAsset: [Asset Name]\nIssue: [Issue Description]\n\nPlease schedule maintenance accordingly.\n\nRegards,\nAsset Management System',
    'New Asset Assigned': 'Dear Team,\n\nA new asset has been assigned and is ready for operation.\n\nPlease review the attached asset details.\n\nRegards,\nAsset Management System',
    'Custom Message': '',
  };
  document.getElementById('emailBody').value = templates[type] || '';
}

// ══════════════════════════════════
//  EXPORT / IMPORT
// ══════════════════════════════════
function exportAssets() {
  const ws = XLSX.utils.json_to_sheet(ASSETS.map(a=>({
    'Asset ID': a.assetId, 'Name': a.name, 'Category': a.category,
    'Company': a.company, 'Rig': a.rigName, 'Location': a.location,
    'Status': a.status, 'Value (USD)': a.value,
    'Acquisition Date': a.acquisitionDate, 'Serial': a.serial, 'Notes': a.notes
  })));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Assets');
  XLSX.writeFile(wb, 'Asset_List_Export.xlsx');
  showToast('Assets exported to Excel successfully.', 'success');
}

function exportContracts() {
  const ws = XLSX.utils.json_to_sheet(CONTRACTS.map(c=>({
    'Contract ID':c.id,'Company':c.company,'Rig':c.rig,'Assets':c.assetCount,
    'Start':c.start,'End':c.end,'Value':c.value,'Status':c.status
  })));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Contracts');
  XLSX.writeFile(wb, 'Contracts_Export.xlsx');
  showToast('Contracts exported to Excel successfully.', 'success');
}

function importAssets(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(e.target.result, { type: 'binary' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws);
      let added = 0;
      rows.forEach(r => {
        const id = r['Asset ID'] || ('IMP-' + Date.now());
        if (!ASSETS.find(a=>a.assetId===id)) {
          ASSETS.push({
            assetId: id, name: r['Name']||'Imported Asset',
            category: r['Category']||'Drilling Equipment',
            company: r['Company']||'', rigName: r['Rig']||'',
            location: r['Location']||'', status: r['Status']||'Inactive',
            value: Number(r['Value (USD)'])||0,
            acquisitionDate: r['Acquisition Date']||'',
            serial: r['Serial']||'', notes: r['Notes']||''
          });
          added++;
        }
      });
      applyFilters();
      showToast(`${added} assets imported successfully.`, 'success');
      NOTIFICATIONS.unshift({ icon:'fas fa-file-import', type:'ni-blue', title:'Import Completed', desc:`${added} assets imported from ${file.name}`, time:'Just now', read:false });
      renderNotifications();
    } catch(err) {
      showToast('Import failed: ' + err.message, 'error');
    }
  };
  reader.readAsBinaryString(file);
  event.target.value = '';
}

// ══════════════════════════════════
//  MODAL HELPERS
// ══════════════════════════════════
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function toggleUserMenu() {
  document.getElementById('userMenu').classList.toggle('open');
  document.getElementById('notifPanel').classList.remove('open');
}
function closeAllPanels() {
  document.getElementById('notifPanel').classList.remove('open');
  document.getElementById('userMenu').classList.remove('open');
}

// Close panels on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.shell-btn') && !e.target.closest('.user-avatar') && !e.target.closest('.notif-panel') && !e.target.closest('.user-menu')) {
    document.getElementById('notifPanel').classList.remove('open');
    document.getElementById('userMenu').classList.remove('open');
  }
});
// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', function(e) { if (e.target === o) o.classList.remove('open'); });
});

// ══════════════════════════════════════════════════════════════
//  BOM FUNCTIONS
// ══════════════════════════════════════════════════════════════

function populateBomSelects() {
  // Asset filter dropdown in BOM section
  const bomFilterAsset = document.getElementById('bomFilterAsset');
  bomFilterAsset.innerHTML = '<option value="">All Assets</option>';
  ASSETS.forEach(a => bomFilterAsset.appendChild(new Option(`${a.assetId} – ${a.name}`, a.assetId)));

  // Asset selector in BOM modal
  const bomAssetSel = document.getElementById('bom_assetId');
  bomAssetSel.innerHTML = '<option value="">— Select Asset —</option>';
  ASSETS.forEach(a => bomAssetSel.appendChild(new Option(`${a.assetId} – ${a.name}`, a.assetId)));
  bomAssetSel.onchange = () => populateBomParentSelect(bomAssetSel.value);
}

function populateBomParentSelect(assetId) {
  const sel = document.getElementById('bom_parentId');
  sel.innerHTML = '<option value="">— Top Level (root) —</option>';
  if (!assetId) return;
  // Only allow serialized items as parents (can't put children under Bulk)
  BOM_ITEMS
    .filter(b => b.assetId === assetId && b.type === 'Serialized')
    .forEach(b => {
      const indent = '  '.repeat(getBomDepth(b.id));
      sel.appendChild(new Option(indent + b.name + ' (' + b.partNo + ')', b.id));
    });
}

function getBomDepth(id, depth = 0) {
  const item = BOM_ITEMS.find(b => b.id === id);
  if (!item || !item.parentId) return depth;
  return getBomDepth(item.parentId, depth + 1);
}

function toggleBulkFields() {
  const isBulk = document.getElementById('bom_type').value === 'Bulk';
  document.getElementById('bom_serialFields').style.display = isBulk ? 'none' : '';
  document.getElementById('bom_bulkFields').style.display = isBulk ? '' : 'none';
  if (isBulk) {
    document.getElementById('bom_serial').value = '';
  }
}

// ── Open BOM modal ───────────────────────────────────────────
function openBomModal(assetId = null, editId = null) {
  editingBomId = editId;
  populateBomSelects();

  if (editId) {
    const b = BOM_ITEMS.find(x => x.id === editId);
    if (!b) return;
    document.getElementById('bomModalTitle').textContent = 'Edit BOM Component';
    document.getElementById('bom_assetId').value = b.assetId;
    populateBomParentSelect(b.assetId);
    document.getElementById('bom_parentId').value = b.parentId || '';
    document.getElementById('bom_name').value = b.name;
    document.getElementById('bom_partNo').value = b.partNo || '';
    document.getElementById('bom_type').value = b.type;
    document.getElementById('bom_serial').value = b.serial || '';
    document.getElementById('bom_manufacturer').value = b.manufacturer || '';
    document.getElementById('bom_qty').value = b.qty || 1;
    document.getElementById('bom_uom').value = b.uom || 'EA';
    document.getElementById('bom_unitCost').value = b.unitCost || 0;
    document.getElementById('bom_leadTime').value = b.leadTime || 0;
    document.getElementById('bom_status').value = b.status || 'Active';
    document.getElementById('bom_notes').value = b.notes || '';
    toggleBulkFields();
  } else {
    document.getElementById('bomModalTitle').textContent = 'Add BOM Component';
    ['bom_name','bom_partNo','bom_serial','bom_manufacturer','bom_notes'].forEach(f => document.getElementById(f).value = '');
    document.getElementById('bom_qty').value = 1;
    document.getElementById('bom_unitCost').value = '';
    document.getElementById('bom_leadTime').value = '';
    document.getElementById('bom_type').value = 'Serialized';
    document.getElementById('bom_status').value = 'Active';
    document.getElementById('bom_uom').value = 'EA';
    if (assetId) {
      document.getElementById('bom_assetId').value = assetId;
      populateBomParentSelect(assetId);
    }
    toggleBulkFields();
  }
  openModal('bomModal');
}

// ── Save BOM item ─────────────────────────────────────────────
function saveBomItem() {
  const assetId = document.getElementById('bom_assetId').value;
  const name    = document.getElementById('bom_name').value.trim();
  const type    = document.getElementById('bom_type').value;
  const qty     = parseFloat(document.getElementById('bom_qty').value) || 0;

  if (!assetId || !name) { showToast('Asset and Component Name are required.', 'error'); return; }
  if (qty <= 0) { showToast('Quantity must be greater than 0.', 'error'); return; }

  const isBulk = type === 'Bulk';
  const data = {
    assetId,
    parentId:     document.getElementById('bom_parentId').value || null,
    name,
    partNo:       document.getElementById('bom_partNo').value.trim() || null,
    type,
    serial:       isBulk ? null : (document.getElementById('bom_serial').value.trim() || null),
    manufacturer: document.getElementById('bom_manufacturer').value.trim() || null,
    qty,
    uom:          document.getElementById('bom_uom').value,
    unitCost:     parseFloat(document.getElementById('bom_unitCost').value) || 0,
    leadTime:     parseInt(document.getElementById('bom_leadTime').value) || 0,
    status:       document.getElementById('bom_status').value,
    notes:        document.getElementById('bom_notes').value.trim() || null,
  };

  if (editingBomId) {
    const idx = BOM_ITEMS.findIndex(b => b.id === editingBomId);
    if (idx >= 0) { BOM_ITEMS[idx] = { ...BOM_ITEMS[idx], ...data }; }
    showToast('BOM component updated.', 'success');
  } else {
    const newId = 'BOM-' + String(Date.now()).slice(-6);
    BOM_ITEMS.push({ id: newId, ...data });
    showToast('BOM component added.', 'success');
  }

  closeModal('bomModal');
  renderBOMSection();
  if (currentAsset) renderPopupBOM(currentAsset.assetId);
  populateBomSelects();
}

// ── Delete BOM item (and its children) ───────────────────────
function deleteBomItem(id) {
  const item = BOM_ITEMS.find(b => b.id === id);
  const children = BOM_ITEMS.filter(b => b.parentId === id);
  const childMsg = children.length ? ` This will also delete ${children.length} child component(s).` : '';
  if (!confirm(`Delete "${item?.name}"?${childMsg}`)) return;

  // Recursively collect all descendant IDs
  function collectIds(pid) {
    const ids = [pid];
    BOM_ITEMS.filter(b => b.parentId === pid).forEach(c => ids.push(...collectIds(c.id)));
    return ids;
  }
  const toDelete = collectIds(id);
  BOM_ITEMS = BOM_ITEMS.filter(b => !toDelete.includes(b.id));

  showToast(`Deleted "${item?.name}" and ${toDelete.length - 1} sub-component(s).`, 'warning');
  renderBOMSection();
  if (currentAsset) renderPopupBOM(currentAsset.assetId);
  populateBomSelects();
}

// ── Build tree structure ──────────────────────────────────────
function buildBomTree(items, parentId = null) {
  return items
    .filter(b => b.parentId === parentId)
    .map(b => ({ ...b, children: buildBomTree(items, b.id) }));
}

// ── Render a single BOM row ───────────────────────────────────
function renderBomRow(item, level, compact = false) {
  const isBulk = item.type === 'Bulk';
  const hasChildren = BOM_ITEMS.some(b => b.parentId === item.id);
  const totalCost = (item.unitCost || 0) * (item.qty || 0);

  const statusColors = { Active:'s-active', Inactive:'s-inactive', Obsolete:'s-retired', 'On Order':'s-maintenance' };
  const typeClass = isBulk ? 'bulk' : 'serialized';
  const typeLabel = isBulk ? '<i class="fas fa-boxes"></i> Bulk' : '<i class="fas fa-barcode"></i> Serialized';

  const toggleBtn = hasChildren
    ? `<span class="bom-toggle open" onclick="toggleBomNode(this,'${item.id}')"><i class="fas fa-chevron-right"></i></span>`
    : `<span style="width:16px;display:inline-block"></span>`;

  const itemIcon = level === 0
    ? `<i class="fas fa-cube" style="color:var(--sap-blue)"></i>`
    : isBulk
      ? `<i class="fas fa-boxes" style="color:#A05000;font-size:11px"></i>`
      : `<i class="fas fa-cog" style="color:var(--sap-text-muted);font-size:11px"></i>`;

  return `<div class="bom-row level-${Math.min(level, 3)}" data-bom-id="${item.id}" data-parent="${item.parentId||''}">
    <div class="bom-indent level-${Math.min(level,3)}">
      ${toggleBtn}
      ${itemIcon}
      <div>
        <div style="font-weight:${level===0?'700':'500'}">${item.name}</div>
        ${item.serial ? `<div style="font-size:11px;color:var(--sap-text-muted);font-family:'IBM Plex Mono',monospace">${item.serial}</div>` : ''}
        ${item.manufacturer ? `<div style="font-size:11px;color:var(--sap-text-muted)">${item.manufacturer}</div>` : ''}
      </div>
    </div>
    <div class="bom-cell w120 mono">${item.partNo || '<span style="color:#ccc">—</span>'}</div>
    <div class="bom-cell w80"><span class="bom-bulk-badge ${typeClass}">${typeLabel}</span></div>
    <div class="bom-cell w80 mono">${item.qty}</div>
    <div class="bom-cell w90">${item.uom || 'EA'}</div>
    <div class="bom-cell w120 mono">${item.unitCost ? '$'+Number(item.unitCost).toLocaleString() : '<span style="color:#ccc">—</span>'}</div>
    <div class="bom-cell w120 mono" style="font-weight:600">${totalCost ? '$'+Number(totalCost).toLocaleString() : '<span style="color:#ccc">—</span>'}</div>
    <div class="bom-cell w90"><span class="status-badge ${statusColors[item.status]||'s-inactive'}" style="font-size:11px">${item.status}</span></div>
    <div class="bom-cell" style="width:${compact?'80':'100'}px;display:flex;gap:2px">
      ${!isBulk && !hasChildren ? `<button class="btn btn-ghost btn-icon" title="Add child component" onclick="openBomModal('${item.assetId}'); document.getElementById('bom_parentId').value='${item.id}';" style="height:26px;width:26px;font-size:11px"><i class="fas fa-plus"></i></button>` : ''}
      <button class="btn btn-ghost btn-icon" title="Edit" onclick="openBomModal(null,'${item.id}')" style="height:26px;width:26px;font-size:11px"><i class="fas fa-edit"></i></button>
      <button class="btn btn-ghost btn-icon" title="Delete" style="color:var(--sap-error);height:26px;width:26px;font-size:11px" onclick="deleteBomItem('${item.id}')"><i class="fas fa-trash"></i></button>
    </div>
  </div>`;
}

// ── Flatten tree to rows with levels ─────────────────────────
function flattenTree(nodes, level = 0) {
  let rows = '';
  nodes.forEach(node => {
    rows += renderBomRow(node, level);
    if (node.children && node.children.length) {
      rows += `<div data-children-of="${node.id}">`;
      rows += flattenTree(node.children, level + 1);
      rows += `</div>`;
    }
  });
  return rows;
}

// ── Toggle collapse/expand ────────────────────────────────────
function toggleBomNode(btn, id) {
  const childDiv = btn.closest('[data-bom-id]').parentElement.querySelector(`[data-children-of="${id}"]`);
  if (!childDiv) return;
  const isOpen = childDiv.style.display !== 'none';
  childDiv.style.display = isOpen ? 'none' : '';
  btn.classList.toggle('open', !isOpen);
}

// ── Render BOM in the BOM section tab ────────────────────────
function renderBOMSection() {
  const q          = (document.getElementById('bomSearch')?.value || '').toLowerCase();
  const assetFilter = document.getElementById('bomFilterAsset')?.value;
  const typeFilter  = document.getElementById('bomFilterType')?.value;

  let items = BOM_ITEMS.filter(b => {
    const mq  = !q || b.name.toLowerCase().includes(q) || (b.partNo||'').toLowerCase().includes(q) || (b.serial||'').toLowerCase().includes(q);
    const ma  = !assetFilter || b.assetId === assetFilter;
    const mt  = !typeFilter  || b.type === typeFilter;
    return mq && ma && mt;
  });

  // Group by asset
  const assetIds = [...new Set(items.map(b => b.assetId))];
  let html = '';
  assetIds.forEach(aid => {
    const asset = ASSETS.find(a => a.assetId === aid);
    const assetItems = items.filter(b => b.assetId === aid);
    const tree = buildBomTree(assetItems);
    const totalCost = assetItems.reduce((s, b) => s + (b.unitCost||0)*(b.qty||0), 0);
    const bulkCount = assetItems.filter(b=>b.type==='Bulk').length;
    const serialCount = assetItems.filter(b=>b.type==='Serialized').length;

    html += `<div style="border-bottom:3px solid var(--sap-blue);margin-bottom:2px">
      <div style="background:linear-gradient(135deg,#354A5E,#4A6580);color:#fff;padding:10px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <i class="fas fa-warehouse"></i>
        <span style="font-weight:700">${asset ? asset.name : aid}</span>
        <span class="tag" style="background:rgba(255,255,255,0.15);color:#fff;font-size:11px">${aid}</span>
        <div style="flex:1"></div>
        <span style="font-size:12px;opacity:0.8"><i class="fas fa-barcode"></i> ${serialCount} Serialized</span>
        <span style="font-size:12px;opacity:0.8"><i class="fas fa-boxes"></i> ${bulkCount} Bulk</span>
        <span style="font-size:12px;font-weight:700;font-family:'IBM Plex Mono',monospace">Total: $${Number(totalCost).toLocaleString()}</span>
        <button class="btn" style="height:26px;font-size:11.5px;background:rgba(255,255,255,0.15);color:#fff;border:1px solid rgba(255,255,255,0.3)" onclick="openBomModal('${aid}')"><i class="fas fa-plus"></i> Add</button>
      </div>
      ${flattenTree(tree)}
    </div>`;
  });

  if (!html) {
    html = `<div style="text-align:center;padding:60px;color:var(--sap-text-muted)">
      <i class="fas fa-sitemap" style="font-size:36px;opacity:0.3;margin-bottom:12px;display:block"></i>
      No BOM items found. Add components to an asset to get started.
    </div>`;
  }

  document.getElementById('bomSectionTree').innerHTML = html;
  document.getElementById('bomCount').textContent = `(${BOM_ITEMS.length} components)`;
}

// ── Render BOM inside asset popup ────────────────────────────
function renderPopupBOM(assetId) {
  const items = BOM_ITEMS.filter(b => b.assetId === assetId);
  const tree  = buildBomTree(items);
  const totalCost   = items.reduce((s,b) => s + (b.unitCost||0)*(b.qty||0), 0);
  const bulkCount   = items.filter(b=>b.type==='Bulk').length;
  const serialCount = items.filter(b=>b.type==='Serialized').length;
  const onOrder     = items.filter(b=>b.status==='On Order').length;

  document.getElementById('popupBomSummary').innerHTML = `
    <div class="bom-summary-item"><div class="bom-summary-label">Total Components</div><div class="bom-summary-value">${items.length}</div></div>
    <div class="bom-summary-item"><div class="bom-summary-label">Serialized</div><div class="bom-summary-value" style="color:var(--sap-blue)">${serialCount}</div></div>
    <div class="bom-summary-item"><div class="bom-summary-label">Bulk</div><div class="bom-summary-value" style="color:#A05000">${bulkCount}</div></div>
    <div class="bom-summary-item"><div class="bom-summary-label">On Order</div><div class="bom-summary-value" style="color:var(--sap-warning)">${onOrder}</div></div>
    <div class="bom-summary-item"><div class="bom-summary-label">Total BOM Cost</div><div class="bom-summary-value" style="color:var(--sap-success)">$${Number(totalCost).toLocaleString()}</div></div>`;

  document.getElementById('popupBomTree').innerHTML = items.length
    ? flattenTree(tree, 0)
    : `<div style="text-align:center;padding:40px;color:var(--sap-text-muted)"><i class="fas fa-sitemap" style="font-size:28px;opacity:0.3;display:block;margin-bottom:8px"></i>No BOM defined for this asset.<br><small>Click "Add Component" to start building the BOM.</small></div>`;
}

// ── Export BOM to Excel ───────────────────────────────────────
function exportBOM() {
  const assetFilter = document.getElementById('bomFilterAsset')?.value;
  const items = assetFilter ? BOM_ITEMS.filter(b => b.assetId === assetFilter) : BOM_ITEMS;

  const rows = items.map(b => {
    const asset = ASSETS.find(a => a.assetId === b.assetId);
    const depth = getBomDepth(b.id);
    const indent = '  '.repeat(depth);
    return {
      'Asset ID':       b.assetId,
      'Asset Name':     asset?.name || b.assetId,
      'Level':          depth,
      'Component Name': indent + b.name,
      'Part Number':    b.partNo || '',
      'Type':           b.type,
      'Serial Number':  b.serial || '',
      'Manufacturer':   b.manufacturer || '',
      'Quantity':       b.qty,
      'UOM':            b.uom,
      'Unit Cost (USD)': b.unitCost || 0,
      'Total Cost (USD)': (b.unitCost||0) * (b.qty||0),
      'Lead Time (days)': b.leadTime || 0,
      'Status':         b.status,
      'Notes':          b.notes || '',
    };
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  ws['!cols'] = [10,25,7,35,16,12,18,20,8,6,14,14,14,12,30].map(w=>({wch:w}));
  XLSX.utils.book_append_sheet(wb, ws, 'BOM');
  XLSX.writeFile(wb, `BOM_Export_${Date.now()}.xlsx`);
  showToast(`BOM exported (${rows.length} components).`, 'success');
}

function showToast(msg, type='info') {
  const icons = { success:'check-circle', warning:'exclamation-triangle', error:'times-circle', info:'info-circle' };
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `<i class="fas fa-${icons[type]}" style="color:${type==='success'?'var(--sap-success)':type==='warning'?'var(--sap-warning)':type==='error'?'var(--sap-error)':'var(--sap-blue)'}"></i><span>${msg}</span>`;
  document.getElementById('toastContainer').appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

// ══════════════════════════════════════════════════════════
//  TRANSFER MODULE
// ══════════════════════════════════════════════════════════

let TRANSFERS = [
  {
    id:'TR-001', assetId:'AST-001', assetName:'Top Drive System', currentLoc:'Ghawar Field', destination:'NABORS 1250-E – Permian Basin',
    destRig:'NABORS 1250-E', destCompany:'NABORS Industries', priority:'High', type:'Rig to Rig',
    requestedBy:'Sara Al-Rashid', requestDate:'2025-01-10', requiredDate:'2025-01-25',
    reason:'Top drive required for well P-44 spud at Permian Basin. Current rig shifting to standby.',
    instructions:'Handle with crane only. Do not tilt >15°.',
    status:'Ops Approved',
    opsApproval:{ by:'James Miller', role:'Operations Manager', date:'2025-01-11', action:'approve', comment:'Approved. Coordinate with logistics team for transport scheduling.' },
    mgrApproval:{ by:null, role:'Asset Manager', date:null, action:null, comment:null },
  },
  {
    id:'TR-002', assetId:'AST-003', assetName:'Mud Pumps (3x)', currentLoc:'Permian Basin', destination:'Workshop – Bay 4 (Overhaul)',
    destRig:null, destCompany:null, priority:'Critical', type:'For Maintenance',
    requestedBy:'Ahmad Mohammed', requestDate:'2025-01-08', requiredDate:'2025-01-12',
    reason:'Mud pumps require emergency overhaul. Liner wear detected on all 3 units. Continued operation poses blowout risk.',
    instructions:'Transport on flatbed. Keep units upright. Drain fluid before transport.',
    status:'Completed',
    opsApproval:{ by:'James Miller', role:'Operations Manager', date:'2025-01-08', action:'approve', comment:'Critical – approved immediately. Production shutdown authorized.' },
    mgrApproval:{ by:'Sara Al-Rashid', role:'Asset Manager', date:'2025-01-09', action:'approve', comment:'Approved. Schedule overhaul with maintenance team ASAP. Budget pre-approved.' },
  },
  {
    id:'TR-003', assetId:'AST-007', assetName:'H2S Detection System', currentLoc:'Permian Basin', destination:'Khafji Field – KJO Land Rig #3',
    destRig:'KJO Land Rig #3', destCompany:'Al-Khafji Joint Operations', priority:'Normal', type:'Field to Field',
    requestedBy:'David Chen', requestDate:'2025-01-15', requiredDate:'2025-01-30',
    reason:'H2S detection system requested by KJO site for new drilling area with known H2S presence.',
    instructions:'Calibrate before transport. Include all sensor heads and control unit.',
    status:'Pending',
    opsApproval:{ by:null, role:'Operations Manager', date:null, action:null, comment:null },
    mgrApproval:{ by:null, role:'Asset Manager', date:null, action:null, comment:null },
  },
];

let currentTransferId = null;
let currentApproverRole = null;

// ── OPEN TRANSFER MODAL ────────────────────────────────────
function openTransferModal(assetId) {
  // Close detail popup if open
  closeModal('assetDetailModal');

  // Populate selects
  const assetSel = document.getElementById('tr_asset');
  assetSel.innerHTML = '<option value="">— Select Asset —</option>' +
    ASSETS.map(a => `<option value="${a.assetId}">${a.name} (${a.assetId})</option>`).join('');

  const rigSel = document.getElementById('tr_destRig');
  rigSel.innerHTML = '<option value="">— None / Not Applicable —</option>' +
    RIGS.map(r => `<option value="${r.name}">${r.name}</option>`).join('');

  const compSel = document.getElementById('tr_destCompany');
  compSel.innerHTML = '<option value="">— Same / Not Applicable —</option>' +
    COMPANIES.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

  // Clear form
  ['tr_destination','tr_reason','tr_instructions'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('tr_priority').value = 'Normal';
  document.getElementById('tr_type').value = 'Field to Field';
  document.getElementById('tr_requiredDate').value = '';

  document.getElementById('transferModalTitle').textContent = 'Asset Transfer Request';

  if (assetId) {
    const a = ASSETS.find(x => x.assetId === assetId);
    if (a) {
      assetSel.value = assetId;
      document.getElementById('trAssetSelectorGroup').style.display = 'none';
      updateTransferBanner(a);
      document.getElementById('tr_currentLoc').value = a.location || '—';
    }
  } else {
    document.getElementById('trAssetSelectorGroup').style.display = '';
    resetTransferBanner();
    document.getElementById('tr_currentLoc').value = '';
  }

  openModal('transferRequestModal');
}

function onTransferAssetChange() {
  const assetId = document.getElementById('tr_asset').value;
  if (!assetId) { resetTransferBanner(); document.getElementById('tr_currentLoc').value = ''; return; }
  const a = ASSETS.find(x => x.assetId === assetId);
  if (a) {
    document.getElementById('tr_currentLoc').value = a.location || '—';
    updateTransferBanner(a);
  }
}

function updateTransferBanner(a) {
  document.getElementById('trBannerName').textContent = a.name;
  document.getElementById('trBannerSub').textContent = `${a.assetId} · ${a.category} · ${a.company || '—'} · ${a.location || '—'}`;
  document.getElementById('trBannerStatus').innerHTML = statusBadge(a.status);
}

function resetTransferBanner() {
  document.getElementById('trBannerName').textContent = 'Select an Asset';
  document.getElementById('trBannerSub').textContent = '—';
  document.getElementById('trBannerStatus').innerHTML = '';
}

// ── SUBMIT TRANSFER REQUEST ────────────────────────────────
function submitTransferRequest() {
  const assetId     = document.getElementById('tr_asset').value;
  const destination = document.getElementById('tr_destination').value.trim();
  const reason      = document.getElementById('tr_reason').value.trim();

  if (!assetId)      { showToast('Please select an asset.', 'error'); return; }
  if (!destination)  { showToast('Please enter a destination location.', 'error'); return; }
  if (!reason)       { showToast('Please provide a reason for the transfer.', 'error'); return; }

  const asset = ASSETS.find(x => x.assetId === assetId);

  const newTransfer = {
    id: 'TR-' + String(TRANSFERS.length + 1).padStart(3, '0'),
    assetId, assetName: asset ? asset.name : assetId,
    currentLoc: document.getElementById('tr_currentLoc').value,
    destination,
    destRig:     document.getElementById('tr_destRig').value     || null,
    destCompany: document.getElementById('tr_destCompany').value || null,
    priority:    document.getElementById('tr_priority').value,
    type:        document.getElementById('tr_type').value,
    requestedBy: document.getElementById('tr_requestedBy').value,
    requestDate: new Date().toISOString().slice(0,10),
    requiredDate: document.getElementById('tr_requiredDate').value || null,
    reason,
    instructions: document.getElementById('tr_instructions').value,
    status: 'Pending',
    opsApproval: { by:null, role:'Operations Manager', date:null, action:null, comment:null },
    mgrApproval: { by:null, role:'Asset Manager',      date:null, action:null, comment:null },
  };

  TRANSFERS.push(newTransfer);
  closeModal('transferRequestModal');
  renderTransfers();
  updateTransferKPIs();
  showSection('section-transfers');
  showToast(`Transfer request ${newTransfer.id} submitted successfully. Awaiting Operations Manager approval.`, 'success');

  // Add notification
  addNotification('info','exchange-alt', 'Transfer Request Submitted', `${newTransfer.assetName} → ${destination}`, 'Just now');
}

// ── RENDER TRANSFERS TABLE ─────────────────────────────────
function renderTransfers() {
  const q   = (document.getElementById('trSearch')?.value  || '').toLowerCase();
  const fS  = document.getElementById('trFilterStatus')?.value;
  const fP  = document.getElementById('trFilterPriority')?.value;

  const list = TRANSFERS.filter(t => {
    const mq = !q || t.id.toLowerCase().includes(q) || t.assetName.toLowerCase().includes(q) ||
                     t.currentLoc.toLowerCase().includes(q) || t.destination.toLowerCase().includes(q);
    return mq && (!fS || t.status === fS) && (!fP || t.priority === fP);
  }).sort((a,b) => b.id.localeCompare(a.id));

  document.getElementById('trCount').textContent = `(${list.length})`;

  const priorityClass = { Critical:'priority-critical', High:'priority-high', Normal:'priority-normal', Low:'priority-low' };

  document.getElementById('transferTbody').innerHTML = list.map(t => `
    <tr>
      <td><span class="tag blue" style="font-family:'IBM Plex Mono',monospace;font-size:11px">${t.id}</span></td>
      <td>
        <div style="font-weight:600;font-size:13px">${t.assetName}</div>
        <div style="font-size:11px;color:var(--sap-text-muted);font-family:'IBM Plex Mono',monospace">${t.assetId}</div>
      </td>
      <td>
        <div style="display:flex;align-items:center;gap:5px;font-size:12.5px">
          <i class="fas fa-map-marker-alt" style="color:var(--sap-text-muted);font-size:10px"></i>${t.currentLoc}
        </div>
      </td>
      <td>
        <div style="display:flex;align-items:center;gap:5px;font-size:12.5px;font-weight:500;color:var(--sap-blue)">
          <i class="fas fa-location-dot" style="font-size:10px"></i>${t.destination}
        </div>
      </td>
      <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:12px" title="${t.reason}">${t.reason}</td>
      <td><span class="${priorityClass[t.priority]||'priority-normal'}">${t.priority === 'Critical' ? '⚠ ' : ''}${t.priority}</span></td>
      <td style="font-size:12.5px">${t.requestedBy}</td>
      <td style="font-size:12px;color:var(--sap-text-muted)">${t.requestDate}</td>
      <td>${transferStatusBadge(t.status)}</td>
      <td>${approvalCell(t.opsApproval)}</td>
      <td>${approvalCell(t.mgrApproval)}</td>
      <td style="white-space:nowrap">
        <button class="btn btn-ghost btn-icon" title="View Details" onclick="openTransferDetail('${t.id}')"><i class="fas fa-eye"></i></button>
        ${t.status === 'Pending' ? `<button class="btn btn-ghost btn-icon" title="Ops Manager Review" style="color:#E65100" onclick="openApprovalModal('${t.id}','ops')"><i class="fas fa-hard-hat"></i></button>` : ''}
        ${t.status === 'Ops Approved' ? `<button class="btn btn-ghost btn-icon" title="Asset Manager Review" style="color:#6D28D9" onclick="openApprovalModal('${t.id}','mgr')"><i class="fas fa-user-tie"></i></button>` : ''}
        ${(t.status === 'Pending' || t.status === 'Ops Approved') ? `<button class="btn btn-ghost btn-icon" title="Cancel Request" style="color:var(--sap-error)" onclick="cancelTransfer('${t.id}')"><i class="fas fa-ban"></i></button>` : ''}
      </td>
    </tr>`).join('') || '<tr><td colspan="12" style="text-align:center;padding:40px;color:var(--sap-text-muted)"><i class="fas fa-exchange-alt" style="font-size:28px;opacity:.3;display:block;margin-bottom:8px"></i>No transfer requests found</td></tr>';

  updateTransferKPIs();
}

function approvalCell(appr) {
  if (!appr.action) return `<span style="font-size:11px;color:#bbb"><i class="fas fa-clock"></i> Awaiting</span>`;
  if (appr.action === 'approve') return `<div style="font-size:11.5px"><span style="color:var(--sap-success)"><i class="fas fa-check-circle"></i> ${appr.by}</span><div style="font-size:10px;color:var(--sap-text-muted)">${appr.date}</div></div>`;
  if (appr.action === 'reject')  return `<div style="font-size:11.5px"><span style="color:var(--sap-error)"><i class="fas fa-times-circle"></i> ${appr.by}</span><div style="font-size:10px;color:var(--sap-text-muted)">${appr.date}</div></div>`;
  if (appr.action === 'hold')    return `<span style="font-size:11px;color:var(--sap-warning)"><i class="fas fa-pause-circle"></i> On Hold</span>`;
  return '—';
}

function transferStatusBadge(s) {
  const map = {
    'Pending':      '<span class="tr-status-pending"><i class="fas fa-clock"></i> Pending</span>',
    'Ops Approved': '<span class="tr-status-ops"><i class="fas fa-hard-hat"></i> Ops Approved</span>',
    'Completed':    '<span class="tr-status-done"><i class="fas fa-check-double"></i> Completed</span>',
    'Rejected':     '<span class="tr-status-rejected"><i class="fas fa-times-circle"></i> Rejected</span>',
    'On Hold':      '<span class="tr-status-hold"><i class="fas fa-pause-circle"></i> On Hold</span>',
  };
  return map[s] || `<span class="tr-status-hold">${s}</span>`;
}

// ── KPIs ──────────────────────────────────────────────────
function updateTransferKPIs() {
  document.getElementById('trKpiTotal').textContent   = TRANSFERS.length;
  document.getElementById('trKpiPending').textContent = TRANSFERS.filter(t=>t.status==='Pending').length;
  document.getElementById('trKpiOps').textContent     = TRANSFERS.filter(t=>t.status==='Ops Approved').length;
  document.getElementById('trKpiDone').textContent    = TRANSFERS.filter(t=>t.status==='Completed').length;
  document.getElementById('trKpiRej').textContent     = TRANSFERS.filter(t=>t.status==='Rejected').length;
}

// ── OPEN APPROVAL MODAL ────────────────────────────────────
function openApprovalModal(transferId, role) {
  const t = TRANSFERS.find(x => x.id === transferId);
  if (!t) return;
  currentTransferId  = transferId;
  currentApproverRole = role;

  document.getElementById('approvalReqId').textContent = transferId;

  const roleLabel = role === 'ops' ? 'Operations Manager Review' : 'Asset Manager Final Approval';
  const roleIcon  = role === 'ops' ? 'fa-hard-hat' : 'fa-user-tie';
  const roleColor = role === 'ops' ? '#E65100' : '#6D28D9';

  document.getElementById('approvalModalTitle').innerHTML = `<i class="fas ${roleIcon}" style="color:${roleColor}"></i> ${roleLabel}`;
  document.getElementById('approvalActionTitle').innerHTML = `<i class="fas fa-gavel" style="color:${roleColor}"></i> Your Decision (${role === 'ops' ? 'Operations Manager' : 'Asset Manager'})`;

  // Summary grid
  document.getElementById('approvalSummaryGrid').innerHTML = [
    ['Asset', `<strong>${t.assetName}</strong> <span style="font-family:monospace;font-size:11px;color:var(--sap-text-muted)">${t.assetId}</span>`],
    ['Transfer Type', t.type],
    ['Current Location', `<i class="fas fa-map-marker-alt" style="color:var(--sap-text-muted)"></i> ${t.currentLoc}`],
    ['Destination', `<i class="fas fa-location-dot" style="color:var(--sap-blue)"></i> <strong>${t.destination}</strong>`],
    ['Priority', `<span class="${{Critical:'priority-critical',High:'priority-high',Normal:'priority-normal',Low:'priority-low'}[t.priority]}">${t.priority === 'Critical' ? '⚠ ' : ''}${t.priority}</span>`],
    ['Requested By', t.requestedBy],
    ['Request Date', t.requestDate],
    ['Required By', t.requiredDate || '—'],
    ['Reason', t.reason],
    ['Instructions', t.instructions || '—'],
  ].map(([l,v]) => `<div class="detail-field"><div class="detail-label">${l}</div><div class="detail-value">${v}</div></div>`).join('');

  // Timeline
  renderApprovalTimeline(t);

  // Clear comment
  document.getElementById('approvalComment').value = '';

  openModal('transferApprovalModal');
}

function renderApprovalTimeline(t) {
  const steps = [
    {
      label: 'Request Submitted',
      sub: `By ${t.requestedBy} on ${t.requestDate}`,
      icon: 'fa-paper-plane',
      state: 'done',
      comment: null,
    },
    {
      label: 'Operations Manager Review',
      sub: t.opsApproval.action ? `${t.opsApproval.by} — ${t.opsApproval.date}` : 'Awaiting Operations Manager',
      icon: t.opsApproval.action === 'approve' ? 'fa-check' : t.opsApproval.action === 'reject' ? 'fa-times' : 'fa-hard-hat',
      state: t.opsApproval.action === 'approve' ? 'done' : t.opsApproval.action === 'reject' ? 'reject' : (t.status === 'Pending' ? 'active' : 'pending'),
      comment: t.opsApproval.comment,
      actionLabel: t.opsApproval.action,
    },
    {
      label: 'Asset Manager Final Approval',
      sub: t.mgrApproval.action ? `${t.mgrApproval.by} — ${t.mgrApproval.date}` : 'Awaiting Asset Manager',
      icon: t.mgrApproval.action === 'approve' ? 'fa-check' : t.mgrApproval.action === 'reject' ? 'fa-times' : 'fa-user-tie',
      state: t.mgrApproval.action === 'approve' ? 'done' : t.mgrApproval.action === 'reject' ? 'reject' : (t.status === 'Ops Approved' ? 'active' : 'pending'),
      comment: t.mgrApproval.comment,
      actionLabel: t.mgrApproval.action,
    },
    {
      label: 'Transfer Executed',
      sub: t.status === 'Completed' ? 'Asset location updated' : 'Pending full approval',
      icon: 'fa-check-double',
      state: t.status === 'Completed' ? 'done' : 'pending',
      comment: null,
    },
  ];

  const actionLabel = { approve:'✓ Approved', reject:'✗ Rejected', hold:'⏸ On Hold' };

  document.getElementById('approvalTimeline').innerHTML = steps.map(s => `
    <div class="timeline-step">
      <div class="tl-dot ${s.state}"><i class="fas ${s.icon}"></i></div>
      <div style="flex:1">
        <div class="tl-label">${s.label}
          ${s.actionLabel ? `<span style="margin-left:8px;font-size:11px;font-weight:600;color:${s.actionLabel==='approve'?'var(--sap-success)':s.actionLabel==='reject'?'var(--sap-error)':'var(--sap-warning)'}">— ${actionLabel[s.actionLabel]||s.actionLabel}</span>` : ''}
        </div>
        <div class="tl-sub">${s.sub}</div>
        ${s.comment ? `<div class="tl-comment">"${s.comment}"</div>` : ''}
      </div>
    </div>`).join('');
}

// ── PROCESS APPROVAL DECISION ──────────────────────────────
function processApproval(decision) {
  const comment = document.getElementById('approvalComment').value.trim();
  if (!comment) { showToast('Please enter your decision comments before proceeding.', 'error'); return; }

  const t = TRANSFERS.find(x => x.id === currentTransferId);
  if (!t) return;

  const today = new Date().toISOString().slice(0,10);
  const approverName = USERS.find(u => u.role === (currentApproverRole === 'ops' ? 'Asset Manager' : 'Viewer'))?.name || 'Current User';

  if (currentApproverRole === 'ops') {
    t.opsApproval = { by: 'James Miller', role:'Operations Manager', date: today, action: decision, comment };
    if (decision === 'approve') {
      t.status = 'Ops Approved';
      showToast(`TR ${t.id}: Operations Manager approved. Now pending Asset Manager final approval.`, 'success');
      addNotification('info','user-tie', 'Awaiting Asset Manager', `Transfer ${t.id} for ${t.assetName} needs Asset Manager approval`, today);
    } else if (decision === 'reject') {
      t.status = 'Rejected';
      showToast(`TR ${t.id}: Rejected by Operations Manager.`, 'warning');
    } else {
      t.status = 'On Hold';
      showToast(`TR ${t.id}: Put on hold by Operations Manager.`, 'info');
    }
  } else {
    t.mgrApproval = { by: 'Sara Al-Rashid', role:'Asset Manager', date: today, action: decision, comment };
    if (decision === 'approve') {
      t.status = 'Completed';
      // Update the asset location in ASSETS
      const asset = ASSETS.find(a => a.assetId === t.assetId);
      if (asset) {
        asset.location = t.destination;
        if (t.destRig)     asset.rigName = t.destRig;
        if (t.destCompany) asset.company = t.destCompany;
      }
      applyFilters();
      showToast(`✓ Transfer ${t.id} FULLY APPROVED by Asset Manager. Asset location updated to "${t.destination}".`, 'success');
      addNotification('success','check-double', 'Transfer Completed', `${t.assetName} transferred to ${t.destination}`, today);
    } else if (decision === 'reject') {
      t.status = 'Rejected';
      showToast(`TR ${t.id}: Final approval rejected by Asset Manager.`, 'warning');
    } else {
      t.status = 'On Hold';
      showToast(`TR ${t.id}: Put on hold pending further review.`, 'info');
    }
  }

  closeModal('transferApprovalModal');
  renderTransfers();
}

// ── CANCEL TRANSFER ────────────────────────────────────────
function cancelTransfer(id) {
  if (!confirm(`Cancel transfer request ${id}? This action cannot be undone.`)) return;
  TRANSFERS = TRANSFERS.filter(t => t.id !== id);
  renderTransfers();
  showToast(`Transfer request ${id} cancelled.`, 'warning');
}

// ── VIEW TRANSFER DETAIL ───────────────────────────────────
function openTransferDetail(id) {
  const t = TRANSFERS.find(x => x.id === id);
  if (!t) return;
  const asset = ASSETS.find(a => a.assetId === t.assetId);

  document.getElementById('transferDetailBody').innerHTML = `
    <div style="background:linear-gradient(135deg,#354A5E,#4A6580);color:#fff;border-radius:6px;padding:16px;margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:48px;height:48px;background:rgba(255,255,255,.15);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0"><i class="fas fa-exchange-alt"></i></div>
        <div>
          <div style="font-weight:700;font-size:16px">${t.assetName}</div>
          <div style="font-size:12px;opacity:.75">${t.id} · ${t.type} · ${t.requestDate}</div>
        </div>
        <div style="margin-left:auto">${transferStatusBadge(t.status)}</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;border:1px solid var(--sap-border);border-radius:6px;overflow:hidden;margin-bottom:14px">
      ${[
        ['Request ID', t.id], ['Priority', t.priority], ['Transfer Type', t.type],
        ['Requested By', t.requestedBy], ['Request Date', t.requestDate], ['Required By', t.requiredDate||'—'],
        ['Current Location', t.currentLoc], ['Destination', t.destination],
        ['Dest. Rig', t.destRig||'—'], ['Dest. Company', t.destCompany||'—'],
      ].map(([l,v],i) => `
        <div style="padding:9px 12px;border-bottom:1px solid #ECEEF0;${i%2===0?'border-right:1px solid #ECEEF0':''}">
          <div style="font-size:11px;color:var(--sap-text-muted);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px">${l}</div>
          <div style="font-size:13px;font-weight:500">${v}</div>
        </div>`).join('')}
    </div>

    <div style="padding:12px;background:#F8F9FA;border:1px solid var(--sap-border);border-radius:6px;margin-bottom:14px">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--sap-text-muted);margin-bottom:6px">Reason for Transfer</div>
      <div style="font-size:13px;line-height:1.6">${t.reason}</div>
      ${t.instructions ? `<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--sap-text-muted);margin:10px 0 4px">Special Instructions</div><div style="font-size:13px;color:var(--sap-text-muted)">${t.instructions}</div>` : ''}
    </div>

    <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--sap-text-muted);margin-bottom:8px">Approval Status</div>
    <div style="border:1px solid var(--sap-border);border-radius:6px;overflow:hidden">
      <div style="display:grid;grid-template-columns:1fr 1fr">
        <div style="padding:12px;border-right:1px solid var(--sap-border)">
          <div style="font-size:11.5px;font-weight:600;color:#E65100;margin-bottom:8px"><i class="fas fa-hard-hat"></i> Operations Manager</div>
          ${t.opsApproval.action ?
            `<div style="font-size:13px;font-weight:600;color:${t.opsApproval.action==='approve'?'var(--sap-success)':'var(--sap-error)'}">${t.opsApproval.action==='approve'?'✓ Approved':'✗ Rejected'}</div>
             <div style="font-size:12px;color:var(--sap-text-muted);margin-top:2px">By ${t.opsApproval.by} on ${t.opsApproval.date}</div>
             <div style="font-size:12px;font-style:italic;margin-top:6px;color:var(--sap-text-muted)">"${t.opsApproval.comment}"</div>` :
            `<div style="font-size:13px;color:#ccc"><i class="fas fa-clock"></i> Awaiting Review</div>`}
        </div>
        <div style="padding:12px">
          <div style="font-size:11.5px;font-weight:600;color:#6D28D9;margin-bottom:8px"><i class="fas fa-user-tie"></i> Asset Manager</div>
          ${t.mgrApproval.action ?
            `<div style="font-size:13px;font-weight:600;color:${t.mgrApproval.action==='approve'?'var(--sap-success)':'var(--sap-error)'}">${t.mgrApproval.action==='approve'?'✓ Final Approved':'✗ Rejected'}</div>
             <div style="font-size:12px;color:var(--sap-text-muted);margin-top:2px">By ${t.mgrApproval.by} on ${t.mgrApproval.date}</div>
             <div style="font-size:12px;font-style:italic;margin-top:6px;color:var(--sap-text-muted)">"${t.mgrApproval.comment}"</div>` :
            `<div style="font-size:13px;color:#ccc"><i class="fas fa-clock"></i> Awaiting Review</div>`}
        </div>
      </div>
    </div>`;

  openModal('transferDetailModal');
}

// ── EXPORT TRANSFERS ───────────────────────────────────────
function exportTransfers() {
  const rows = TRANSFERS.map(t => ({
    'Request ID':      t.id,
    'Asset ID':        t.assetId,
    'Asset Name':      t.assetName,
    'Current Location': t.currentLoc,
    'Destination':     t.destination,
    'Dest. Rig':       t.destRig || '',
    'Dest. Company':   t.destCompany || '',
    'Priority':        t.priority,
    'Type':            t.type,
    'Requested By':    t.requestedBy,
    'Request Date':    t.requestDate,
    'Required By':     t.requiredDate || '',
    'Reason':          t.reason,
    'Status':          t.status,
    'Ops Manager':     t.opsApproval.by || '',
    'Ops Action':      t.opsApproval.action || '',
    'Ops Date':        t.opsApproval.date || '',
    'Ops Comment':     t.opsApproval.comment || '',
    'Asset Mgr':       t.mgrApproval.by || '',
    'Mgr Action':      t.mgrApproval.action || '',
    'Mgr Date':        t.mgrApproval.date || '',
    'Mgr Comment':     t.mgrApproval.comment || '',
  }));
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  ws['!cols'] = [10,10,25,20,20,18,20,10,16,18,12,12,40,14,16,10,12,30,16,10,12,30].map(w=>({wch:w}));
  XLSX.utils.book_append_sheet(wb, ws, 'Transfers');
  XLSX.writeFile(wb, `AssetTransfers_${Date.now()}.xlsx`);
  showToast(`Exported ${rows.length} transfer records.`, 'success');
}

// ── FILTER CLEAR ───────────────────────────────────────────
function clearTransferFilters() {
  document.getElementById('trSearch').value        = '';
  document.getElementById('trFilterStatus').value  = '';
  document.getElementById('trFilterPriority').value = '';
  renderTransfers();
}

// ── NOTIFICATION HELPER (patch into existing system) ───────
function addNotification(type, icon, title, desc, time) {
  NOTIFICATIONS.unshift({ icon:'fas fa-'+icon, type:'ni-'+(type==='success'?'green':type==='error'?'red':type==='warning'?'orange':'blue'), title, desc, time, read:false });
  const badge = document.getElementById('notifBadge');
  const unread = NOTIFICATIONS.filter(n=>!n.read).length;
  if (badge) { badge.textContent = unread; badge.style.display = unread ? 'flex' : 'none'; }
  renderNotifications?.();
}

// ── INIT TRANSFER MODULE (called after DOM ready) ──────────
function initTransfers() {
  renderTransfers();
  updateTransferKPIs();
}

// ── PATCH INTO EXISTING INIT ───────────────────────────────
const _origInit = window.onload;
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => initTransfers(), 50);
});


// ══════════════════════════════════════════════════════════════════
//  MAINTENANCE MODULE
// ══════════════════════════════════════════════════════════════════

let MAINT_SCHEDULES = [
  { id:'PM-001', assetId:'AST-001', task:'Top Drive Annual Inspection', type:'Inspection',        freq:365, lastDone:'2024-03-15', nextDue:'2025-03-15', tech:'Baker Hughes Team', hours:16, cost:8500,  priority:'Critical', status:'Scheduled',   alertDays:30, notes:'Full strip-down inspection per NOV manual ch.7. Check all seals, bearings, motor windings.', logs:[] },
  { id:'PM-002', assetId:'AST-001', task:'Gearbox Oil Change',          type:'Oil Change',         freq:90,  lastDone:'2024-11-01', nextDue:'2025-01-30', tech:'Mohammed Al-Farsi', hours:4,  cost:1200,  priority:'High',     status:'Overdue',     alertDays:14, notes:'Drain and replace ISO 320 gear oil. Check for metal particles.', logs:[] },
  { id:'PM-003', assetId:'AST-002', task:'BOP Pressure Test',           type:'Pressure Test',      freq:180, lastDone:'2024-07-10', nextDue:'2025-01-10', tech:'Bureau Veritas',   hours:8,  cost:4500,  priority:'Critical', status:'Overdue',     alertDays:30, notes:'15K psi pressure test per API 16A. Witnessed by third party inspector.', logs:[] },
  { id:'PM-004', assetId:'AST-002', task:'Ram Packer Inspection',       type:'Inspection',         freq:90,  lastDone:'2024-10-15', nextDue:'2025-01-13', tech:'Omar Hassan',      hours:6,  cost:2200,  priority:'High',     status:'Overdue',     alertDays:14, notes:'Inspect and replace worn ram packers. Check sealing surfaces.', logs:[] },
  { id:'PM-005', assetId:'AST-003', task:'Mud Pump Liner Inspection',   type:'Inspection',         freq:30,  lastDone:'2024-12-20', nextDue:'2025-01-19', tech:'Ahmed Khalid',     hours:3,  cost:800,   priority:'High',     status:'Due Soon',    alertDays:7,  notes:'Inspect liner wear. Replace if >15% worn. Check piston seals.', logs:[] },
  { id:'PM-006', assetId:'AST-003', task:'Valve & Seat Replacement',    type:'Filter Replacement', freq:60,  lastDone:'2024-11-25', nextDue:'2025-01-24', tech:'Ahmed Khalid',     hours:5,  cost:3200,  priority:'High',     status:'Due Soon',    alertDays:7,  notes:'Replace suction and discharge valves and seats. Check rod packing.', logs:[] },
  { id:'PM-007', assetId:'AST-004', task:'Derrick Structural Inspection',type:'Inspection',        freq:365, lastDone:'2024-02-01', nextDue:'2025-02-01', tech:'SGS Inspection',   hours:12, cost:6000,  priority:'Critical', status:'Scheduled',   alertDays:30, notes:'Full visual and NDT inspection of derrick. Check all gussets and welds per API 4F.', logs:[] },
  { id:'PM-008', assetId:'AST-005', task:'Generator Oil & Filter Change',type:'Oil Change',        freq:250, lastDone:'2024-10-01', nextDue:'2025-06-08', tech:'CAT Dealer Team',  hours:6,  cost:2800,  priority:'Normal',   status:'Scheduled',   alertDays:14, notes:'250-hour PM service. Oil, fuel filters, air filters, coolant check.', logs:[] },
  { id:'PM-009', assetId:'AST-005', task:'Generator Load Bank Test',    type:'Electrical Check',   freq:90,  lastDone:'2024-11-15', nextDue:'2025-02-13', tech:'Hamdan Ali',       hours:4,  cost:1500,  priority:'Normal',   status:'Scheduled',   alertDays:14, notes:'Full load bank test at 100% rated capacity for 4 hours.', logs:[] },
  { id:'PM-010', assetId:'AST-007', task:'H2S Sensor Calibration',      type:'Calibration',        freq:30,  lastDone:'2024-12-28', nextDue:'2025-01-27', tech:'Safety Officer',   hours:2,  cost:400,   priority:'Critical', status:'Due Soon',    alertDays:7,  notes:'Calibrate all H2S sensors with certified calibration gas. Replace sensors >2 years old.', logs:[] },
  { id:'PM-011', assetId:'AST-007', task:'SCBA Equipment Inspection',   type:'Safety Check',       freq:180, lastDone:'2024-07-01', nextDue:'2025-01-01', tech:'Safety Officer',   hours:3,  cost:600,   priority:'Critical', status:'Overdue',     alertDays:14, notes:'Inspect all 30 SCBA units. Check cylinder pressure, regulator function, face seal.', logs:[] },
  { id:'PM-012', assetId:'AST-008', task:'VSAT Antenna Alignment',      type:'General Service',    freq:180, lastDone:'2024-06-15', nextDue:'2024-12-15', tech:'Hughes Network Tech',hours:3, cost:1800,  priority:'Normal',   status:'Completed',   alertDays:14, notes:'Check and realign satellite dish. Clean feed horn. Test link quality.', logs:[{ date:'2024-12-14', by:'Hughes Tech', hours:2.5, cost:1700, parts:'None', notes:'Realigned dish 0.3° east. Signal improved from 74% to 91%.' }] },
  { id:'PM-013', assetId:'AST-009', task:'Jar Jar Tool Function Test',  type:'Inspection',         freq:90,  lastDone:'2024-10-20', nextDue:'2025-01-18', tech:'Fishing Tool Engr', hours:4, cost:2000,  priority:'High',     status:'Due Soon',    alertDays:7,  notes:'Function test hydraulic jars at rated load. Check hydraulic fluid and trigger mechanism.', logs:[] },
  { id:'PM-014', assetId:'AST-003', task:'Triplex Pump Packing Change', type:'General Service',    freq:45,  lastDone:'2024-11-10', nextDue:'2024-12-25', tech:'Ahmed Khalid',     hours:6,  cost:1800,  priority:'High',     status:'Completed',   alertDays:7,  notes:'Replace all piston packing sets on 3 pumps.', logs:[{ date:'2024-12-24', by:'Ahmed Khalid', hours:7, cost:2100, parts:'Garlock packing kits x18', notes:'All 3 pumps serviced. Found hairline crack on pump #2 liner — replaced.' }] },
];

let MAINT_LOG = [];   // separate completion log entries if needed
let editingMaintId = null;
let logTargetMaintId = null;

// ── Helpers ──────────────────────────────────────────────────
function today() { return new Date().toISOString().slice(0,10); }

function daysUntil(dateStr) {
  if (!dateStr) return null;
  const diff = Math.ceil((new Date(dateStr) - new Date(today())) / 86400000);
  return diff;
}

function getMaintStatus(m) {
  if (m.status === 'Completed' || m.status === 'Cancelled' || m.status === 'In Progress') return m.status;
  const d = daysUntil(m.nextDue);
  if (d === null) return 'Scheduled';
  if (d < 0)  return 'Overdue';
  if (d <= parseInt(m.alertDays || 14)) return 'Due Soon';
  return 'Scheduled';
}

// ── INIT ──────────────────────────────────────────────────────
function initMaintenance() {
  // Populate asset select in filter
  const sel = document.getElementById('mFilterAsset');
  if (sel) {
    sel.innerHTML = '<option value="">All Assets</option>' +
      ASSETS.map(a => `<option value="${a.assetId}">${a.name} (${a.assetId})</option>`).join('');
  }
  renderMaintenance();
  updateMaintKPIs();
  checkMaintAlerts();
}

// ── RENDER TABLE ──────────────────────────────────────────────
function renderMaintenance() {
  const q   = (document.getElementById('mSearch')?.value   || '').toLowerCase();
  const fS  = document.getElementById('mFilterStatus')?.value;
  const fT  = document.getElementById('mFilterType')?.value;
  const fA  = document.getElementById('mFilterAsset')?.value;
  const fP  = document.getElementById('mFilterPriority')?.value;
  const fR  = document.getElementById('mFilterRig')?.value || activeMaintRig;

  // Recompute live status for every record
  const list = MAINT_SCHEDULES.map(m => ({ ...m, _liveStatus: getMaintStatus(m) }))
    .filter(m => {
      const asset = ASSETS.find(a => a.assetId === m.assetId);
      const mq = !q || m.task.toLowerCase().includes(q) ||
                        m.assetId.toLowerCase().includes(q) ||
                        (asset?.name||'').toLowerCase().includes(q) ||
                        (m.tech||'').toLowerCase().includes(q);
      const ms  = !fS || m._liveStatus === fS;
      const mt  = !fT || m.type === fT;
      const ma  = !fA || m.assetId === fA;
      const mp  = !fP || m.priority === fP;
      const mr  = !fR || (asset && asset.rigName === fR);
      return mq && ms && mt && ma && mp && mr;
    })
    .sort((a,b) => {
      const order = { Overdue:0, 'Due Soon':1, 'In Progress':2, Scheduled:3, Completed:4, Cancelled:5 };
      return (order[a._liveStatus]??9) - (order[b._liveStatus]??9) ||
             new Date(a.nextDue) - new Date(b.nextDue);
    });

  document.getElementById('mCount').textContent = `(${list.length})`;

  const prioClass = { Critical:'priority-critical', High:'priority-high', Normal:'priority-normal', Low:'priority-low' };

  document.getElementById('maintTbody').innerHTML = list.map(m => {
    const asset   = ASSETS.find(a => a.assetId === m.assetId);
    const d       = daysUntil(m.nextDue);
    const liveS   = m._liveStatus;
    const daysCell = liveS === 'Completed' ? `<span class="days-done"><i class="fas fa-check"></i> Done</span>`
                   : liveS === 'Overdue'   ? `<span class="days-overdue"><i class="fas fa-exclamation-circle"></i> ${Math.abs(d)} days ago</span>`
                   : liveS === 'Due Soon'  ? `<span class="days-soon"><i class="fas fa-clock"></i> ${d} days</span>`
                   : d !== null            ? `<span class="days-ok">${d} days</span>` : '—';
    const rowBg   = liveS === 'Overdue' ? 'background:#FFF8F8' : liveS === 'Due Soon' ? 'background:#FFFBF5' : '';

    return `<tr style="${rowBg}">
      <td><span class="tag" style="font-family:'IBM Plex Mono',monospace;font-size:10.5px">${m.id}</span></td>
      <td>
        <div style="font-weight:600;font-size:13px">${asset ? asset.name : m.assetId}</div>
        <div style="font-size:10.5px;color:var(--sap-text-muted);font-family:'IBM Plex Mono',monospace">${m.assetId}</div>
      </td>
      <td>
        <div style="font-weight:600">${m.task}</div>
        ${m.notes ? `<div style="font-size:11px;color:var(--sap-text-muted);margin-top:2px;max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${m.notes}">${m.notes}</div>` : ''}
      </td>
      <td><span class="tag" style="font-size:11px">${m.type}</span></td>
      <td style="font-size:12px;white-space:nowrap">
        <i class="fas fa-rotate" style="color:var(--sap-text-muted);font-size:10px"></i>
        Every ${m.freq >= 365 ? 'Year' : m.freq >= 180 ? '6 mo' : m.freq >= 90 ? '90d' : m.freq >= 60 ? '60d' : m.freq >= 30 ? '30d' : m.freq >= 14 ? '14d' : '7d'}
      </td>
      <td style="font-size:12.5px;color:var(--sap-text-muted)">${m.lastDone || '—'}</td>
      <td style="font-size:12.5px;font-weight:${liveS==='Overdue'?'700':liveS==='Due Soon'?'600':'400'};color:${liveS==='Overdue'?'#B00':liveS==='Due Soon'?'#C65A00':'inherit'}">${m.nextDue || '—'}</td>
      <td>${daysCell}</td>
      <td><span class="${prioClass[m.priority]||'priority-normal'}" style="font-size:12px">${m.priority==='Critical'?'⚠ ':''}${m.priority}</span></td>
      <td style="font-size:12.5px">${m.tech || '—'}</td>
      <td style="font-size:12px;font-family:'IBM Plex Mono',monospace">${m.hours ? m.hours+'h' : '—'}</td>
      <td style="font-size:12px;font-family:'IBM Plex Mono',monospace">${m.cost ? '$'+Number(m.cost).toLocaleString() : '—'}</td>
      <td>${maintStatusBadge(liveS)}</td>
      <td style="white-space:nowrap">
        ${liveS !== 'Completed' && liveS !== 'Cancelled' ?
          `<button class="btn btn-ghost btn-icon" title="Mark Complete" style="color:var(--sap-success)" onclick="openMaintLogModal('${m.id}')"><i class="fas fa-check-circle"></i></button>` : ''}
        <button class="btn btn-ghost btn-icon" title="Edit" onclick="openMaintModal('${m.id}')"><i class="fas fa-edit"></i></button>
        ${m.logs && m.logs.length ? `<button class="btn btn-ghost btn-icon" title="History" style="color:#7C3AED" onclick="openMaintHistory('${m.id}')"><i class="fas fa-history"></i></button>` : ''}
        <button class="btn btn-ghost btn-icon" title="Delete" style="color:var(--sap-error)" onclick="deleteMaint('${m.id}')"><i class="fas fa-trash"></i></button>
      </td>
    </tr>`;
  }).join('') || '<tr><td colspan="14" style="text-align:center;padding:40px;color:var(--sap-text-muted)"><i class="fas fa-tools" style="font-size:30px;display:block;margin-bottom:8px;opacity:.3"></i>No maintenance schedules found</td></tr>';

  updateMaintKPIs();
  renderMaintQuickAlerts();
}

function maintStatusBadge(s) {
  const map = {
    'Overdue':     '<span class="m-overdue"><i class="fas fa-exclamation-circle"></i> Overdue</span>',
    'Due Soon':    '<span class="m-soon"><i class="fas fa-clock"></i> Due Soon</span>',
    'Scheduled':   '<span class="m-scheduled"><i class="fas fa-calendar"></i> Scheduled</span>',
    'Completed':   '<span class="m-completed"><i class="fas fa-check-circle"></i> Completed</span>',
    'In Progress': '<span class="m-inprog"><i class="fas fa-spinner"></i> In Progress</span>',
    'Cancelled':   '<span class="m-cancelled"><i class="fas fa-ban"></i> Cancelled</span>',
  };
  return map[s] || `<span class="m-scheduled">${s}</span>`;
}

// ── KPIs ──────────────────────────────────────────────────────
function updateMaintKPIs() {
  const live = MAINT_SCHEDULES.map(m => getMaintStatus(m));
  const overdue = live.filter(s=>s==='Overdue').length;
  const soon    = live.filter(s=>s==='Due Soon').length;
  const done    = live.filter(s=>s==='Completed').length;
  const sched   = live.filter(s=>s==='Scheduled').length;
  document.getElementById('mKpiTotal').textContent   = MAINT_SCHEDULES.length;
  document.getElementById('mKpiOverdue').textContent = overdue;
  document.getElementById('mKpiSoon').textContent    = soon;
  document.getElementById('mKpiDone').textContent    = done;
  document.getElementById('mKpiSched').textContent   = sched;

  // Nav badge
  const alertCount = overdue + soon;
  const badge = document.getElementById('maintAlertBadge');
  if (badge) { badge.textContent = alertCount; badge.style.display = alertCount ? 'inline' : 'none'; }
}

// ── QUICK ALERT ROWS below KPIs ───────────────────────────────
function renderMaintQuickAlerts() {
  const overdueTasks = MAINT_SCHEDULES.filter(m => getMaintStatus(m) === 'Overdue');
  const soonTasks    = MAINT_SCHEDULES.filter(m => getMaintStatus(m) === 'Due Soon');
  const container    = document.getElementById('maintQuickAlerts');
  if (!container) return;
  let html = '';

  overdueTasks.forEach(m => {
    const asset = ASSETS.find(a => a.assetId === m.assetId);
    const d = Math.abs(daysUntil(m.nextDue));
    html += `<div class="maint-alert-row maint-alert-overdue">
      <i class="fas fa-exclamation-circle" style="color:#B00;font-size:16px;flex-shrink:0"></i>
      <div style="flex:1">
        <strong>OVERDUE:</strong> ${m.task} — ${asset?.name || m.assetId}
        <span style="font-size:12px;color:#B00;font-weight:700;margin-left:6px">${d} day${d!==1?'s':''} past due</span>
      </div>
      <span style="font-size:11px;color:var(--sap-text-muted)">Due: ${m.nextDue}</span>
      <button class="btn btn-danger" style="height:26px;font-size:11px;margin-left:8px" onclick="openMaintLogModal('${m.id}')"><i class="fas fa-check"></i> Complete Now</button>
    </div>`;
  });

  soonTasks.forEach(m => {
    const asset = ASSETS.find(a => a.assetId === m.assetId);
    const d = daysUntil(m.nextDue);
    html += `<div class="maint-alert-row maint-alert-soon">
      <i class="fas fa-clock" style="color:#C65A00;font-size:16px;flex-shrink:0"></i>
      <div style="flex:1">
        <strong>Due Soon:</strong> ${m.task} — ${asset?.name || m.assetId}
        <span style="font-size:12px;color:#C65A00;font-weight:600;margin-left:6px">${d} day${d!==1?'s':''} remaining</span>
      </div>
      <span style="font-size:11px;color:var(--sap-text-muted)">Due: ${m.nextDue}</span>
      <button class="btn btn-warning" style="height:26px;font-size:11px;margin-left:8px;background:var(--sap-warning);color:#fff;border:none" onclick="openMaintLogModal('${m.id}')"><i class="fas fa-check"></i> Log</button>
    </div>`;
  });

  container.innerHTML = html;
}

// ── GLOBAL ALERT BANNER (shows in other tabs too) ─────────────
function checkMaintAlerts() {
  const overdue = MAINT_SCHEDULES.filter(m => getMaintStatus(m) === 'Overdue');
  const soon    = MAINT_SCHEDULES.filter(m => getMaintStatus(m) === 'Due Soon');
  const banner  = document.getElementById('maintAlertBanner');
  const total   = overdue.length + soon.length;

  if (total > 0 && banner) {
    banner.style.display = 'flex';
    document.getElementById('maintAlertBannerTitle').textContent =
      `⚠ Maintenance Alert: ${overdue.length} Overdue, ${soon.length} Due Soon`;
    document.getElementById('maintAlertBannerDesc').textContent =
      overdue.slice(0,2).map(m=>m.task).join(' · ') + (overdue.length > 2 ? ` + ${overdue.length-2} more overdue` : '');
  }

  // Push notifications for overdue items
  overdue.forEach(m => {
    const asset = ASSETS.find(a=>a.assetId===m.assetId);
    addNotification('error','exclamation-circle',
      'Maintenance OVERDUE',
      `${m.task} for ${asset?.name||m.assetId} — ${Math.abs(daysUntil(m.nextDue))} days past due`,
      'Now');
  });
  soon.forEach(m => {
    const asset = ASSETS.find(a=>a.assetId===m.assetId);
    addNotification('warning','clock',
      'Maintenance Due Soon',
      `${m.task} for ${asset?.name||m.assetId} — due in ${daysUntil(m.nextDue)} days`,
      'Now');
  });

  updateMaintKPIs();
}

// ── OPEN ADD/EDIT MODAL ───────────────────────────────────────
function openMaintModal(id) {
  editingMaintId = id || null;
  document.getElementById('maintModalTitle').textContent = id ? 'Edit Maintenance Schedule' : 'New Maintenance Schedule';

  // Populate asset select
  const asel = document.getElementById('m_asset');
  asel.innerHTML = '<option value="">— Select Asset —</option>' +
    ASSETS.map(a => `<option value="${a.assetId}">${a.name} (${a.assetId})</option>`).join('');

  // Reset custom freq group
  document.getElementById('m_customFreqGroup').style.display = 'none';

  if (id) {
    const m = MAINT_SCHEDULES.find(x=>x.id===id);
    if (!m) return;
    asel.value                                        = m.assetId;
    document.getElementById('m_task').value          = m.task;
    document.getElementById('m_type').value          = m.type;
    document.getElementById('m_priority').value      = m.priority;
    document.getElementById('m_lastDone').value      = m.lastDone || '';
    document.getElementById('m_nextDue').value       = m.nextDue  || '';
    document.getElementById('m_tech').value          = m.tech     || '';
    document.getElementById('m_hours').value         = m.hours    || '';
    document.getElementById('m_cost').value          = m.cost     || '';
    document.getElementById('m_status').value        = m.status;
    document.getElementById('m_notes').value         = m.notes    || '';
    // frequency
    const stdFreqs = ['7','14','30','60','90','180','365'];
    if (stdFreqs.includes(String(m.freq))) {
      document.getElementById('m_freq').value = String(m.freq);
    } else {
      document.getElementById('m_freq').value = 'custom';
      document.getElementById('m_customFreqGroup').style.display = '';
      document.getElementById('m_customFreq').value = m.freq;
    }
    const ad = document.querySelector(`input[name="m_alertDays"][value="${m.alertDays}"]`);
    if (ad) ad.checked = true;
  } else {
    ['m_task','m_lastDone','m_nextDue','m_tech','m_hours','m_cost','m_notes'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('m_type').value     = 'Inspection';
    document.getElementById('m_priority').value = 'Normal';
    document.getElementById('m_freq').value     = '30';
    document.getElementById('m_status').value   = 'Scheduled';
    // default nextDue = 30 days from today
    const nd = new Date(); nd.setDate(nd.getDate()+30);
    document.getElementById('m_nextDue').value  = nd.toISOString().slice(0,10);
  }
  updateDueDaysLabel();
  openModal('maintModal');
}

// freq select change
document.getElementById('m_freq').addEventListener('change', function() {
  document.getElementById('m_customFreqGroup').style.display = this.value==='custom' ? '' : 'none';
  calcNextDue();
});

function calcNextDue() {
  const lastDone = document.getElementById('m_lastDone').value;
  if (!lastDone) { updateDueDaysLabel(); return; }
  const freqVal = document.getElementById('m_freq').value;
  const freq    = freqVal === 'custom' ? parseInt(document.getElementById('m_customFreq').value)||0 : parseInt(freqVal)||30;
  const nd      = new Date(lastDone); nd.setDate(nd.getDate() + freq);
  document.getElementById('m_nextDue').value = nd.toISOString().slice(0,10);
  updateDueDaysLabel();
}

function onMaintAssetChange() {} // hook for future use

function updateDueDaysLabel() {
  const nd = document.getElementById('m_nextDue').value;
  const lbl = document.getElementById('m_dueDaysLabel');
  if (!nd || !lbl) return;
  const d = daysUntil(nd);
  if (d < 0)   { lbl.textContent = `${Math.abs(d)}d overdue`; lbl.style.color = '#B00'; }
  else if (d === 0) { lbl.textContent = 'Today'; lbl.style.color = '#B00'; }
  else if (d <= 14) { lbl.textContent = `in ${d}d`; lbl.style.color = '#C65A00'; }
  else              { lbl.textContent = `in ${d}d`; lbl.style.color = 'var(--sap-success)'; }
}
document.getElementById('m_nextDue').addEventListener('input', updateDueDaysLabel);

// ── SAVE SCHEDULE ─────────────────────────────────────────────
function saveMaint() {
  const assetId = document.getElementById('m_asset').value;
  const task    = document.getElementById('m_task').value.trim();
  const nextDue = document.getElementById('m_nextDue').value;
  if (!assetId || !task || !nextDue) { showToast('Asset, task name and next due date are required.', 'error'); return; }

  const freqVal = document.getElementById('m_freq').value;
  const freq    = freqVal === 'custom' ? parseInt(document.getElementById('m_customFreq').value)||30 : parseInt(freqVal)||30;
  const alertDays = parseInt(document.querySelector('input[name="m_alertDays"]:checked')?.value || '14');

  const data = {
    id:       editingMaintId || ('PM-' + String(MAINT_SCHEDULES.length + 1).padStart(3,'0')),
    assetId, task,
    type:     document.getElementById('m_type').value,
    priority: document.getElementById('m_priority').value,
    freq,
    lastDone: document.getElementById('m_lastDone').value || null,
    nextDue,
    tech:     document.getElementById('m_tech').value,
    hours:    parseFloat(document.getElementById('m_hours').value) || null,
    cost:     parseFloat(document.getElementById('m_cost').value)  || null,
    status:   document.getElementById('m_status').value,
    alertDays,
    notes:    document.getElementById('m_notes').value,
    logs:     editingMaintId ? (MAINT_SCHEDULES.find(m=>m.id===editingMaintId)?.logs || []) : [],
  };

  if (editingMaintId) {
    const idx = MAINT_SCHEDULES.findIndex(m=>m.id===editingMaintId);
    if (idx>=0) MAINT_SCHEDULES[idx] = data;
    showToast('Maintenance schedule updated.', 'success');
  } else {
    MAINT_SCHEDULES.push(data);
    showToast(`Schedule ${data.id} created.`, 'success');
  }
  closeModal('maintModal');
  renderMaintenance();
  updateMaintKPIs();
  checkMaintAlerts();
}

// ── OPEN LOG COMPLETION MODAL ─────────────────────────────────
function openMaintLogModal(maintId) {
  logTargetMaintId = maintId;
  const m = maintId ? MAINT_SCHEDULES.find(x=>x.id===maintId) : null;
  const asset = m ? ASSETS.find(a=>a.assetId===m.assetId) : null;

  document.getElementById('maintLogTitle').textContent = m ? `Complete: ${m.task}` : 'Log Maintenance Completion';
  document.getElementById('mlBannerTask').textContent  = m?.task || '—';
  document.getElementById('mlBannerAsset').textContent = asset ? `${asset.name} · ${m.assetId}` : '—';

  // Set defaults
  document.getElementById('ml_date').value  = today();
  document.getElementById('ml_by').value    = '';
  document.getElementById('ml_hours').value = m?.hours || '';
  document.getElementById('ml_cost').value  = m?.cost  || '';
  document.getElementById('ml_parts').value = '';
  document.getElementById('ml_notes').value = '';

  // Auto-calc next due
  if (m) {
    const nd = new Date(); nd.setDate(nd.getDate() + (m.freq || 30));
    document.getElementById('ml_nextDue').value = nd.toISOString().slice(0,10);
  } else {
    document.getElementById('ml_nextDue').value = '';
  }

  openModal('maintLogModal');
}

// ── SAVE LOG / MARK COMPLETE ──────────────────────────────────
function saveMaintLog() {
  const completionDate = document.getElementById('ml_date').value;
  const by             = document.getElementById('ml_by').value.trim();
  if (!completionDate || !by) { showToast('Completion date and technician name are required.', 'error'); return; }

  const logEntry = {
    date:  completionDate,
    by,
    hours: parseFloat(document.getElementById('ml_hours').value) || null,
    cost:  parseFloat(document.getElementById('ml_cost').value)  || null,
    parts: document.getElementById('ml_parts').value,
    notes: document.getElementById('ml_notes').value,
  };

  if (logTargetMaintId) {
    const idx = MAINT_SCHEDULES.findIndex(m=>m.id===logTargetMaintId);
    if (idx >= 0) {
      const m = MAINT_SCHEDULES[idx];
      if (!m.logs) m.logs = [];
      m.logs.unshift(logEntry);
      m.lastDone = completionDate;
      m.nextDue  = document.getElementById('ml_nextDue').value || m.nextDue;
      m.status   = 'Scheduled'; // reset to scheduled with new next due
      const asset = ASSETS.find(a=>a.assetId===m.assetId);
      showToast(`✓ ${m.task} marked complete. Next due: ${m.nextDue}`, 'success');
      addNotification('success','check-circle','Maintenance Completed', `${m.task} on ${asset?.name||m.assetId} completed by ${by}`, today());
    }
  }
  closeModal('maintLogModal');
  renderMaintenance();
  updateMaintKPIs();
  checkMaintAlerts();
}

// ── VIEW HISTORY ──────────────────────────────────────────────
function openMaintHistory(maintId) {
  const m     = MAINT_SCHEDULES.find(x=>x.id===maintId);
  const asset = m ? ASSETS.find(a=>a.assetId===m.assetId) : null;
  if (!m) return;
  document.getElementById('maintHistTitle').textContent = `History: ${m.task}`;

  const totalCost  = (m.logs||[]).reduce((s,l)=>s+(l.cost||0),0);
  const totalHours = (m.logs||[]).reduce((s,l)=>s+(l.hours||0),0);

  let html = `<div style="background:linear-gradient(135deg,#354A5E,#4A6580);color:#fff;padding:14px 18px;display:flex;align-items:center;gap:12px">
    <div style="font-weight:700;font-size:14px">${m.task}</div>
    <div style="flex:1"></div>
    <span style="font-size:12px;opacity:.8">${asset?.name||m.assetId}</span>
  </div>
  <div style="display:flex;gap:0;border-bottom:1px solid var(--sap-border)">
    <div style="flex:1;padding:12px 16px;text-align:center;border-right:1px solid var(--sap-border)">
      <div style="font-size:11px;color:var(--sap-text-muted);text-transform:uppercase;letter-spacing:.4px">Log Entries</div>
      <div style="font-size:20px;font-weight:700;margin-top:4px">${(m.logs||[]).length}</div>
    </div>
    <div style="flex:1;padding:12px 16px;text-align:center;border-right:1px solid var(--sap-border)">
      <div style="font-size:11px;color:var(--sap-text-muted);text-transform:uppercase;letter-spacing:.4px">Total Hours</div>
      <div style="font-size:20px;font-weight:700;margin-top:4px">${totalHours}h</div>
    </div>
    <div style="flex:1;padding:12px 16px;text-align:center">
      <div style="font-size:11px;color:var(--sap-text-muted);text-transform:uppercase;letter-spacing:.4px">Total Cost</div>
      <div style="font-size:20px;font-weight:700;margin-top:4px;color:var(--sap-success)">$${Number(totalCost).toLocaleString()}</div>
    </div>
  </div>`;

  if ((m.logs||[]).length === 0) {
    html += `<div style="text-align:center;padding:40px;color:var(--sap-text-muted)"><i class="fas fa-history" style="font-size:28px;opacity:.3;display:block;margin-bottom:8px"></i>No completion logs yet.</div>`;
  } else {
    html += (m.logs||[]).map((l,i) => `
      <div class="maint-log-card">
        <div class="maint-log-dot"><i class="fas fa-check"></i></div>
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <span style="font-weight:600;font-size:13px">${l.date}</span>
            <span style="font-size:12px;color:var(--sap-text-muted)">by ${l.by}</span>
            ${l.hours ? `<span class="tag">${l.hours}h</span>` : ''}
            ${l.cost  ? `<span class="tag" style="color:var(--sap-success)">$${Number(l.cost).toLocaleString()}</span>` : ''}
          </div>
          ${l.parts ? `<div style="font-size:12px;color:var(--sap-text-muted);margin-top:4px"><i class="fas fa-box"></i> Parts: ${l.parts}</div>` : ''}
          ${l.notes ? `<div style="font-size:12.5px;margin-top:6px;padding:8px 10px;background:#F8F9FA;border-radius:4px;border-left:3px solid var(--sap-border);line-height:1.5">${l.notes}</div>` : ''}
        </div>
      </div>`).join('');
  }

  document.getElementById('maintHistBody').innerHTML = html;
  openModal('maintHistoryModal');
}

// ── DELETE ────────────────────────────────────────────────────
function deleteMaint(id) {
  const m = MAINT_SCHEDULES.find(x=>x.id===id);
  if (!confirm(`Delete maintenance schedule "${m?.task}"?`)) return;
  MAINT_SCHEDULES = MAINT_SCHEDULES.filter(x=>x.id!==id);
  renderMaintenance();
  updateMaintKPIs();
  showToast('Schedule deleted.', 'warning');
}

// ── CLEAR FILTERS ─────────────────────────────────────────────
function clearMaintFilters() {
  ['mSearch','mFilterStatus','mFilterType','mFilterAsset','mFilterPriority','mFilterRig'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  activeMaintRig = '';
  renderMaintRigSelector();
  renderMaintenance();
}

// ── EXPORT ────────────────────────────────────────────────────
function exportMaintenance() {
  const rows = MAINT_SCHEDULES.map(m => {
    const asset = ASSETS.find(a=>a.assetId===m.assetId);
    const live  = getMaintStatus(m);
    const d     = daysUntil(m.nextDue);
    return {
      'Schedule ID':    m.id,
      'Asset ID':       m.assetId,
      'Asset Name':     asset?.name||'',
      'Task':           m.task,
      'Type':           m.type,
      'Frequency (days)': m.freq,
      'Last Performed': m.lastDone||'',
      'Next Due Date':  m.nextDue||'',
      'Days Until Due': d,
      'Priority':       m.priority,
      'Status':         live,
      'Technician':     m.tech||'',
      'Est. Hours':     m.hours||'',
      'Est. Cost (USD)':m.cost||'',
      'Alert Days':     m.alertDays,
      'Log Entries':    (m.logs||[]).length,
      'Notes':          m.notes||'',
    };
  });
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  ws['!cols'] = [11,10,28,35,18,14,14,14,12,10,12,20,10,14,10,10,40].map(w=>({wch:w}));
  XLSX.utils.book_append_sheet(wb, ws, 'Maintenance');
  XLSX.writeFile(wb, `Maintenance_Schedule_${Date.now()}.xlsx`);
  showToast(`Exported ${rows.length} maintenance schedules.`, 'success');
}

// ── PATCH INIT ────────────────────────────────────────────────
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => initMaintenance(), 100);
});


// ══════════════════════════════════════════════════════════════════
//  RIG SELECTOR MODULE  (shared by Assets & Maintenance tabs)
// ══════════════════════════════════════════════════════════════════

let activeAssetRig = '';   // '' = All Rigs
let activeMaintRig = '';

// ── ASSETS rig selector ─────────────────────────────────────
function renderAssetRigSelector() {
  const el = document.getElementById('assetRigSelector');
  if (!el) return;

  // Count assets & alerts per rig
  const rigMeta = {};
  RIGS.forEach(r => { rigMeta[r.name] = { assets:0, maint:0, overdue:0 }; });
  ASSETS.forEach(a => { if (rigMeta[a.rigName]) rigMeta[a.rigName].assets++; });
  MAINT_SCHEDULES.forEach(m => {
    const asset = ASSETS.find(a=>a.assetId===m.assetId);
    if (!asset) return;
    const s = getMaintStatus(m);
    if (rigMeta[asset.rigName]) {
      rigMeta[asset.rigName].maint++;
      if (s==='Overdue'||s==='Due Soon') rigMeta[asset.rigName].overdue++;
    }
  });

  let html = `<button class="rig-pill rig-pill-all ${activeAssetRig===''?'active':''}" onclick="selectAssetRig('')">
    <span class="rig-pill-name"><i class="fas fa-layer-group" style="font-size:11px"></i> All Rigs</span>
    <span class="rig-pill-count">${ASSETS.length} assets</span>
  </button>`;

  RIGS.forEach(r => {
    const meta  = rigMeta[r.name] || {assets:0,overdue:0};
    const isAct = activeAssetRig === r.name;
    const hasAlert = meta.overdue > 0;
    const statusColor = r.status==='Active'?'#107E3E':r.status==='Maintenance'?'#E9730C':'#6A6D70';
    html += `<button class="rig-pill ${isAct?'active':''} ${hasAlert&&!isAct?'has-alert':''}" onclick="selectAssetRig('${r.name}')">
      ${meta.overdue>0&&!isAct?`<span class="rig-alert-dot">${meta.overdue}</span>`:''}
      <span class="rig-pill-name">
        <span class="rig-status-dot" style="background:${statusColor}"></span>${r.name}
      </span>
      <span class="rig-pill-count">${meta.assets} asset${meta.assets!==1?'s':''}</span>
    </button>`;
  });

  el.innerHTML = html;
}

function selectAssetRig(rigName) {
  activeAssetRig = rigName;
  const fr = document.getElementById('filterRig');
  if (fr) fr.value = rigName;
  renderAssetRigSelector();
  applyFilters();
}

// ── MAINTENANCE rig selector ────────────────────────────────
function renderMaintRigSelector() {
  const el = document.getElementById('maintRigSelector');
  if (!el) return;

  const rigMeta = {};
  RIGS.forEach(r => { rigMeta[r.name] = { tasks:0, overdue:0, soon:0 }; });
  MAINT_SCHEDULES.forEach(m => {
    const asset = ASSETS.find(a=>a.assetId===m.assetId);
    if (!asset || !rigMeta[asset.rigName]) return;
    const s = getMaintStatus(m);
    rigMeta[asset.rigName].tasks++;
    if (s==='Overdue')  rigMeta[asset.rigName].overdue++;
    if (s==='Due Soon') rigMeta[asset.rigName].soon++;
  });

  const totalAlerts = MAINT_SCHEDULES.filter(m=>getMaintStatus(m)==='Overdue'||getMaintStatus(m)==='Due Soon').length;

  let html = `<button class="rig-pill rig-pill-all ${activeMaintRig===''?'active':''}" onclick="selectMaintRig('')">
    <span class="rig-pill-name"><i class="fas fa-layer-group" style="font-size:11px"></i> All Rigs</span>
    <span class="rig-pill-count">${MAINT_SCHEDULES.length} tasks${totalAlerts>0?' · '+totalAlerts+' ⚠':''}</span>
  </button>`;

  RIGS.forEach(r => {
    const meta   = rigMeta[r.name] || {tasks:0,overdue:0,soon:0};
    if (meta.tasks === 0) return; // hide rigs with no PM tasks
    const isAct  = activeMaintRig === r.name;
    const alerts = meta.overdue + meta.soon;
    const hasAlert = alerts > 0;
    const statusColor = r.status==='Active'?'#107E3E':r.status==='Maintenance'?'#E9730C':'#6A6D70';
    let countStr = `${meta.tasks} task${meta.tasks!==1?'s':''}`;
    if (meta.overdue>0) countStr += ` · ${meta.overdue} overdue`;
    else if (meta.soon>0) countStr += ` · ${meta.soon} soon`;
    html += `<button class="rig-pill ${isAct?'active':''} ${hasAlert&&!isAct?'has-alert':''}" onclick="selectMaintRig('${r.name}')">
      ${alerts>0&&!isAct?`<span class="rig-alert-dot">${alerts}</span>`:''}
      <span class="rig-pill-name">
        <span class="rig-status-dot" style="background:${statusColor}"></span>${r.name}
      </span>
      <span class="rig-pill-count">${countStr}</span>
    </button>`;
  });

  el.innerHTML = html;
}

function selectMaintRig(rigName) {
  activeMaintRig = rigName;
  const mr = document.getElementById('mFilterRig');
  if (mr) mr.value = rigName;
  renderMaintRigSelector();
  renderMaintenance();
}

// ── Patch init to call both selectors ──────────────────────
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    renderAssetRigSelector();
    renderMaintRigSelector();
  }, 150);
});

</script>
</body>
</html>
